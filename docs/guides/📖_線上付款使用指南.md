# 📖 線上付款使用指南

**日期**: 2024-12-21  
**狀態**: ✅ 已完成整合

---

## 🎯 付款流程概述

您的網站已經整合了 **綠界科技 ECPay** 金流服務，支援線上信用卡付款。以下是完整的付款流程說明。

---

## 💳 付款方式

### 目前支援的付款方式

1. **信用卡付款** ✅
   - VISA
   - MasterCard
   - JCB
   - 即時付款，訂單立即成立

---

## 🔄 完整付款流程

### 步驟 1: 選擇商品並加入購物車

1. 瀏覽商品頁面
2. 點擊「加入購物車」
3. 確認購物車內容

### 步驟 2: 前往結帳頁面

1. 點擊購物車圖示
2. 點擊「前往結帳」
3. 進入結帳頁面 (`checkout.html`)

### 步驟 3: 填寫訂單資訊

1. **收件人資訊**：
   - 姓名
   - 電話
   - Email

2. **配送方式**：
   - 新竹物流（NT$ 120）
   - 7-11 超商取貨（NT$ 60）
   - 全家超商取貨（NT$ 60）
   - 滿 NT$ 1000 免運費

3. **付款方式**：
   - 選擇「信用卡」（目前唯一選項）

### 步驟 4: 確認訂單並提交

1. 檢查訂單摘要（小計、運費、折扣、總計）
2. 點擊「確認訂單並付款」按鈕
3. 系統會：
   - 建立訂單到資料庫
   - 呼叫後端 API 建立 ECPay 付款表單
   - 自動跳轉到綠界支付頁面

### 步驟 5: 在綠界支付頁面付款

1. **自動跳轉**：
   - 系統會自動跳轉到綠界科技的支付頁面
   - 這是安全的第三方支付平台

2. **填寫付款資訊**：
   - 輸入信用卡號碼
   - 輸入有效期限
   - 輸入安全碼（CVV）
   - 輸入持卡人姓名

3. **確認付款**：
   - 檢查付款金額
   - 點擊「確認付款」

### 步驟 6: 付款結果

1. **付款成功**：
   - 自動跳轉到 `payment-return.html`
   - 顯示付款成功訊息
   - 可以查看訂單詳情

2. **付款失敗**：
   - 顯示錯誤訊息
   - 可以重新嘗試付款
   - 訂單已建立，但狀態為「待付款」

---

## 🔧 技術架構

### 前端流程

```
checkout.html
  ↓
submitOrder()
  ↓
CheckoutSystem.submitCheckoutOrder()
  ↓
ApiClient.createOrder()  // 建立訂單
  ↓
ApiClient.createPayment()  // 建立付款表單
  ↓
handleECPayPayment()  // 處理付款
  ↓
自動提交表單到綠界
  ↓
跳轉到綠界支付頁面
```

### 後端流程

```
POST /api/orders  // 建立訂單
  ↓
POST /api/ecpay/create-payment  // 建立付款表單
  ↓
生成 CheckMacValue（安全驗證碼）
  ↓
返回付款表單資料
  ↓
前端自動提交到綠界
```

### 綠界回調流程

```
用戶完成付款
  ↓
綠界 POST /api/ecpay/notify  // 付款結果通知
  ↓
驗證 CheckMacValue
  ↓
更新訂單狀態
  ↓
返回成功訊息給綠界
```

---

## 📝 程式碼位置

### 前端檔案

1. **`checkout.html`**：
   - 結帳頁面 UI
   - 訂單表單
   - 付款方式選擇

2. **`js/checkout-system.js`**：
   - `submitCheckoutOrder()` - 提交訂單
   - `handleECPayPayment()` - 處理綠界付款

3. **`js/api-client.js`**：
   - `createOrder()` - 建立訂單 API
   - `createPayment()` - 建立付款表單 API

4. **`payment-return.html`**：
   - 付款結果頁面
   - 顯示付款狀態

### 後端檔案

1. **`backend/routes/ecpay.js`**：
   - `/create-payment` - 建立付款表單
   - `/notify` - 付款結果通知
   - `/verify-checkmac` - 驗證檢查碼

2. **`backend/routes/orders.js`**：
   - `/orders` - 建立訂單

---

## ⚙️ 環境設定

### 後端環境變數

在 `backend/.env` 檔案中設定：

```env
# 綠界金流設定
ECPAY_MERCHANT_ID=您的商店代號
ECPAY_HASH_KEY=您的 HashKey
ECPAY_HASH_IV=您的 HashIV
ECPAY_ENV=production  # 或 stage（測試環境）
```

### 測試環境 vs 正式環境

- **測試環境** (`ECPAY_ENV=stage`)：
  - API URL: `https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5`
  - 使用測試卡號進行測試

- **正式環境** (`ECPAY_ENV=production`)：
  - API URL: `https://payment.ecpay.com.tw/Cashier/AioCheckOut/V5`
  - 真實付款

---

## 🧪 測試付款

### 測試環境測試卡號

綠界測試環境提供以下測試卡號：

1. **VISA 測試卡**：
   - 卡號：`4000-2211-1111-1111`
   - 有效期限：任何未來日期
   - 安全碼：任意 3 位數

2. **MasterCard 測試卡**：
   - 卡號：`5454-5454-5454-5454`
   - 有效期限：任何未來日期
   - 安全碼：任意 3 位數

### 測試步驟

1. 確保後端環境變數設定為測試環境
2. 啟動後端伺服器
3. 啟動前端伺服器
4. 建立測試訂單
5. 使用測試卡號進行付款
6. 確認付款結果

---

## ✅ 付款功能確認清單

### 前端功能

- [x] 結帳頁面顯示付款方式選項
- [x] 訂單提交功能
- [x] 自動跳轉到綠界支付頁面
- [x] 付款結果頁面
- [x] 錯誤處理

### 後端功能

- [x] 建立訂單 API
- [x] 建立付款表單 API
- [x] 付款結果通知處理
- [x] CheckMacValue 驗證
- [x] 訂單狀態更新

### 整合功能

- [x] 前後端 API 整合
- [x] 綠界金流整合
- [x] 付款流程完整
- [x] 錯誤處理機制

---

## ⚠️ 注意事項

### 安全性

1. **環境變數保護**：
   - 不要將 `.env` 檔案提交到 Git
   - 確保 HashKey 和 HashIV 保密

2. **HTTPS 要求**：
   - 正式環境必須使用 HTTPS
   - 綠界不支援 HTTP 回調

3. **CheckMacValue 驗證**：
   - 所有綠界回調都必須驗證 CheckMacValue
   - 防止偽造付款通知

### 付款流程

1. **訂單建立時機**：
   - 訂單在跳轉到綠界前就已建立
   - 如果付款失敗，訂單狀態為「待付款」

2. **付款超時**：
   - 綠界支付頁面有時間限制
   - 超時後需要重新建立付款

3. **付款結果**：
   - 付款成功後，綠界會回調 `/api/ecpay/notify`
   - 訂單狀態會自動更新為「已付款」

---

## 🔍 故障排除

### 問題 1: 無法跳轉到綠界支付頁面

**可能原因**：
- 後端 API 未啟動
- 環境變數未設定
- API 請求失敗

**解決方法**：
1. 檢查後端伺服器是否運行
2. 檢查瀏覽器控制台錯誤訊息
3. 檢查後端日誌

### 問題 2: 付款後訂單狀態未更新

**可能原因**：
- 綠界回調 URL 無法訪問
- CheckMacValue 驗證失敗
- 資料庫更新失敗

**解決方法**：
1. 確保後端可以接收 POST 請求
2. 檢查綠界後台的交易記錄
3. 檢查後端日誌

### 問題 3: 付款表單建立失敗

**可能原因**：
- 環境變數錯誤
- 訂單資料不完整
- API 請求格式錯誤

**解決方法**：
1. 檢查環境變數設定
2. 檢查訂單資料格式
3. 查看後端錯誤訊息

---

## 📞 支援資源

### 綠界科技

- **官方文件**：https://www.ecpay.com.tw/Service/API_Dwnld
- **技術支援**：https://www.ecpay.com.tw/Service/Support
- **測試環境**：https://payment-stage.ecpay.com.tw/

### 專案文件

- `✅_綠界支付整合完成.md` - 整合完成報告
- `backend/routes/ecpay.js` - ECPay 路由實作
- `js/checkout-system.js` - 前端付款處理

---

## 🚀 下一步

### 可選功能擴展

1. **更多付款方式**：
   - ATM 轉帳
   - 超商代碼繳費
   - 超商條碼繳費

2. **付款狀態查詢**：
   - 訂單詳情頁面顯示付款狀態
   - 付款記錄查詢

3. **退款功能**：
   - 整合綠界退款 API
   - 後台退款管理

---

**更新日期**: 2024-12-21  
**最後更新**: 2024-12-21



