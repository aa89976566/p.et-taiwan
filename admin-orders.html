<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單管理 - 匠寵後台管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(230, 57, 70, 0.1); border-left: 4px solid #E63946; }
        .sidebar-item.active { background: rgba(230, 57, 70, 0.15); border-left: 4px solid #E63946; font-weight: 600; }
        .table-row:hover { background: #F9FAFB; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
    </style>
    
    <!-- API Client -->
    <script src="js/api-client.js"></script>
    
    <!-- 引入數據管理系統（保留作為回退） -->
    <script src="js/data-store.js"></script>
    <script src="js/mock-data.js"></script>
    <script src="js/admin-orders.js"></script>
</head>
<body class="bg-gray-50">
    <!-- 頂部導航欄 -->
    <nav class="bg-white border border-gray-200 fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-400 rounded-xl flex items-center justify-center">
                        <i class="fas fa-paw text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">匠寵後台</h1>
                        <p class="text-xs text-gray-500">訂單管理</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button class="relative text-gray-600 hover:text-gray-800">
                    <i class="fas fa-bell text-xl"></i>
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">15</span>
                </button>
                <div class="flex items-center space-x-3 border-l pl-4">
                    <div class="hidden md:block text-right">
                        <p class="text-sm font-semibold text-gray-800" id="adminName">超級管理員</p>
                        <p class="text-xs text-gray-500" id="adminRole">Super Admin</p>
                    </div>
                    <button class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">A</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 側邊欄 -->
    <aside id="sidebar" class="sidebar fixed left-0 top-16 bottom-0 w-64 bg-white border border-gray-200 overflow-y-auto z-40">
    <div class="p-4">
        <nav class="space-y-2">
            <a href="admin-dashboard.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                <i class="fas fa-chart-line text-lg w-6"></i>
                <span>儀表板</span>
            </a>
            <div class="sidebar-section">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">用戶管理</p>
                <a href="admin-users.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-users text-lg w-6"></i>
                    <span>用戶列表</span>
                </a>
            </div>
            <div class="sidebar-section mt-4">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">商品管理</p>
                <a href="admin-products.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-box text-lg w-6"></i>
                    <span>產品列表</span>
                </a>
                <a href="admin-orders.html" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-shopping-cart text-lg w-6"></i>
                    <span>訂單管理</span>
                    <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">15</span>
                </a>
            </div>
            <div class="sidebar-section mt-4">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">物流管理</p>
                <a href="admin-shipping.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-shipping-fast text-lg w-6"></i>
                    <span>物流設定</span>
                </a>
                <a href="checkout.html" target="_blank" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-truck text-lg w-6"></i>
                    <span>測試結帳流程</span>
                </a>
            </div>
            <div class="sidebar-section mt-4">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">測驗系統</p>
                <a href="admin-quizzes.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-clipboard-list text-lg w-6"></i>
                    <span>測驗列表</span>
                </a>
                <a href="admin-quiz-stats.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-chart-pie text-lg w-6"></i>
                    <span>測驗統計</span>
                </a>
            </div>
            <div class="sidebar-section mt-4">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">訂閱服務</p>
                <a href="admin-subscription-management.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-sync-alt text-lg w-6"></i>
                    <span>訂閱管理</span>
                </a>
                <a href="admin-subscription-options.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-list-alt text-lg w-6"></i>
                    <span>訂閱選項</span>
                </a>
                <a href="admin-jar-program.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-recycle text-lg w-6"></i>
                    <span>換罐計畫</span>
                </a>
            </div>
            <div class="sidebar-section mt-4">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">數據分析</p>
                <a href="admin-analytics.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-chart-bar text-lg w-6"></i>
                    <span>營收報表</span>
                </a>
            </div>
            <div class="sidebar-section mt-4">
                <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">系統設定</p>
                <a href="admin-homepage.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-edit text-lg w-6"></i>
                    <span>首頁內容管理</span>
                </a>
                <a href="admin-website-settings.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-palette text-lg w-6"></i>
                    <span>網站佈局</span>
                </a>
                <a href="admin-payment.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-credit-card text-lg w-6"></i>
                    <span>金流設定</span>
                </a>
                <a href="admin-settings.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-cog text-lg w-6"></i>
                    <span>系統設定</span>
                </a>
                <a href="admin-login.html" onclick="logout()" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600">
                    <i class="fas fa-sign-out-alt text-lg w-6"></i>
                    <span>登出</span>
                </a>
            </div>
        </nav>
    </div>
</aside>

    <!-- 主內容區 -->
    <main class="ml-64 pt-16 p-8">
        <!-- 標題 -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">訂單管理</h2>
                    <p class="text-gray-600 mt-2">管理所有訂單，追蹤配送狀態</p>
                </div>
                <button onclick="openCouponModal()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition">
                    <i class="fas fa-ticket-alt mr-2"></i>優惠券管理
                </button>
            </div>
        </div>

        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- 今日訂單 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterTodayOrders()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">今日訂單</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">28</h3>
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-arrow-up"></i> +15.2%
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-shopping-cart text-2xl text-blue-500"></i>
                    </div>
                </div>
            </div>

            <!-- 待處理訂單 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterPendingOrders()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">待處理訂單</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">15</h3>
                        <p class="text-sm text-orange-600 mt-2">
                            <i class="fas fa-exclamation-circle"></i> 需處理
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-2xl text-orange-500"></i>
                    </div>
                </div>
            </div>

            <!-- 今日營收 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterTodayRevenue()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">今日營收</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">$48,520</h3>
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-arrow-up"></i> +12.5%
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-2xl text-green-500"></i>
                    </div>
                </div>
            </div>

            <!-- 本月營收 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterMonthlyRevenue()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">本月營收</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">$685,340</h3>
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-arrow-up"></i> +18.7%
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-line text-2xl text-purple-500"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜尋與篩選 -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- 搜尋框 -->
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">搜尋</label>
                    <input type="text" id="searchInput" placeholder="訂單編號、客戶姓名、電話..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>

                <!-- 付款狀態 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">付款狀態</label>
                    <select id="paymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">全部</option>
                        <option value="pending">待付款</option>
                        <option value="paid">已付款</option>
                        <option value="refunded">已退款</option>
                    </select>
                </div>

                <!-- 配送狀態 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">配送狀態</label>
                    <select id="deliveryStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">全部</option>
                        <option value="preparing">待出貨</option>
                        <option value="shipping">配送中</option>
                        <option value="arrived">已到店（超商）</option>
                        <option value="delivered">已送達/已取貨</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>

                <!-- 時間範圍 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">時間範圍</label>
                    <select id="dateRange" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">全部</option>
                        <option value="today">今天</option>
                        <option value="week">本週</option>
                        <option value="month">本月</option>
                    </select>
                </div>
            </div>

            <!-- 按鈕 -->
            <div class="flex justify-between items-center mt-4">
                <div class="flex space-x-3">
                    <button onclick="applyFilters()" class="px-6 py-2 bg-gradient-to-r from-red-500 to-orange-400 text-white rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-search mr-2"></i>套用篩選
                    </button>
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-undo mr-2"></i>重置
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button onclick="exportOrders()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                        <i class="fas fa-file-excel mr-2"></i>匯出訂單
                    </button>
                    <button onclick="batchPrint()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition text-sm">
                        <i class="fas fa-print mr-2"></i>批次列印
                    </button>
                </div>
            </div>
        </div>

        <!-- 訂單列表 -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">訂單列表</h3>
                <span class="text-sm text-gray-600">共 <span id="totalOrders">15</span> 筆訂單</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left">
                                <input type="checkbox" class="rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">訂單編號</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">訂單時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">客戶資訊</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">商品摘要</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">物流方式</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">訂單金額</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">付款狀態</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">配送狀態</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="divide-y divide-gray-200">
                        <!-- 訂單列表將由 JavaScript 動態生成 -->
                    </tbody>
                </table>
            </div>

            <!-- 分頁 -->
            <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    顯示 <span id="showingFrom">1</span> 到 <span id="showingTo">15</span>，共 <span id="totalCount">15</span> 筆
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                        <i class="fas fa-chevron-left mr-2"></i>上一頁
                    </button>
                    <button class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm">1</button>
                    <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">2</button>
                    <button onclick="nextPage()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                        下一頁<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 訂單詳情 Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-4">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-red-50 to-orange-50">
                <h3 class="text-xl font-bold text-gray-800">訂單詳情</h3>
                <button onclick="closeOrderDetail()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- 訂單基本資訊 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">訂單編號</p>
                        <p class="text-lg font-semibold text-gray-800" id="modalOrderId">#2024120001</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-1">訂單時間</p>
                        <input type="datetime-local" id="modalOrderDateInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm">
                        <p class="text-xs text-gray-500 mt-1" id="modalOrderDateDisplay">2024-12-20 10:30</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-1">訂單狀態</p>
                        <div id="modalOrderStatus"></div>
                        <select id="modalOrderStatusSelect" class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm">
                            <option value="pending">待確認</option>
                            <option value="confirmed">已確認</option>
                            <option value="processing">處理中</option>
                            <option value="shipped">已出貨</option>
                            <option value="delivered">已送達</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                </div>

                <!-- 客戶資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center justify-between">
                        <span>客戶資訊</span>
                        <button onclick="toggleEditMode('customer')" id="editCustomerBtn" class="text-xs px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-edit mr-1"></i>編輯
                        </button>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 rounded-lg" id="customerInfoDisplay">
                        <div>
                            <p class="text-sm text-gray-600">姓名</p>
                            <p class="font-medium" id="modalCustomerName">王小明</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">電話</p>
                            <p class="font-medium" id="modalCustomerPhone">0912-345-678</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-sm text-gray-600">Email</p>
                            <p class="font-medium" id="modalCustomerEmail">customer@example.com</p>
                        </div>
                    </div>
                    <div class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50" id="customerInfoEdit">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">姓名</p>
                            <input type="text" id="modalCustomerNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="客戶姓名">
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">電話</p>
                            <input type="tel" id="modalCustomerPhoneInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="聯絡電話">
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-sm text-gray-600 mb-1">Email</p>
                            <input type="email" id="modalCustomerEmailInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="電子郵件">
                        </div>
                    </div>
                </div>

                <!-- 收件資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center justify-between">
                        <span>收件資訊</span>
                        <button onclick="toggleEditMode('recipient')" id="editRecipientBtn" class="text-xs px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-edit mr-1"></i>編輯
                        </button>
                    </h4>
                    <div class="p-4 border border-gray-200 rounded-lg" id="recipientInfoDisplay">
                        <p class="text-sm text-gray-600">收件人</p>
                        <p class="font-medium mb-2" id="modalRecipientName">王小明</p>
                        <p class="text-sm text-gray-600">收件地址</p>
                        <p class="font-medium mb-2" id="modalRecipientAddress">台北市信義區信義路五段7號</p>
                        <p class="text-sm text-gray-600">聯絡電話</p>
                        <p class="font-medium" id="modalRecipientPhone">0912-345-678</p>
                    </div>
                    <div class="hidden p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3" id="recipientInfoEdit">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">收件人姓名</p>
                            <input type="text" id="modalRecipientNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="收件人姓名">
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">聯絡電話</p>
                            <input type="tel" id="modalRecipientPhoneInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="聯絡電話">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">縣市</p>
                                <input type="text" id="modalRecipientCityInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm" placeholder="縣市">
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">區</p>
                                <input type="text" id="modalRecipientDistrictInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm" placeholder="區">
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">郵遞區號</p>
                                <input type="text" id="modalRecipientZipInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm" placeholder="郵遞區號">
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">詳細地址</p>
                            <input type="text" id="modalRecipientAddressInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="街道地址">
                        </div>
                    </div>
                </div>

                <!-- 商品明細 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">商品明細</h4>
                    <table class="w-full border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">產品名稱</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">單價</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-600">數量</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">小計</th>
                            </tr>
                        </thead>
                        <tbody id="modalProductList" class="divide-y divide-gray-200">
                            <!-- 商品列表將由 JavaScript 動態生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 金額計算 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center justify-between">
                        <span>金額資訊</span>
                        <button onclick="toggleEditMode('amount')" id="editAmountBtn" class="text-xs px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-edit mr-1"></i>編輯
                        </button>
                    </h4>
                    <div class="p-4 bg-gray-50 rounded-lg" id="amountInfoDisplay">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">商品總計</span>
                            <span class="font-medium" id="modalSubtotal">NT$ 1,980</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">運費</span>
                            <span class="font-medium" id="modalShipping">NT$ 80</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">折扣</span>
                            <span class="font-medium text-red-600" id="modalDiscount">-NT$ 0</span>
                        </div>
                        <div class="flex justify-between py-3 border-t border-gray-300 mt-2">
                            <span class="text-lg font-semibold text-gray-800">應付金額</span>
                            <span class="text-lg font-bold text-red-600" id="modalTotal">NT$ 2,060</span>
                        </div>
                    </div>
                    <div class="hidden p-4 bg-gray-50 rounded-lg space-y-3" id="amountInfoEdit">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">商品總計</span>
                            <input type="number" id="modalSubtotalInput" step="0.01" class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-right" placeholder="0">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">運費</span>
                            <input type="number" id="modalShippingInput" step="0.01" class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-right" placeholder="0">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">折扣</span>
                            <input type="number" id="modalDiscountInput" step="0.01" class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-right" placeholder="0">
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-gray-300">
                            <span class="text-lg font-semibold text-gray-800">應付金額</span>
                            <input type="number" id="modalTotalInput" step="0.01" class="w-32 px-3 py-2 border-2 border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 text-right font-bold" placeholder="0" readonly>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>總金額會自動計算（商品總計 + 運費 - 折扣）
                        </div>
                    </div>
                </div>

                <!-- 支付管理 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">支付管理</h4>
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-2">付款狀態</p>
                                <select id="modalPaymentStatus" onchange="updatePaymentStatus()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="pending">待付款</option>
                                    <option value="paid">已付款</option>
                                    <option value="refunded">已退款</option>
                                </select>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2">付款方式</p>
                                <select id="modalPaymentMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="credit_card">信用卡</option>
                                    <option value="atm">ATM 轉帳</option>
                                    <option value="convenience_store">超商代碼</option>
                                    <option value="line_pay">LINE Pay</option>
                                    <option value="apple_pay">Apple Pay</option>
                                    <option value="cash_on_delivery">貨到付款</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">付款金額（實際收到金額）</p>
                            <input type="number" id="modalPaymentAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="輸入實際收到的付款金額">
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">交易編號/轉帳後五碼</p>
                            <input type="text" id="modalTransactionId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="輸入轉帳後五碼或交易編號">
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">付款備註</p>
                            <textarea id="modalPaymentNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 resize-none" placeholder="例如：用戶於 12/20 完成轉帳，已核對無誤"></textarea>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="savePaymentInfo()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                                <i class="fas fa-save mr-1"></i>儲存付款資訊
                            </button>
                            <button onclick="confirmPayment()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                                <i class="fas fa-check mr-1"></i>確認已付款
                            </button>
                            <button onclick="processRefund()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition text-sm">
                                <i class="fas fa-undo mr-1"></i>處理退款
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 物流資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">物流資訊</h4>
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-2">物流方式</p>
                                <select id="modalCourier" onchange="handleCourierChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="">請選擇物流方式</option>
                                    <optgroup label="宅配到府">
                                        <option value="黑貓宅急便">黑貓宅急便</option>
                                        <option value="新竹貨運">新竹貨運</option>
                                        <option value="嘉里大榮">嘉里大榮</option>
                                        <option value="宅配通">宅配通</option>
                                        <option value="順豐速運">順豐速運</option>
                                    </optgroup>
                                    <optgroup label="超商取貨">
                                        <option value="7-11 超商取貨">7-11 超商取貨</option>
                                        <option value="全家超商取貨">全家超商取貨</option>
                                        <option value="萊爾富超商取貨">萊爾富超商取貨</option>
                                        <option value="OK 超商取貨">OK 超商取貨</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2">配送狀態</p>
                                <select id="modalDeliveryStatus" onchange="updateDeliveryStatus()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="preparing">待出貨</option>
                                    <option value="shipping">配送中</option>
                                    <option value="arrived">已到店</option>
                                    <option value="delivered">已送達/已取貨</option>
                                    <option value="cancelled">已取消</option>
                                </select>
                            </div>
                        </div>

                        <!-- 宅配資訊 -->
                        <div id="homeDeliveryInfo">
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">配送地址</p>
                                <input type="text" id="modalDeliveryAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="完整配送地址">
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">物流追蹤號碼</p>
                                <input type="text" id="modalTrackingNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="輸入物流追蹤號碼">
                            </div>
                        </div>

                        <!-- 超商取貨資訊 -->
                        <div id="storePickupInfo" class="hidden">
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">取貨門市</p>
                                <div class="flex space-x-2">
                                    <input type="text" id="modalStoreName" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="門市名稱" readonly>
                                    <button type="button" onclick="selectStore()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm whitespace-nowrap">
                                        <i class="fas fa-map-marker-alt mr-1"></i>選擇門市
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">門市地址</p>
                                <input type="text" id="modalStoreAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">門市代碼</p>
                                <input type="text" id="modalStoreCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">取貨編號</p>
                                <input type="text" id="modalPickupCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="超商取貨編號">
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t">
                            <button onclick="updateShippingInfo()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-save mr-1"></i>更新物流資訊
                            </button>
                            <a href="#" onclick="trackShipping(); return false;" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>查詢物流進度
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 訂單備註 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">訂單備註</h4>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <textarea id="modalNotes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none" placeholder="輸入訂單備註（例：請在下午配送、客戶已加 LINE 聯繫等）"></textarea>
                        <button onclick="updateOrderNotes()" class="mt-3 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm">
                            <i class="fas fa-save mr-1"></i>儲存備註
                        </button>
                    </div>
                </div>

                <!-- 儲存所有變更按鈕 -->
                <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 -mx-6 -mb-6 rounded-b-xl">
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                            所有變更將同步到前台會員中心
                        </p>
                        <div class="flex space-x-3">
                            <button onclick="closeOrderDetail()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                取消
                            </button>
                            <button onclick="saveAllOrderChanges()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>儲存所有變更
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- LINE 客服資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">
                        <i class="fab fa-line text-green-500 mr-2"></i>LINE 客服聯繫
                    </h4>
                    <div class="p-4 border-2 border-green-200 rounded-lg bg-green-50">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <img src="https://www.genspark.ai/api/files/s/p1ymWhU0" alt="LINE QR Code" class="w-24 h-24 rounded-lg border-2 border-green-500">
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 mb-2">
                                    <i class="fas fa-info-circle text-green-600 mr-1"></i>
                                    <strong>客戶服務 LINE 官方帳號</strong>
                                </p>
                                <p class="text-xs text-gray-600 mb-3">
                                    引導客戶掃描 QR Code 或搜尋 LINE ID 加入官方帳號，提供即時客服支援。
                                </p>
                                <div class="flex items-center space-x-2">
                                    <button onclick="copyLineLink()" class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-xs">
                                        <i class="fas fa-copy mr-1"></i>複製 LINE 連結
                                    </button>
                                    <button onclick="sendLineReminder()" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-xs">
                                        <i class="fas fa-envelope mr-1"></i>發送 LINE 提醒
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button onclick="printOrder()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i class="fas fa-print mr-2"></i>列印訂單
                </button>
                <button onclick="markAsShipped()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-shipping-fast mr-2"></i>標記已出貨
                </button>
                <button onclick="markAsDelivered()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    <i class="fas fa-check mr-2"></i>標記已送達
                </button>
                <button onclick="cancelOrder()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-times mr-2"></i>取消訂單
                </button>
            </div>
        </div>
    </div>

    <!-- 門市選擇 Modal -->
    <div id="storeSelectionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden mx-4">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-green-50">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-store mr-2 text-blue-600"></i>選擇取貨門市
                </h3>
                <button onclick="closeStoreSelectionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- 搜尋區 -->
                <div class="mb-6">
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <input type="text" id="storeSearchInput" placeholder="搜尋門市名稱、地址或門市代碼..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button onclick="searchStores()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition whitespace-nowrap">
                            <i class="fas fa-search mr-2"></i>搜尋
                        </button>
                    </div>
                    <div class="mt-3 flex items-center space-x-4 text-sm">
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="711" checked class="mr-2">
                            <span>7-11</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="family" class="mr-2">
                            <span>全家</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="hilife" class="mr-2">
                            <span>萊爾富</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="ok" class="mr-2">
                            <span>OK</span>
                        </label>
                    </div>
                </div>

                <!-- 門市列表 -->
                <div class="max-h-96 overflow-y-auto space-y-3" id="storeList">
                    <!-- 門市項目將動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 優惠券管理 Modal -->
    <div id="couponModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-ticket-alt mr-2 text-purple-600"></i>優惠券管理</h3>
                <button onclick="closeCouponModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- 動作按鈕 -->
                <div class="flex items-center justify-between mb-6">
                    <div class="text-sm text-gray-600">
                        共 <span class="font-semibold text-gray-800" id="couponCount">8</span> 張優惠券
                    </div>
                    <button onclick="openAddCouponModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-plus mr-2"></i>新增優惠券
                    </button>
                </div>

                <!-- 優惠券列表 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="couponList">
                    <!-- 優惠券卡片將由 JavaScript 動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 新增優惠券 Modal -->
    <div id="addCouponModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">新增優惠券</h3>
                <button onclick="closeAddCouponModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="couponForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">優惠券名稱 *</label>
                        <input type="text" id="couponName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="例：新年優惠">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">優惠碼 *</label>
                        <input type="text" id="couponCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="例：NEWYEAR2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">折扣類型 *</label>
                        <select id="couponType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="toggleDiscountInput()">
                            <option value="percentage">百分比折扣</option>
                            <option value="fixed">固定金額</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">折扣值 *</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="couponValue" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="10" min="1">
                            <span id="couponUnit" class="text-gray-600 font-medium">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最低消費</label>
                        <input type="number" id="couponMinSpend" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大折扣額</label>
                        <input type="number" id="couponMaxDiscount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="無上限" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">使用次數限制</label>
                        <input type="number" id="couponLimit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="無限制" min="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">已使用次數</label>
                        <input type="number" id="couponUsed" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0" min="0" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期 *</label>
                        <input type="date" id="couponStartDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期 *</label>
                        <input type="date" id="couponEndDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">說明</label>
                    <textarea id="couponDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="優惠券說明..."></textarea>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeAddCouponModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg">
                        <i class="fas fa-save mr-2"></i>儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 檢查登入狀態
        const userData = localStorage.getItem('adminUser');
        if (!userData) {
            window.location.href = 'admin-login.html';
        } else {
            const user = JSON.parse(userData);
            document.getElementById('adminName').textContent = user.name;
            document.getElementById('adminRole').textContent = user.role;
        }

        // 測試訂單資料
        const orders = [
            { id: '#2024120015', date: '2024-12-21 14:30', customer: '王小明', phone: '0912-345-678', products: '雞肉脆片 x2', amount: 600, payment: 'paid', delivery: 'delivered', email: 'wang@example.com', address: '台北市信義區信義路五段7號', courier: '黑貓宅急便', tracking: '123456789', items: [{name: '雞肉脆片', price: 300, qty: 2, subtotal: 600}], subtotal: 600, shipping: 80, discount: 0, total: 680, notes: '無特別備註' },
            { id: '#2024120014', date: '2024-12-21 13:15', customer: '李美玲', phone: '0923-456-789', products: '地瓜餅乾 x1, 鮭魚小丸子 x1', amount: 560, payment: 'paid', delivery: 'shipping', email: 'li@example.com', address: '新北市板橋區中山路一段123號', courier: '新竹貨運', tracking: '987654321', items: [{name: '地瓜餅乾', price: 280, qty: 1, subtotal: 280}, {name: '鮭魚小丸子', price: 280, qty: 1, subtotal: 280}], subtotal: 560, shipping: 80, discount: 0, total: 640, notes: '請在下午配送' },
            { id: '#2024120013', date: '2024-12-21 11:45', customer: '張大華', phone: '0934-567-890', products: '壕大大雞排 x3', amount: 660, payment: 'pending', delivery: 'preparing', email: 'chang@example.com', address: '台中市西屯區台灣大道三段99號', courier: '黑貓宅急便', tracking: '', items: [{name: '壕大大雞排', price: 220, qty: 3, subtotal: 660}], subtotal: 660, shipping: 80, discount: 0, total: 740, notes: '無特別備註' },
            { id: '#2024120012', date: '2024-12-21 10:20', customer: '陳小芬', phone: '0945-678-901', products: '牛肉乾 x2, 地瓜餅乾 x2', amount: 1160, payment: 'paid', delivery: 'delivered', email: 'chen@example.com', address: '高雄市前鎮區中山三路88號', courier: '新竹貨運', tracking: '555666777', items: [{name: '牛肉乾', price: 300, qty: 2, subtotal: 600}, {name: '地瓜餅乾', price: 280, qty: 2, subtotal: 560}], subtotal: 1160, shipping: 100, discount: 0, total: 1260, notes: '請勿放在管理室' },
            { id: '#2024120011', date: '2024-12-21 09:30', customer: '林志明', phone: '0956-789-012', products: '嗅聞墊初級版 x1', amount: 399, payment: 'paid', delivery: 'shipping', email: 'lin@example.com', address: '台南市東區中華東路二段66號', courier: '黑貓宅急便', tracking: '333444555', items: [{name: '嗅聞墊初級版', price: 399, qty: 1, subtotal: 399}], subtotal: 399, shipping: 80, discount: 0, total: 479, notes: '無特別備註' },
            { id: '#2024120010', date: '2024-12-20 16:45', customer: '黃淑惠', phone: '0967-890-123', products: '推拉解謎板中級版 x1', amount: 699, payment: 'refunded', delivery: 'cancelled', email: 'huang@example.com', address: '桃園市中壢區中央西路100號', courier: '新竹貨運', tracking: '', items: [{name: '推拉解謎板中級版', price: 699, qty: 1, subtotal: 699}], subtotal: 699, shipping: 80, discount: 0, total: 779, notes: '客戶要求退款' },
            { id: '#2024120009', date: '2024-12-20 15:30', customer: '劉建國', phone: '0978-901-234', products: '雞肉脆片 x5', amount: 1500, payment: 'paid', delivery: 'delivered', email: 'liu@example.com', address: '新竹市東區光復路一段55號', courier: '黑貓宅急便', tracking: '777888999', items: [{name: '雞肉脆片', price: 300, qty: 5, subtotal: 1500}], subtotal: 1500, shipping: 100, discount: 100, total: 1500, notes: '老客戶，已折扣100元' },
            { id: '#2024120008', date: '2024-12-20 14:15', customer: '吳雅婷', phone: '0989-012-345', products: '營養主餐罐 x4', amount: 2396, payment: 'paid', delivery: 'delivered', email: 'wu@example.com', address: '基隆市仁愛區孝一路22號', courier: '新竹貨運', tracking: '111222333', items: [{name: '營養主餐罐', price: 599, qty: 4, subtotal: 2396}], subtotal: 2396, shipping: 100, discount: 0, total: 2496, notes: '訂閱會員' },
            { id: '#2024120007', date: '2024-12-20 12:00', customer: '蔡宗翰', phone: '0990-123-456', products: '記憶按鈕高級版 x1', amount: 899, payment: 'pending', delivery: 'preparing', email: 'tsai@example.com', address: '宜蘭市中山路三段200號', courier: '黑貓宅急便', tracking: '', items: [{name: '記憶按鈕高級版', price: 899, qty: 1, subtotal: 899}], subtotal: 899, shipping: 100, discount: 0, total: 999, notes: '無特別備註' },
            { id: '#2024120006', date: '2024-12-20 10:30', customer: '鄭雅芳', phone: '0901-234-567', products: '壕大大雞排 x2, 地瓜餅乾 x1', amount: 720, payment: 'paid', delivery: 'shipping', email: 'cheng@example.com', address: '花蓮市中正路150號', courier: '新竹貨運', tracking: '444555666', items: [{name: '壕大大雞排', price: 220, qty: 2, subtotal: 440}, {name: '地瓜餅乾', price: 280, qty: 1, subtotal: 280}], subtotal: 720, shipping: 100, discount: 0, total: 820, notes: '請在上午配送' },
            { id: '#2024120005', date: '2024-12-20 09:15', customer: '許家豪', phone: '0912-345-678', products: '牛肉乾 x3', amount: 900, payment: 'paid', delivery: 'delivered', email: 'hsu@example.com', address: '台東市中華路一段88號', courier: '黑貓宅急便', tracking: '999000111', items: [{name: '牛肉乾', price: 300, qty: 3, subtotal: 900}], subtotal: 900, shipping: 120, discount: 0, total: 1020, notes: '無特別備註' },
            { id: '#2024120004', date: '2024-12-19 17:45', customer: '楊文彬', phone: '0923-456-789', products: '鮭魚小丸子 x4', amount: 1120, payment: 'paid', delivery: 'delivered', email: 'yang@example.com', address: '屏東市自由路200號', courier: '新竹貨運', tracking: '222333444', items: [{name: '鮭魚小丸子', price: 280, qty: 4, subtotal: 1120}], subtotal: 1120, shipping: 120, discount: 0, total: 1240, notes: '無特別備註' },
            { id: '#2024120003', date: '2024-12-19 15:20', customer: '謝佩珊', phone: '0934-567-890', products: '雞肉脆片 x1, 壕大大雞排 x1', amount: 520, payment: 'pending', delivery: 'preparing', email: 'hsieh@example.com', address: '苗栗市中正路55號', courier: '黑貓宅急便', tracking: '', items: [{name: '雞肉脆片', price: 300, qty: 1, subtotal: 300}, {name: '壕大大雞排', price: 220, qty: 1, subtotal: 220}], subtotal: 520, shipping: 80, discount: 0, total: 600, notes: '無特別備註' },
            { id: '#2024120002', date: '2024-12-19 13:00', customer: '賴冠宇', phone: '0945-678-901', products: '嗅聞墊初級版 x2', amount: 798, payment: 'paid', delivery: 'shipping', email: 'lai@example.com', address: '彰化市中山路二段123號', courier: '新竹貨運', tracking: '666777888', items: [{name: '嗅聞墊初級版', price: 399, qty: 2, subtotal: 798}], subtotal: 798, shipping: 80, discount: 0, total: 878, notes: '無特別備註' },
            { id: '#2024120001', date: '2024-12-19 10:30', customer: '周怡君', phone: '0956-789-012', products: '營養主餐罐 x2', amount: 1198, payment: 'paid', delivery: 'delivered', email: 'chou@example.com', address: '嘉義市東區中山路300號', courier: '黑貓宅急便', tracking: '888999000', items: [{name: '營養主餐罐', price: 599, qty: 2, subtotal: 1198}], subtotal: 1198, shipping: 100, discount: 0, total: 1298, notes: '訂閱會員' },
        ];

        // 渲染訂單列表（從 API 載入）
        async function renderOrders(filteredOrders = null) {
            // 如果沒有提供過濾後的訂單，從 API 載入
            if (!filteredOrders) {
                try {
                    if (window.ApiClient) {
                        const response = await window.ApiClient.getAdminOrders({ limit: 1000 });
                        if (response.success && response.data && response.data.orders) {
                            filteredOrders = response.data.orders;
                        } else {
                            filteredOrders = orders; // 回退到測試數據
                        }
                    } else {
                        filteredOrders = orders; // 回退到測試數據
                    }
                } catch (error) {
                    console.error('載入訂單失敗:', error);
                    filteredOrders = orders; // 回退到測試數據
                }
            }
            
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;
            
            // 顯示載入中
            tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-4"></i><p>載入訂單中...</p></td></tr>';

            if (!filteredOrders || filteredOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-shopping-cart text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg">目前沒有訂單資料</p>
                        </td>
                    </tr>
                `;
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('totalCount').textContent = '0';
                return;
            }
            
            tbody.innerHTML = '';

            filteredOrders.forEach(order => {
                // 適配 API 資料結構
                const orderId = order.id || '';
                const orderDate = order.orderDate || order.createdAt || Date.now();
                const dateStr = new Date(orderDate).toLocaleString('zh-TW', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const customerName = order.receiverName || order.receiver?.name || '未知';
                const customerPhone = order.receiverPhone || order.receiver?.phone || '';
                const items = order.items || [];
                const products = items.length > 0 ? 
                    items.slice(0, 2).map(item => `${item.name} x${item.quantity || 1}`).join(', ') + (items.length > 2 ? '...' : '') :
                    '無商品';
                const total = order.total || 0;
                const paymentStatus = order.paymentStatus || order.payment || 'pending';
                const deliveryStatus = order.deliveryStatus || order.delivery || 'preparing';
                const shippingCourier = order.shippingCourier || order.courier || '';
                const trackingNumber = order.shippingCourier || order.tracking || '';
                const paymentBadge = getPaymentBadge(paymentStatus);
                const deliveryBadge = getDeliveryBadge(deliveryStatus);
                
                // 顯示物流方式（簡短版）
                let shippingLabel = shippingCourier || '未設定';
                if (shippingLabel.includes('黑貓')) shippingLabel = '🚚 黑貓';
                else if (shippingLabel.includes('新竹')) shippingLabel = '🚚 新竹';
                else if (shippingLabel.includes('嘉里')) shippingLabel = '🚚 嘉里';
                else if (shippingLabel.includes('宅配通')) shippingLabel = '🚚 宅配通';
                else if (shippingLabel.includes('順豐')) shippingLabel = '🚚 順豐';
                else if (shippingLabel.includes('7-11') || shippingLabel.includes('711')) shippingLabel = '🏪 7-11';
                else if (shippingLabel.includes('全家')) shippingLabel = '🏪 全家';
                else if (shippingLabel.includes('萊爾富')) shippingLabel = '🏪 萊爾富';
                else if (shippingLabel.includes('OK')) shippingLabel = '🏪 OK';

                const row = `
                    <tr class="table-row">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="rounded" value="${orderId}">
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-semibold text-blue-600 cursor-pointer hover:text-blue-800" onclick='viewOrderDetail("${orderId}")'>${orderId.substring(0, 12)}</span>
                        </td>
                        <td class="px-6 py-4 text-gray-700 text-sm">${dateStr}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-800">${customerName}</div>
                            <div class="text-sm text-gray-500">${customerPhone}</div>
                        </td>
                        <td class="px-6 py-4 text-gray-700 text-sm">${products}</td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-gray-600 mb-1">${shippingLabel}</div>
                            ${trackingNumber ? `<div class="text-xs text-blue-600"><i class="fas fa-hashtag"></i> ${trackingNumber.substring(0, 10)}</div>` : '<div class="text-xs text-gray-400">未設定</div>'}
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-semibold text-gray-800">NT$ ${total.toLocaleString()}</span>
                        </td>
                        <td class="px-6 py-4">${paymentBadge}</td>
                        <td class="px-6 py-4">${deliveryBadge}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick='viewOrderDetail("${orderId}")' class="text-blue-600 hover:text-blue-800" title="查看詳情">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="printOrder()" class="text-gray-600 hover:text-gray-800" title="列印">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (document.getElementById('totalOrders')) {
                document.getElementById('totalOrders').textContent = filteredOrders.length;
            }
            if (document.getElementById('totalCount')) {
                document.getElementById('totalCount').textContent = filteredOrders.length;
            }
        }

        // 付款狀態標籤
        function getPaymentBadge(status) {
            const badges = {
                'pending': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i> 待付款</span>',
                'paid': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i> 已付款</span>',
                'refunded': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><i class="fas fa-undo mr-1"></i> 已退款</span>'
            };
            return badges[status] || '';
        }

        // 配送狀態標籤
        function getDeliveryBadge(status) {
            const badges = {
                'preparing': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><i class="fas fa-box mr-1"></i> 待出貨</span>',
                'shipping': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800"><i class="fas fa-shipping-fast mr-1"></i> 配送中</span>',
                'arrived': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800"><i class="fas fa-store mr-1"></i> 已到店</span>',
                'delivered': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-double mr-1"></i> 已送達/已取貨</span>',
                'cancelled': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-times mr-1"></i> 已取消</span>'
            };
            return badges[status] || '';
        }

        // 當前查看的訂單
        let currentOrder = null;

        // 查看訂單詳情（適配 API 資料結構）
        async function viewOrderDetail(orderOrOrderId) {
            let order = null;
            
            // 如果是 ID，從 API 獲取
            if (typeof orderOrOrderId === 'string') {
                try {
                    if (window.ApiClient) {
                        const response = await window.ApiClient.getAdminOrders();
                        if (response.success && response.data.orders) {
                            order = response.data.orders.find(o => o.id === orderOrOrderId);
                        }
                    }
                    if (!order) {
                        // 回退到本地數據
                        order = orders.find(o => o.id === orderOrOrderId);
                    }
                } catch (error) {
                    console.error('載入訂單詳情失敗:', error);
                    // 回退到本地數據
                    order = orders.find(o => o.id === orderOrOrderId);
                }
            } else {
                order = orderOrOrderId;
            }
            
            if (!order) {
                alert('找不到該訂單');
                return;
            }
            
            currentOrder = order; // 保存當前訂單
            
            // 適配不同的資料結構
            const orderId = order.id || '';
            const orderDate = order.orderDate || order.createdAt || order.date || Date.now();
            const receiverName = order.receiverName || order.receiver?.name || order.customer || '';
            const receiverPhone = order.receiverPhone || order.receiver?.phone || order.phone || '';
            const receiverEmail = order.receiverEmail || order.receiver?.email || order.email || '';
            const shippingAddress = order.shippingAddress || order.address || '';
            const shippingCity = order.shippingCity || '';
            const shippingDistrict = order.shippingDistrict || '';
            const shippingZipCode = order.shippingZipCode || '';
            const fullAddress = `${shippingCity}${shippingDistrict}${shippingAddress}` || shippingAddress;
            
            // 設置基本資訊
            document.getElementById('modalOrderId').textContent = orderId;
            const dateObj = new Date(orderDate);
            const dateStr = dateObj.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
            document.getElementById('modalOrderDateInput').value = dateStr;
            document.getElementById('modalOrderDateDisplay').textContent = dateObj.toLocaleString('zh-TW');
            document.getElementById('modalOrderStatusSelect').value = order.status || 'pending';
            
            // 設置客戶資訊（顯示）
            document.getElementById('modalCustomerName').textContent = receiverName;
            document.getElementById('modalCustomerPhone').textContent = receiverPhone;
            document.getElementById('modalCustomerEmail').textContent = receiverEmail;
            
            // 設置客戶資訊（編輯）
            document.getElementById('modalCustomerNameInput').value = receiverName;
            document.getElementById('modalCustomerPhoneInput').value = receiverPhone;
            document.getElementById('modalCustomerEmailInput').value = receiverEmail;
            
            // 設置收件資訊（顯示）
            document.getElementById('modalRecipientName').textContent = receiverName;
            document.getElementById('modalRecipientAddress').textContent = fullAddress;
            document.getElementById('modalRecipientPhone').textContent = receiverPhone;
            
            // 設置收件資訊（編輯）
            document.getElementById('modalRecipientNameInput').value = receiverName;
            document.getElementById('modalRecipientPhoneInput').value = receiverPhone;
            document.getElementById('modalRecipientCityInput').value = shippingCity;
            document.getElementById('modalRecipientDistrictInput').value = shippingDistrict;
            document.getElementById('modalRecipientZipInput').value = shippingZipCode;
            document.getElementById('modalRecipientAddressInput').value = shippingAddress;
            
            // 物流資訊
            const shippingCourier = order.shippingCourier || order.courier || '';
            const shippingMethod = order.shippingMethod || order.shipping?.method || '';
            const deliveryStatus = order.deliveryStatus || order.delivery || 'preparing';
            
            document.getElementById('modalCourier').value = shippingCourier;
            document.getElementById('modalDeliveryStatus').value = deliveryStatus;
            
            // 根據物流方式顯示對應欄位
            const isStorePickup = shippingCourier.includes('超商取貨') || shippingMethod.includes('store');
            if (isStorePickup) {
                document.getElementById('homeDeliveryInfo').classList.add('hidden');
                document.getElementById('storePickupInfo').classList.remove('hidden');
                document.getElementById('modalStoreName').value = order.shippingStoreName || order.storeName || '';
                document.getElementById('modalStoreAddress').value = order.shippingStoreAddress || order.storeAddress || '';
                document.getElementById('modalStoreCode').value = order.shippingStoreId || order.storeCode || '';
                document.getElementById('modalPickupCode').value = order.shippingTrackingNumber || order.pickupCode || order.tracking || '';
            } else {
                document.getElementById('homeDeliveryInfo').classList.remove('hidden');
                document.getElementById('storePickupInfo').classList.add('hidden');
                document.getElementById('modalDeliveryAddress').value = fullAddress || shippingAddress;
                document.getElementById('modalTrackingNumber').value = order.shippingCourier || order.tracking || '';
            }
            
            // 備註
            document.getElementById('modalNotes').value = order.notes || '無特別備註';
            
            // 金額資訊（顯示）
            const subtotal = order.subtotal || 0;
            const shippingFee = order.shippingFee || order.shipping || 0;
            const discount = order.discount || 0;
            const total = order.total || (subtotal + shippingFee - discount);
            
            document.getElementById('modalSubtotal').textContent = `NT$ ${subtotal.toLocaleString()}`;
            document.getElementById('modalShipping').textContent = `NT$ ${shippingFee.toLocaleString()}`;
            document.getElementById('modalDiscount').textContent = discount > 0 ? `-NT$ ${discount.toLocaleString()}` : 'NT$ 0';
            document.getElementById('modalTotal').textContent = `NT$ ${total.toLocaleString()}`;
            
            // 金額資訊（編輯）
            document.getElementById('modalSubtotalInput').value = subtotal;
            document.getElementById('modalShippingInput').value = shippingFee;
            document.getElementById('modalDiscountInput').value = discount;
            document.getElementById('modalTotalInput').value = total;
            
            // 支付信息
            const paymentStatus = order.paymentStatus || order.payment || 'pending';
            const paymentMethod = order.paymentMethod || order.payment?.method || 'atm';
            document.getElementById('modalPaymentStatus').value = paymentStatus;
            document.getElementById('modalPaymentMethod').value = paymentMethod;
            document.getElementById('modalTransactionId').value = order.transactionId || '';
            document.getElementById('modalPaymentAmount').value = paymentStatus === 'paid' ? total : '';
            
            // 計算總金額（監聽輸入變化）
            ['modalSubtotalInput', 'modalShippingInput', 'modalDiscountInput'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculateTotal);
                }
            });

            // 狀態標籤
            const paymentBadge = getPaymentBadge(paymentStatus);
            const deliveryBadge = getDeliveryBadge(deliveryStatus);
            document.getElementById('modalOrderStatus').innerHTML = `${paymentBadge} ${deliveryBadge}`;

            // 商品列表
            const productList = document.getElementById('modalProductList');
            productList.innerHTML = '';
            const items = order.items || [];
            if (items.length === 0) {
                productList.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">無商品資訊</td></tr>';
            } else {
                items.forEach(item => {
                    const itemPrice = item.price || 0;
                    const itemQuantity = item.quantity || item.qty || 1;
                    const itemSubtotal = itemPrice * itemQuantity;
                    const row = `
                        <tr>
                            <td class="px-4 py-3 text-gray-800">${item.name || '商品'}</td>
                            <td class="px-4 py-3 text-right text-gray-700">NT$ ${itemPrice.toLocaleString()}</td>
                            <td class="px-4 py-3 text-center text-gray-700">${itemQuantity}</td>
                            <td class="px-4 py-3 text-right font-medium text-gray-800">NT$ ${itemSubtotal.toLocaleString()}</td>
                        </tr>
                    `;
                    productList.innerHTML += row;
                });
            }

            // 重置編輯模式
            resetEditModes();

            document.getElementById('orderDetailModal').classList.add('active');
        }

        // 計算總金額
        function calculateTotal() {
            const subtotal = parseFloat(document.getElementById('modalSubtotalInput').value) || 0;
            const shipping = parseFloat(document.getElementById('modalShippingInput').value) || 0;
            const discount = parseFloat(document.getElementById('modalDiscountInput').value) || 0;
            const total = subtotal + shipping - discount;
            document.getElementById('modalTotalInput').value = total.toFixed(2);
            
            // 更新顯示
            document.getElementById('modalSubtotal').textContent = `NT$ ${subtotal.toLocaleString()}`;
            document.getElementById('modalShipping').textContent = `NT$ ${shipping.toLocaleString()}`;
            document.getElementById('modalDiscount').textContent = discount > 0 ? `-NT$ ${discount.toLocaleString()}` : 'NT$ 0';
            document.getElementById('modalTotal').textContent = `NT$ ${total.toLocaleString()}`;
        }

        // 切換編輯模式
        function toggleEditMode(mode) {
            const displayEl = document.getElementById(`${mode}InfoDisplay`);
            const editEl = document.getElementById(`${mode}InfoEdit`);
            const btn = document.getElementById(`edit${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`);
            
            if (displayEl && editEl) {
                const isHidden = editEl.classList.contains('hidden');
                displayEl.classList.toggle('hidden', isHidden);
                editEl.classList.toggle('hidden', !isHidden);
                
                if (btn) {
                    btn.textContent = isHidden ? 
                        '<i class="fas fa-times mr-1"></i>取消' : 
                        '<i class="fas fa-edit mr-1"></i>編輯';
                    btn.classList.toggle('bg-red-500', isHidden);
                    btn.classList.toggle('bg-blue-500', !isHidden);
                }
            }
        }

        // 重置所有編輯模式
        function resetEditModes() {
            ['customer', 'recipient', 'amount'].forEach(mode => {
                const displayEl = document.getElementById(`${mode}InfoDisplay`);
                const editEl = document.getElementById(`${mode}InfoEdit`);
                const btn = document.getElementById(`edit${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`);
                
                if (displayEl && editEl) {
                    displayEl.classList.remove('hidden');
                    editEl.classList.add('hidden');
                }
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-edit mr-1"></i>編輯';
                    btn.classList.remove('bg-red-500');
                    btn.classList.add('bg-blue-500');
                }
            });
        }

        // 關閉訂單詳情
        function closeOrderDetail() {
            document.getElementById('orderDetailModal').classList.remove('active');
        }

        // 列印訂單
        function printOrder() {
            alert('訂單列印功能');
        }

        // 標記已出貨
        function markAsShipped() {
            if (currentOrder) {
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = 'shipping';
                    alert('✅ 訂單已標記為出貨中\n\n訂單編號: ' + currentOrder.id);
                    renderOrders();
                    closeOrderDetail();
                }
            }
        }

        // 標記已送達
        function markAsDelivered() {
            if (currentOrder) {
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = 'delivered';
                    alert('✅ 訂單已標記為已送達\n\n訂單編號: ' + currentOrder.id);
                    renderOrders();
                    closeOrderDetail();
                }
            }
        }

        // 取消訂單
        function cancelOrder() {
            if (currentOrder && confirm('確定要取消此訂單嗎？')) {
                // 更新訂單狀態
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = 'cancelled';
                    orders[orderIndex].payment = 'refunded';
                    
                    // 顯示成功訊息
                    alert('✅ 訂單已取消\n\n訂單編號: ' + currentOrder.id + '\n配送狀態: 已取消\n付款狀態: 已退款');
                    
                    // 重新渲染訂單列表
                    renderOrders();
                    
                    // 關閉 Modal
                    closeOrderDetail();
                }
            }
        }

        // 處理物流方式變更
        function handleCourierChange() {
            const courier = document.getElementById('modalCourier').value;
            const homeDelivery = document.getElementById('homeDeliveryInfo');
            const storePickup = document.getElementById('storePickupInfo');
            
            // 判斷是否為超商取貨
            const isStorePickup = courier.includes('超商取貨');
            
            if (isStorePickup) {
                homeDelivery.classList.add('hidden');
                storePickup.classList.remove('hidden');
            } else {
                homeDelivery.classList.remove('hidden');
                storePickup.classList.add('hidden');
            }
        }

        // 更新物流資訊
        async function updateShippingInfo() {
            if (!currentOrder) {
                alert('請先選擇訂單');
                return;
            }
            
            const courier = document.getElementById('modalCourier').value;
            const deliveryStatus = document.getElementById('modalDeliveryStatus').value;
            
            try {
                const updateData = {
                    shippingCourier: courier,
                    deliveryStatus: deliveryStatus
                };
                
                if (courier.includes('超商取貨')) {
                    updateData.shippingMethod = 'store_pickup';
                    updateData.shippingStoreName = document.getElementById('modalStoreName').value;
                    updateData.shippingStoreAddress = document.getElementById('modalStoreAddress').value;
                    updateData.shippingStoreId = document.getElementById('modalStoreCode').value;
                } else {
                    updateData.shippingMethod = 'home_delivery';
                    updateData.shippingAddress = document.getElementById('modalDeliveryAddress').value;
                }
                
                if (window.ApiClient) {
                    const response = await window.ApiClient.updateOrder(currentOrder.id, updateData);
                    if (response.success) {
                        showNotification('物流資訊已更新', 'success');
                        await viewOrderDetail(currentOrder.id);
                        await renderOrders();
                    } else {
                        throw new Error(response.message || '更新失敗');
                    }
                } else {
                    throw new Error('API 客戶端未載入');
                }
            } catch (error) {
                console.error('更新物流資訊失敗:', error);
                alert(`更新失敗：${error.message}`);
            }
        }

        // 更新配送狀態（僅更新顯示）
        function updateDeliveryStatus() {
            if (currentOrder) {
                const deliveryStatus = document.getElementById('modalDeliveryStatus').value;
                const paymentStatus = document.getElementById('modalPaymentStatus').value || currentOrder.paymentStatus || 'pending';
                
                // 更新顯示
                const paymentBadge = getPaymentBadge(paymentStatus);
                const deliveryBadge = getDeliveryBadge(deliveryStatus);
                document.getElementById('modalOrderStatus').innerHTML = `${paymentBadge} ${deliveryBadge}`;
            }
        }

        // 查詢物流進度
        function trackShipping() {
            if (currentOrder) {
                const courier = currentOrder.courier || '';
                const tracking = currentOrder.tracking || '';
                
                if (!tracking) {
                    alert('⚠️ 此訂單尚未設定追蹤/取貨編號');
                    return;
                }
                
                let message = `🚚 物流追蹤查詢\n\n訂單編號: ${currentOrder.id}\n物流方式: ${courier}\n`;
                
                if (courier.includes('超商取貨')) {
                    message += `取貨門市: ${currentOrder.storeName || '未設定'}\n取貨編號: ${tracking}\n\n實際應用中這裡會連接到超商物流 API 查詢取貨狀態。`;
                } else {
                    message += `追蹤號碼: ${tracking}\n\n實際應用中這裡會跳轉到物流公司的追蹤頁面。`;
                }
                
                alert(message);
            }
        }

        // 選擇門市
        function selectStore() {
            const courier = document.getElementById('modalCourier').value;
            if (!courier.includes('超商取貨')) {
                alert('⚠️ 請先選擇超商取貨物流方式');
                return;
            }
            openStoreSelectionModal();
        }

        // 打開門市選擇 Modal
        function openStoreSelectionModal() {
            document.getElementById('storeSelectionModal').classList.add('active');
            renderStoreList();
        }

        // 關閉門市選擇 Modal
        function closeStoreSelectionModal() {
            document.getElementById('storeSelectionModal').classList.remove('active');
        }

        // 模擬門市資料
        const mockStores = [
            { id: 1, type: '711', code: '001234', name: '信義威秀門市', address: '台北市信義區松壽路18號', tel: '02-2345-6789' },
            { id: 2, type: '711', code: '002345', name: '台北車站門市', address: '台北市中正區北平西路3號', tel: '02-2345-6790' },
            { id: 3, type: '711', code: '003456', name: '西門町門市', address: '台北市萬華區西寧南路50號', tel: '02-2345-6791' },
            { id: 4, type: '711', code: '004567', name: '南港門市', address: '台北市南港區南港路一段1號', tel: '02-2345-6792' },
            { id: 5, type: '711', code: '005678', name: '內湖門市', address: '台北市內湖區文湖街20號', tel: '02-2345-6793' },
            { id: 6, type: 'family', code: 'FML001', name: '中山旗艦店', address: '台北市中山區中山北路二段100號', tel: '02-2345-6794' },
            { id: 7, type: 'family', code: 'FML002', name: '大安店', address: '台北市大安區復興南路一段200號', tel: '02-2345-6795' },
            { id: 8, type: 'hilife', code: 'HL001', name: '萊爾富信義店', address: '台北市信義區信義路五段1號', tel: '02-2345-6796' }
        ];

        // 渲染門市列表
        function renderStoreList() {
            const storeType = document.querySelector('input[name="storeType"]:checked').value;
            const searchText = document.getElementById('storeSearchInput').value.toLowerCase();
            
            let filteredStores = mockStores.filter(s => s.type === storeType);
            
            if (searchText) {
                filteredStores = filteredStores.filter(s => 
                    s.name.toLowerCase().includes(searchText) ||
                    s.address.toLowerCase().includes(searchText) ||
                    s.code.toLowerCase().includes(searchText)
                );
            }
            
            const container = document.getElementById('storeList');
            
            if (filteredStores.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-store text-4xl mb-3"></i><p>查無門市資料</p></div>';
                return;
            }
            
            container.innerHTML = filteredStores.map(store => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:shadow-md transition cursor-pointer" onclick="chooseStore('${store.code}', '${store.name}', '${store.address}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded ${store.type === '711' ? 'bg-orange-100 text-orange-800' : store.type === 'family' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${store.type === '711' ? '7-11' : store.type === 'family' ? '全家' : '萊爾富'}
                                </span>
                                <span class="text-sm font-semibold text-gray-800">${store.name}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${store.address}</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-barcode text-gray-400 mr-2"></i>門市代碼: ${store.code}</p>
                        </div>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            選擇
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 選擇門市
        function chooseStore(code, name, address) {
            document.getElementById('modalStoreCode').value = code;
            document.getElementById('modalStoreName').value = name;
            document.getElementById('modalStoreAddress').value = address;
            closeStoreSelectionModal();
            alert(`✅ 已選擇門市\n\n門市名稱: ${name}\n門市地址: ${address}\n門市代碼: ${code}`);
        }

        // 搜尋門市
        function searchStores() {
            renderStoreList();
        }

        // 監聽超商類型變更
        document.addEventListener('DOMContentLoaded', function() {
            const storeTypeRadios = document.querySelectorAll('input[name="storeType"]');
            storeTypeRadios.forEach(radio => {
                radio.addEventListener('change', renderStoreList);
            });
        });

        // 處理退款
        async function processRefund() {
            if (!currentOrder) {
                alert('請先選擇訂單');
                return;
            }
            
            if (!confirm('確定要處理退款嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                const updateData = {
                    paymentStatus: 'refunded',
                    status: 'cancelled',
                    deliveryStatus: 'cancelled'
                };
                
                if (window.ApiClient) {
                    const response = await window.ApiClient.updateOrder(currentOrder.id, updateData);
                    if (response.success) {
                        showNotification('退款已處理', 'success');
                        await viewOrderDetail(currentOrder.id);
                        await renderOrders();
                        closeOrderDetail();
                    } else {
                        throw new Error(response.message || '處理失敗');
                    }
                } else {
                    throw new Error('API 客戶端未載入');
                }
            } catch (error) {
                console.error('處理退款失敗:', error);
                alert(`處理失敗：${error.message}`);
            }
        }

        // 取得付款方式名稱
        function getPaymentMethodName(method) {
            const methods = {
                'credit_card': '信用卡',
                'atm': 'ATM 轉帳',
                'convenience_store': '超商代碼',
                'line_pay': 'LINE Pay',
                'apple_pay': 'Apple Pay',
                'cash_on_delivery': '貨到付款'
            };
            return methods[method] || method;
        }

        // 套用篩選（異步版本，從 API 載入後篩選）
        async function applyFilters() {
            const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const paymentStatus = document.getElementById('paymentStatus')?.value || '';
            const deliveryStatus = document.getElementById('deliveryStatus')?.value || '';

            // 先從 API 載入所有訂單
            let allOrders = [];
            try {
                if (window.ApiClient) {
                    const response = await window.ApiClient.getAdminOrders({ limit: 1000 });
                    if (response.success && response.data && response.data.orders) {
                        allOrders = response.data.orders;
                    }
                }
            } catch (error) {
                console.error('載入訂單失敗:', error);
                allOrders = orders; // 回退到測試數據
            }

            // 客戶端篩選
            const filtered = allOrders.filter(order => {
                const orderId = (order.id || '').toLowerCase();
                const receiverName = (order.receiverName || order.receiver?.name || '').toLowerCase();
                const receiverPhone = (order.receiverPhone || order.receiver?.phone || '');
                
                const matchSearch = !search || 
                    orderId.includes(search) ||
                    receiverName.includes(search) ||
                    receiverPhone.includes(search);
                
                const orderPaymentStatus = order.paymentStatus || order.payment || 'pending';
                const orderDeliveryStatus = order.deliveryStatus || order.delivery || 'preparing';
                
                const matchPayment = !paymentStatus || orderPaymentStatus === paymentStatus;
                const matchDelivery = !deliveryStatus || orderDeliveryStatus === deliveryStatus;

                return matchSearch && matchPayment && matchDelivery;
            });

            await renderOrders(filtered);
        }

        // 重置篩選
        async function resetFilters() {
            if (document.getElementById('searchInput')) document.getElementById('searchInput').value = '';
            if (document.getElementById('paymentStatus')) document.getElementById('paymentStatus').value = '';
            if (document.getElementById('deliveryStatus')) document.getElementById('deliveryStatus').value = '';
            if (document.getElementById('dateRange')) document.getElementById('dateRange').value = '';
            await renderOrders();
        }

        // 統計卡片點擊功能
        function filterTodayOrders() {
            const today = new Date().toISOString().split('T')[0];
            alert('📅 今日訂單詳情\n\n共 28 筆訂單\n較昨日增加 15.2%\n\n• 已完成: 18 筆\n• 配送中: 7 筆\n• 待出貨: 3 筆\n\n已篩選今日訂單');
            // 實際篩選今日訂單
            const todayOrders = orders.filter(o => o.date.startsWith(today));
            renderOrders(todayOrders.length > 0 ? todayOrders : orders.slice(0, 5));
        }

        function filterPendingOrders() {
            document.getElementById('deliveryStatus').value = 'preparing';
            applyFilters();
            alert('待處理訂單\n\n共 15 筆待出貨訂單\n\n請盡快處理以提升客戶滿意度\n\n已篩選待處理訂單');
        }

        function filterTodayRevenue() {
            alert('💰 今日營收詳情\n\n總額: NT$ 48,520\n較昨日增加 12.5%\n\n• 產品銷售: NT$ 42,300\n• 運費收入: NT$ 3,120\n• 其他收入: NT$ 3,100\n\n點擊前往營收報表查看詳細分析');
            // 可選：跳轉到營收報表
            // window.location.href = 'admin-analytics.html';
        }

        function filterMonthlyRevenue() {
            alert('📊 本月營收詳情\n\n總額: NT$ 685,340\n較上月增加 18.7%\n\n• 產品銷售: NT$ 598,450\n• 訂閱服務: NT$ 56,890\n• 運費收入: NT$ 30,000\n\n成長趨勢持續向上！');
        }

        // 更新訂單備註
        async function updateOrderNotes() {
            if (!currentOrder) {
                alert('請先選擇訂單');
                return;
            }
            
            const notes = document.getElementById('modalNotes').value.trim();
            
            try {
                const updateData = {
                    notes: notes || ''
                };
                
                if (window.ApiClient) {
                    const response = await window.ApiClient.updateOrder(currentOrder.id, updateData);
                    if (response.success) {
                        showNotification('備註已更新', 'success');
                        currentOrder.notes = notes;
                        // 重新載入訂單列表
                        await renderOrders();
                    } else {
                        throw new Error(response.message || '更新失敗');
                    }
                } else {
                    throw new Error('API 客戶端未載入');
                }
            } catch (error) {
                console.error('更新備註失敗:', error);
                alert(`更新失敗：${error.message}`);
            }
        }

        // 儲存所有訂單變更
        async function saveAllOrderChanges() {
            if (!currentOrder) {
                alert('請先選擇訂單');
                return;
            }
            
            if (!confirm('確定要儲存所有變更嗎？變更將同步到前台會員中心。')) {
                return;
            }
            
            try {
                // 收集所有變更
                const updateData = {};
                
                // 訂單日期
                const orderDateInput = document.getElementById('modalOrderDateInput');
                if (orderDateInput && orderDateInput.value) {
                    const dateValue = new Date(orderDateInput.value).getTime();
                    updateData.orderDate = dateValue;
                }
                
                // 訂單狀態
                const orderStatus = document.getElementById('modalOrderStatusSelect').value;
                if (orderStatus) {
                    updateData.status = orderStatus;
                }
                
                // 客戶資訊（如果編輯模式打開）
                const customerEditEl = document.getElementById('customerInfoEdit');
                if (customerEditEl && !customerEditEl.classList.contains('hidden')) {
                    updateData.receiverName = document.getElementById('modalCustomerNameInput').value;
                    updateData.receiverPhone = document.getElementById('modalCustomerPhoneInput').value;
                    updateData.receiverEmail = document.getElementById('modalCustomerEmailInput').value;
                }
                
                // 收件資訊（如果編輯模式打開）
                const recipientEditEl = document.getElementById('recipientInfoEdit');
                if (recipientEditEl && !recipientEditEl.classList.contains('hidden')) {
                    updateData.receiverName = document.getElementById('modalRecipientNameInput').value || updateData.receiverName;
                    updateData.receiverPhone = document.getElementById('modalRecipientPhoneInput').value || updateData.receiverPhone;
                    updateData.shippingCity = document.getElementById('modalRecipientCityInput').value;
                    updateData.shippingDistrict = document.getElementById('modalRecipientDistrictInput').value;
                    updateData.shippingZipCode = document.getElementById('modalRecipientZipInput').value;
                    updateData.shippingAddress = document.getElementById('modalRecipientAddressInput').value;
                }
                
                // 金額資訊（如果編輯模式打開）
                const amountEditEl = document.getElementById('amountInfoEdit');
                if (amountEditEl && !amountEditEl.classList.contains('hidden')) {
                    updateData.subtotal = parseFloat(document.getElementById('modalSubtotalInput').value) || 0;
                    updateData.shippingFee = parseFloat(document.getElementById('modalShippingInput').value) || 0;
                    updateData.discount = parseFloat(document.getElementById('modalDiscountInput').value) || 0;
                    updateData.total = parseFloat(document.getElementById('modalTotalInput').value) || 0;
                }
                
                // 付款資訊
                updateData.paymentStatus = document.getElementById('modalPaymentStatus').value;
                updateData.paymentMethod = document.getElementById('modalPaymentMethod').value;
                
                // 配送狀態
                updateData.deliveryStatus = document.getElementById('modalDeliveryStatus').value;
                
                // 物流資訊
                const courier = document.getElementById('modalCourier').value;
                if (courier) {
                    updateData.shippingCourier = courier;
                    
                    if (courier.includes('超商取貨')) {
                        updateData.shippingMethod = 'store_pickup';
                        updateData.shippingStoreName = document.getElementById('modalStoreName').value;
                        updateData.shippingStoreAddress = document.getElementById('modalStoreAddress').value;
                        updateData.shippingStoreId = document.getElementById('modalStoreCode').value;
                    } else {
                        updateData.shippingMethod = 'home_delivery';
                        const address = document.getElementById('modalDeliveryAddress').value;
                        if (address) {
                            // 解析地址（簡單處理）
                            updateData.shippingAddress = address;
                        }
                        updateData.shippingCourier = document.getElementById('modalTrackingNumber').value || courier;
                    }
                }
                
                // 備註
                const notes = document.getElementById('modalNotes').value.trim();
                if (notes) {
                    updateData.notes = notes;
                }
                
                // 交易編號（儲存在備註中，或可以擴展後端欄位）
                const transactionId = document.getElementById('modalTransactionId').value;
                if (transactionId) {
                    updateData.notes = (updateData.notes || currentOrder.notes || '') + `\n[轉帳資訊] 後五碼: ${transactionId}`;
                }
                
                // 發送更新請求
                if (window.ApiClient) {
                    const response = await window.ApiClient.updateOrder(currentOrder.id, updateData);
                    if (response.success) {
                        showNotification('所有變更已儲存並同步到前台', 'success');
                        // 重新載入訂單詳情
                        await viewOrderDetail(currentOrder.id);
                        // 重新載入訂單列表
                        await renderOrders();
                        // 重置編輯模式
                        resetEditModes();
                    } else {
                        throw new Error(response.message || '儲存失敗');
                    }
                } else {
                    throw new Error('API 客戶端未載入');
                }
            } catch (error) {
                console.error('儲存變更失敗:', error);
                alert(`儲存失敗：${error.message}\n\n請確認後端伺服器已啟動在 http://localhost:3000`);
            }
        }

        // 顯示通知
        function showNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${colors[type]} transform transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} text-xl"></i>
                    <span class="font-semibold">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 複製 LINE 連結
        function copyLineLink() {
            const lineUrl = 'https://line.me/R/ti/p/@902rkfzv'; // LINE 官方帳號連結
            
            // 創建臨時輸入框複製連結
            const tempInput = document.createElement('input');
            tempInput.value = lineUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            alert(`✅ LINE 連結已複製到剪貼簿\n\n${lineUrl}\n\n可以直接傳送給客戶！`);
        }

        // 發送 LINE 提醒給客戶
        function sendLineReminder() {
            if (currentOrder) {
                const customerName = currentOrder.customer;
                const customerPhone = currentOrder.phone;
                const customerEmail = currentOrder.email;
                
                alert(`📧 發送 LINE 加好友提醒\n\n收件人: ${customerName}\n電話: ${customerPhone}\nEmail: ${customerEmail}\n\n簡訊內容範例：\n【匠寵】感謝您的訂單！\n請加入我們的 LINE 官方帳號獲得即時客服支援：\nhttps://line.me/R/ti/p/@902rkfzv\nLINE ID: @902rkfzv\n\n或掃描 QR Code 加入\n訂單編號: ${currentOrder.id}\n\n實際應用中會透過簡訊 API 或 Email 發送此提醒。`);
            }
        }

        // 匯出訂單
        function exportOrders() {
            alert('📊 訂單匯出功能\n\n實際應用中會匯出為 Excel 或 CSV 格式，包含以下資訊：\n\n• 訂單編號\n• 訂單時間\n• 客戶資訊\n• 商品明細\n• 付款狀態\n• 配送狀態\n• 物流資訊\n• 追蹤號碼\n• 訂單備註');
        }

        // 批次列印
        function batchPrint() {
            const checkedBoxes = document.querySelectorAll('tbody input[type="checkbox"]:checked');
            if (checkedBoxes.length === 0) {
                alert('⚠️ 請先選擇要列印的訂單');
                return;
            }
            alert(`📄 批次列印功能\n\n已選擇 ${checkedBoxes.length} 筆訂單\n\n實際應用中會批次列印：\n• 出貨單\n• 物流標籤\n• 發票/收據`);
        }

        // 分頁功能
        function previousPage() {
            alert('上一頁功能');
        }

        function nextPage() {
            alert('下一頁功能');
        }

        // 登出
        function logout() {
            localStorage.removeItem('adminUser');
        }

        // 優惠券管理
        let coupons = [];

        async function loadCoupons() {
            try {
                if (window.ApiClient) {
                    const response = await window.ApiClient.getCoupons();
                    if (response.success && response.data) {
                        coupons = response.data.map(coupon => ({
                            ...coupon,
                            startDate: coupon.startDate ? new Date(coupon.startDate).toISOString().split('T')[0] : '',
                            endDate: coupon.endDate ? new Date(coupon.endDate).toISOString().split('T')[0] : '',
                            limit: coupon.limitCount,
                            used: coupon.usedCount
                        }));
                        renderCoupons();
                    }
                } else {
                    console.warn('API 客戶端未載入，使用空列表');
                    coupons = [];
                    renderCoupons();
                }
            } catch (error) {
                console.error('載入優惠券失敗:', error);
                alert('載入優惠券失敗: ' + error.message);
            }
        }

        function openCouponModal() {
            loadCoupons();
            document.getElementById('couponModal').classList.add('active');
        }

        function closeCouponModal() {
            document.getElementById('couponModal').classList.remove('active');
        }

        function openAddCouponModal() {
            document.getElementById('couponForm').reset();
            // 設定預設日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('couponStartDate').value = today;
            document.getElementById('addCouponModal').classList.add('active');
        }

        function closeAddCouponModal() {
            document.getElementById('addCouponModal').classList.remove('active');
        }

        function toggleDiscountInput() {
            const type = document.getElementById('couponType').value;
            const unit = document.getElementById('couponUnit');
            unit.textContent = type === 'percentage' ? '%' : 'NT$';
        }

        function renderCoupons() {
            const couponList = document.getElementById('couponList');
            document.getElementById('couponCount').textContent = coupons.length;
            
            if (coupons.length === 0) {
                couponList.innerHTML = '<div class="col-span-2 text-center py-8 text-gray-500">尚無優惠券</div>';
                return;
            }
            
            couponList.innerHTML = coupons.map(coupon => {
                const statusMap = {
                    'active': { text: '啟用中', class: 'bg-green-100 text-green-800' },
                    'expired': { text: '已過期', class: 'bg-gray-100 text-gray-800' },
                    'disabled': { text: '已停用', class: 'bg-red-100 text-red-800' }
                };
                const status = statusMap[coupon.status] || statusMap['active'];
                
                const discountText = coupon.type === 'percentage' 
                    ? `${coupon.value}% OFF` 
                    : `NT$ ${coupon.value} OFF`;
                
                const limitText = coupon.limitCount 
                    ? `${coupon.usedCount || 0}/${coupon.limitCount} 已使用` 
                    : `${coupon.usedCount || 0} 已使用`;
                
                return `
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 hover:shadow-lg transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h5 class="text-lg font-bold text-gray-800">${coupon.name}</h5>
                                <p class="text-sm text-gray-600 font-mono bg-white px-2 py-1 rounded mt-1 inline-block">${coupon.code}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${status.class}">
                                ${status.text}
                            </span>
                        </div>
                        
                        <div class="bg-white rounded-lg p-3 mb-3">
                            <div class="text-center">
                                <p class="text-3xl font-bold text-purple-600">${discountText}</p>
                                ${coupon.minSpend > 0 ? `<p class="text-xs text-gray-600 mt-1">最低消費 NT$ ${coupon.minSpend}</p>` : ''}
                                ${coupon.maxDiscount ? `<p class="text-xs text-gray-600">最多折 NT$ ${coupon.maxDiscount}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                            <span><i class="fas fa-calendar mr-1"></i>${coupon.startDate} ~ ${coupon.endDate}</span>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm mb-3">
                            <span class="text-gray-600">${limitText}</span>
                            <div class="flex-1 mx-3 bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full" style="width: ${coupon.limitCount ? (coupon.usedCount / coupon.limitCount * 100) : 50}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="editCoupon(${coupon.id})" class="flex-1 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            <button onclick="toggleCoupon(${coupon.id})" class="flex-1 px-3 py-2 ${coupon.status === 'active' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg text-sm">
                                <i class="fas fa-${coupon.status === 'active' ? 'pause' : 'play'} mr-1"></i>${coupon.status === 'active' ? '停用' : '啟用'}
                            </button>
                            <button onclick="deleteCoupon(${coupon.id})" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editCoupon(id) {
            alert(`編輯優惠券 ID: ${id}`);
        }

        function toggleCoupon(id) {
            const coupon = coupons.find(c => c.id === id);
            if (coupon) {
                coupon.status = coupon.status === 'active' ? 'disabled' : 'active';
                renderCoupons();
            }
        }

        function deleteCoupon(id) {
            if (confirm('確定要刪除此優惠券嗎？')) {
                const index = coupons.findIndex(c => c.id === id);
                if (index > -1) {
                    coupons.splice(index, 1);
                    renderCoupons();
                }
            }
        }

        document.getElementById('couponForm').addEventListener('submit', (e) => {
            e.preventDefault();
            alert('優惠券已儲存！');
            closeAddCouponModal();
        });

        // 初始化
        // 頁面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 檢查管理員登入
            const adminToken = localStorage.getItem('admin_token') || localStorage.getItem('auth_token');
            if (!adminToken) {
                const adminUser = JSON.parse(localStorage.getItem('adminUser') || 'null');
                if (!adminUser) {
                    alert('請先登入管理員帳號');
                    window.location.href = 'admin-login.html';
                    return;
                }
            }
            
            // 設置認證令牌
            if (window.ApiClient) {
                window.ApiClient.setToken(adminToken);
            }
            
            // 等待 ApiClient 載入
            if (!window.ApiClient) {
                setTimeout(async () => {
                    if (window.ApiClient) {
                        window.ApiClient.setToken(adminToken);
                        await renderOrders();
                    } else {
                        console.error('ApiClient 未載入');
                        renderOrders(); // 使用測試數據
                    }
                }, 500);
            } else {
                await renderOrders();
            }
            
            // 初始化門市選擇器（如果存在）
            const storeTypeRadios = document.querySelectorAll('input[name="storeType"]');
            storeTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (typeof renderStoreList === 'function') {
                        renderStoreList();
                    }
                });
            });
        });
    </script>
</body>
</html>