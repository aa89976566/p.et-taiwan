<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單管理 - 匠寵後台管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(230, 57, 70, 0.1); border-left: 4px solid #E63946; }
        .sidebar-item.active { background: rgba(230, 57, 70, 0.15); border-left: 4px solid #E63946; font-weight: 600; }
        .table-row:hover { background: #F9FAFB; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
    </style>
    
    <!-- 引入數據管理系統 -->
    <script src="js/data-store.js"></script>
    <script src="js/mock-data.js"></script>
    <script src="js/admin-orders.js"></script>
</head>
<body class="bg-gray-50">
    <!-- 頂部導航欄 -->
    <nav class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-400 rounded-xl flex items-center justify-center">
                        <i class="fas fa-paw text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">匠寵後台</h1>
                        <p class="text-xs text-gray-500">訂單管理</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button class="relative text-gray-600 hover:text-gray-800">
                    <i class="fas fa-bell text-xl"></i>
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">15</span>
                </button>
                <div class="flex items-center space-x-3 border-l pl-4">
                    <div class="hidden md:block text-right">
                        <p class="text-sm font-semibold text-gray-800" id="adminName">超級管理員</p>
                        <p class="text-xs text-gray-500" id="adminRole">Super Admin</p>
                    </div>
                    <button class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold">A</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 側邊欄 -->
    <aside class="fixed left-0 top-16 bottom-0 w-64 bg-white shadow-lg overflow-y-auto z-40">
        <div class="p-4">
            <nav class="space-y-2">
                <a href="admin-dashboard.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                    <i class="fas fa-chart-line text-lg w-6"></i><span>儀表板</span>
                </a>
                <div class="sidebar-section">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">用戶管理</p>
                    <a href="admin-users.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-users text-lg w-6"></i><span>用戶列表</span>
                    </a>

                </div>
                <div class="sidebar-section mt-4">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">商品管理</p>
                    <a href="admin-products.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-box text-lg w-6"></i><span>產品列表</span>
                    </a>
                    <a href="admin-orders.html" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-shopping-cart text-lg w-6"></i><span>訂單管理</span><span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">15</span>
                    </a>
                </div>
                <div class="sidebar-section mt-4">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">物流管理</p>
                    <a href="admin-shipping.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-shipping-fast text-lg w-6"></i><span>物流設定</span>
                    </a>
                    <a href="checkout.html" target="_blank" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-truck text-lg w-6"></i><span>測試結帳流程</span>
                    </a>
                </div>
                <div class="sidebar-section mt-4">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">測驗系統</p>
                    <a href="admin-quizzes.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-clipboard-list text-lg w-6"></i><span>測驗列表</span>
                    </a>
                    <a href="admin-quiz-stats.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-chart-pie text-lg w-6"></i><span>測驗統計</span>
                    </a>
                </div>
                <div class="sidebar-section mt-4">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">訂閱服務</p>
                    <a href="admin-subscriptions.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-sync-alt text-lg w-6"></i><span>訂閱列表</span>
                    </a>
                    <a href="admin-jar-program.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-recycle text-lg w-6"></i><span>換罐計畫</span>
                    </a>
                </div>
                <div class="sidebar-section mt-4">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">數據分析</p>
                    <a href="admin-analytics.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-chart-bar text-lg w-6"></i><span>營收報表</span>
                    </a>
                </div>
                <div class="sidebar-section mt-4">
                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">系統設定</p>
                    <a href="admin-homepage.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-edit text-lg w-6"></i><span>首頁內容管理</span>
                    </a>
                    <a href="admin-settings.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg">
                        <i class="fas fa-cog text-lg w-6"></i><span>系統設定</span>
                    </a>
                    <a href="admin-login.html" onclick="logout()" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600">
                        <i class="fas fa-sign-out-alt text-lg w-6"></i><span>登出</span>
                    </a>
                </div>
            </nav>
        </div>
    </aside>

    <!-- 主內容區 -->
    <main class="ml-64 pt-16 p-8">
        <!-- 標題 -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">訂單管理</h2>
                    <p class="text-gray-600 mt-2">管理所有訂單，追蹤配送狀態</p>
                </div>
                <button onclick="openCouponModal()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition">
                    <i class="fas fa-ticket-alt mr-2"></i>優惠券管理
                </button>
            </div>
        </div>

        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- 今日訂單 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterTodayOrders()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">今日訂單</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">28</h3>
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-arrow-up"></i> +15.2%
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-shopping-cart text-2xl text-blue-500"></i>
                    </div>
                </div>
            </div>

            <!-- 待處理訂單 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterPendingOrders()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">待處理訂單</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">15</h3>
                        <p class="text-sm text-orange-600 mt-2">
                            <i class="fas fa-exclamation-circle"></i> 需處理
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-2xl text-orange-500"></i>
                    </div>
                </div>
            </div>

            <!-- 今日營收 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterTodayRevenue()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">今日營收</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">$48,520</h3>
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-arrow-up"></i> +12.5%
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-2xl text-green-500"></i>
                    </div>
                </div>
            </div>

            <!-- 本月營收 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterMonthlyRevenue()">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">本月營收</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">$685,340</h3>
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-arrow-up"></i> +18.7%
                        </p>
                    </div>
                    <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-line text-2xl text-purple-500"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜尋與篩選 -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- 搜尋框 -->
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">搜尋</label>
                    <input type="text" id="searchInput" placeholder="訂單編號、客戶姓名、電話..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>

                <!-- 付款狀態 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">付款狀態</label>
                    <select id="paymentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">全部</option>
                        <option value="pending">待付款</option>
                        <option value="paid">已付款</option>
                        <option value="refunded">已退款</option>
                    </select>
                </div>

                <!-- 配送狀態 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">配送狀態</label>
                    <select id="deliveryStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">全部</option>
                        <option value="preparing">待出貨</option>
                        <option value="shipping">配送中</option>
                        <option value="arrived">已到店（超商）</option>
                        <option value="delivered">已送達/已取貨</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>

                <!-- 時間範圍 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">時間範圍</label>
                    <select id="dateRange" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">全部</option>
                        <option value="today">今天</option>
                        <option value="week">本週</option>
                        <option value="month">本月</option>
                    </select>
                </div>
            </div>

            <!-- 按鈕 -->
            <div class="flex justify-between items-center mt-4">
                <div class="flex space-x-3">
                    <button onclick="applyFilters()" class="px-6 py-2 bg-gradient-to-r from-red-500 to-orange-400 text-white rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-search mr-2"></i>套用篩選
                    </button>
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-undo mr-2"></i>重置
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button onclick="exportOrders()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                        <i class="fas fa-file-excel mr-2"></i>匯出訂單
                    </button>
                    <button onclick="batchPrint()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition text-sm">
                        <i class="fas fa-print mr-2"></i>批次列印
                    </button>
                </div>
            </div>
        </div>

        <!-- 訂單列表 -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">訂單列表</h3>
                <span class="text-sm text-gray-600">共 <span id="totalOrders">15</span> 筆訂單</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left">
                                <input type="checkbox" class="rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">訂單編號</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">訂單時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">客戶資訊</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">商品摘要</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">物流方式</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">訂單金額</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">付款狀態</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">配送狀態</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="divide-y divide-gray-200">
                        <!-- 訂單列表將由 JavaScript 動態生成 -->
                    </tbody>
                </table>
            </div>

            <!-- 分頁 -->
            <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    顯示 <span id="showingFrom">1</span> 到 <span id="showingTo">15</span>，共 <span id="totalCount">15</span> 筆
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                        <i class="fas fa-chevron-left mr-2"></i>上一頁
                    </button>
                    <button class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm">1</button>
                    <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">2</button>
                    <button onclick="nextPage()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                        下一頁<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 訂單詳情 Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-4">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-red-50 to-orange-50">
                <h3 class="text-xl font-bold text-gray-800">訂單詳情</h3>
                <button onclick="closeOrderDetail()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- 訂單基本資訊 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-600">訂單編號</p>
                        <p class="text-lg font-semibold text-gray-800" id="modalOrderId">#2024120001</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">訂單時間</p>
                        <p class="text-lg font-semibold text-gray-800" id="modalOrderDate">2024-12-20 10:30</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">訂單狀態</p>
                        <div id="modalOrderStatus"></div>
                    </div>
                </div>

                <!-- 客戶資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">客戶資訊</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">姓名</p>
                            <p class="font-medium" id="modalCustomerName">王小明</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">電話</p>
                            <p class="font-medium" id="modalCustomerPhone">0912-345-678</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-sm text-gray-600">Email</p>
                            <p class="font-medium" id="modalCustomerEmail">customer@example.com</p>
                        </div>
                    </div>
                </div>

                <!-- 收件資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">收件資訊</h4>
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <p class="text-sm text-gray-600">收件人</p>
                        <p class="font-medium mb-2" id="modalRecipientName">王小明</p>
                        <p class="text-sm text-gray-600">收件地址</p>
                        <p class="font-medium mb-2" id="modalRecipientAddress">台北市信義區信義路五段7號</p>
                        <p class="text-sm text-gray-600">聯絡電話</p>
                        <p class="font-medium" id="modalRecipientPhone">0912-345-678</p>
                    </div>
                </div>

                <!-- 商品明細 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">商品明細</h4>
                    <table class="w-full border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">產品名稱</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">單價</th>
                                <th class="px-4 py-2 text-center text-sm font-medium text-gray-600">數量</th>
                                <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">小計</th>
                            </tr>
                        </thead>
                        <tbody id="modalProductList" class="divide-y divide-gray-200">
                            <!-- 商品列表將由 JavaScript 動態生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 金額計算 -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between py-2">
                        <span class="text-gray-600">商品總計</span>
                        <span class="font-medium" id="modalSubtotal">NT$ 1,980</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="text-gray-600">運費</span>
                        <span class="font-medium" id="modalShipping">NT$ 80</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="text-gray-600">折扣</span>
                        <span class="font-medium text-red-600" id="modalDiscount">-NT$ 0</span>
                    </div>
                    <div class="flex justify-between py-3 border-t border-gray-300 mt-2">
                        <span class="text-lg font-semibold text-gray-800">應付金額</span>
                        <span class="text-lg font-bold text-red-600" id="modalTotal">NT$ 2,060</span>
                    </div>
                </div>

                <!-- 支付管理 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">支付管理</h4>
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-2">付款狀態</p>
                                <select id="modalPaymentStatus" onchange="updatePaymentStatus()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="pending">待付款</option>
                                    <option value="paid">已付款</option>
                                    <option value="refunded">已退款</option>
                                </select>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2">付款方式</p>
                                <select id="modalPaymentMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="credit_card">信用卡</option>
                                    <option value="atm">ATM 轉帳</option>
                                    <option value="convenience_store">超商代碼</option>
                                    <option value="line_pay">LINE Pay</option>
                                    <option value="apple_pay">Apple Pay</option>
                                    <option value="cash_on_delivery">貨到付款</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">交易編號</p>
                            <input type="text" id="modalTransactionId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="輸入支付交易編號">
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="confirmPayment()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                                <i class="fas fa-check mr-1"></i>確認付款
                            </button>
                            <button onclick="processRefund()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition text-sm">
                                <i class="fas fa-undo mr-1"></i>處理退款
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 物流資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">物流資訊</h4>
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-2">物流方式</p>
                                <select id="modalCourier" onchange="handleCourierChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="">請選擇物流方式</option>
                                    <optgroup label="宅配到府">
                                        <option value="黑貓宅急便">黑貓宅急便</option>
                                        <option value="新竹貨運">新竹貨運</option>
                                        <option value="嘉里大榮">嘉里大榮</option>
                                        <option value="宅配通">宅配通</option>
                                        <option value="順豐速運">順豐速運</option>
                                    </optgroup>
                                    <optgroup label="超商取貨">
                                        <option value="7-11 超商取貨">7-11 超商取貨</option>
                                        <option value="全家超商取貨">全家超商取貨</option>
                                        <option value="萊爾富超商取貨">萊爾富超商取貨</option>
                                        <option value="OK 超商取貨">OK 超商取貨</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2">配送狀態</p>
                                <select id="modalDeliveryStatus" onchange="updateDeliveryStatus()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="preparing">待出貨</option>
                                    <option value="shipping">配送中</option>
                                    <option value="arrived">已到店</option>
                                    <option value="delivered">已送達/已取貨</option>
                                    <option value="cancelled">已取消</option>
                                </select>
                            </div>
                        </div>

                        <!-- 宅配資訊 -->
                        <div id="homeDeliveryInfo">
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">配送地址</p>
                                <input type="text" id="modalDeliveryAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="完整配送地址">
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">物流追蹤號碼</p>
                                <input type="text" id="modalTrackingNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="輸入物流追蹤號碼">
                            </div>
                        </div>

                        <!-- 超商取貨資訊 -->
                        <div id="storePickupInfo" class="hidden">
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">取貨門市</p>
                                <div class="flex space-x-2">
                                    <input type="text" id="modalStoreName" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="門市名稱" readonly>
                                    <button type="button" onclick="selectStore()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm whitespace-nowrap">
                                        <i class="fas fa-map-marker-alt mr-1"></i>選擇門市
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">門市地址</p>
                                <input type="text" id="modalStoreAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">門市代碼</p>
                                <input type="text" id="modalStoreCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">取貨編號</p>
                                <input type="text" id="modalPickupCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="超商取貨編號">
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t">
                            <button onclick="updateShippingInfo()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-save mr-1"></i>更新物流資訊
                            </button>
                            <a href="#" onclick="trackShipping(); return false;" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>查詢物流進度
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 訂單備註 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">訂單備註</h4>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <textarea id="modalNotes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none" placeholder="輸入訂單備註（例：請在下午配送、客戶已加 LINE 聯繫等）"></textarea>
                        <button onclick="updateOrderNotes()" class="mt-3 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm">
                            <i class="fas fa-save mr-1"></i>儲存備註
                        </button>
                    </div>
                </div>
                
                <!-- LINE 客服資訊 -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">
                        <i class="fab fa-line text-green-500 mr-2"></i>LINE 客服聯繫
                    </h4>
                    <div class="p-4 border-2 border-green-200 rounded-lg bg-green-50">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <img src="https://www.genspark.ai/api/files/s/p1ymWhU0" alt="LINE QR Code" class="w-24 h-24 rounded-lg border-2 border-green-500">
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 mb-2">
                                    <i class="fas fa-info-circle text-green-600 mr-1"></i>
                                    <strong>客戶服務 LINE 官方帳號</strong>
                                </p>
                                <p class="text-xs text-gray-600 mb-3">
                                    引導客戶掃描 QR Code 或搜尋 LINE ID 加入官方帳號，提供即時客服支援。
                                </p>
                                <div class="flex items-center space-x-2">
                                    <button onclick="copyLineLink()" class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-xs">
                                        <i class="fas fa-copy mr-1"></i>複製 LINE 連結
                                    </button>
                                    <button onclick="sendLineReminder()" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-xs">
                                        <i class="fas fa-envelope mr-1"></i>發送 LINE 提醒
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button onclick="printOrder()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i class="fas fa-print mr-2"></i>列印訂單
                </button>
                <button onclick="markAsShipped()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-shipping-fast mr-2"></i>標記已出貨
                </button>
                <button onclick="markAsDelivered()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    <i class="fas fa-check mr-2"></i>標記已送達
                </button>
                <button onclick="cancelOrder()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-times mr-2"></i>取消訂單
                </button>
            </div>
        </div>
    </div>

    <!-- 門市選擇 Modal -->
    <div id="storeSelectionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden mx-4">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-green-50">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-store mr-2 text-blue-600"></i>選擇取貨門市
                </h3>
                <button onclick="closeStoreSelectionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- 搜尋區 -->
                <div class="mb-6">
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <input type="text" id="storeSearchInput" placeholder="搜尋門市名稱、地址或門市代碼..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button onclick="searchStores()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition whitespace-nowrap">
                            <i class="fas fa-search mr-2"></i>搜尋
                        </button>
                    </div>
                    <div class="mt-3 flex items-center space-x-4 text-sm">
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="711" checked class="mr-2">
                            <span>7-11</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="family" class="mr-2">
                            <span>全家</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="hilife" class="mr-2">
                            <span>萊爾富</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="storeType" value="ok" class="mr-2">
                            <span>OK</span>
                        </label>
                    </div>
                </div>

                <!-- 門市列表 -->
                <div class="max-h-96 overflow-y-auto space-y-3" id="storeList">
                    <!-- 門市項目將動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 優惠券管理 Modal -->
    <div id="couponModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-ticket-alt mr-2 text-purple-600"></i>優惠券管理</h3>
                <button onclick="closeCouponModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- 動作按鈕 -->
                <div class="flex items-center justify-between mb-6">
                    <div class="text-sm text-gray-600">
                        共 <span class="font-semibold text-gray-800" id="couponCount">8</span> 張優惠券
                    </div>
                    <button onclick="openAddCouponModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-plus mr-2"></i>新增優惠券
                    </button>
                </div>

                <!-- 優惠券列表 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="couponList">
                    <!-- 優惠券卡片將由 JavaScript 動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 新增優惠券 Modal -->
    <div id="addCouponModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">新增優惠券</h3>
                <button onclick="closeAddCouponModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="couponForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">優惠券名稱 *</label>
                        <input type="text" id="couponName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="例：新年優惠">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">優惠碼 *</label>
                        <input type="text" id="couponCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="例：NEWYEAR2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">折扣類型 *</label>
                        <select id="couponType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="toggleDiscountInput()">
                            <option value="percentage">百分比折扣</option>
                            <option value="fixed">固定金額</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">折扣值 *</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="couponValue" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="10" min="1">
                            <span id="couponUnit" class="text-gray-600 font-medium">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最低消費</label>
                        <input type="number" id="couponMinSpend" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大折扣額</label>
                        <input type="number" id="couponMaxDiscount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="無上限" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">使用次數限制</label>
                        <input type="number" id="couponLimit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="無限制" min="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">已使用次數</label>
                        <input type="number" id="couponUsed" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0" min="0" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期 *</label>
                        <input type="date" id="couponStartDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期 *</label>
                        <input type="date" id="couponEndDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">說明</label>
                    <textarea id="couponDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="優惠券說明..."></textarea>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeAddCouponModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg">
                        <i class="fas fa-save mr-2"></i>儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 檢查登入狀態
        const userData = localStorage.getItem('adminUser');
        if (!userData) {
            window.location.href = 'admin-login.html';
        } else {
            const user = JSON.parse(userData);
            document.getElementById('adminName').textContent = user.name;
            document.getElementById('adminRole').textContent = user.role;
        }

        // 測試訂單資料
        const orders = [
            { id: '#2024120015', date: '2024-12-21 14:30', customer: '王小明', phone: '0912-345-678', products: '雞肉脆片 x2', amount: 600, payment: 'paid', delivery: 'delivered', email: 'wang@example.com', address: '台北市信義區信義路五段7號', courier: '黑貓宅急便', tracking: '123456789', items: [{name: '雞肉脆片', price: 300, qty: 2, subtotal: 600}], subtotal: 600, shipping: 80, discount: 0, total: 680, notes: '無特別備註' },
            { id: '#2024120014', date: '2024-12-21 13:15', customer: '李美玲', phone: '0923-456-789', products: '地瓜餅乾 x1, 鮭魚小丸子 x1', amount: 560, payment: 'paid', delivery: 'shipping', email: 'li@example.com', address: '新北市板橋區中山路一段123號', courier: '新竹貨運', tracking: '987654321', items: [{name: '地瓜餅乾', price: 280, qty: 1, subtotal: 280}, {name: '鮭魚小丸子', price: 280, qty: 1, subtotal: 280}], subtotal: 560, shipping: 80, discount: 0, total: 640, notes: '請在下午配送' },
            { id: '#2024120013', date: '2024-12-21 11:45', customer: '張大華', phone: '0934-567-890', products: '壕大大雞排 x3', amount: 660, payment: 'pending', delivery: 'preparing', email: 'chang@example.com', address: '台中市西屯區台灣大道三段99號', courier: '黑貓宅急便', tracking: '', items: [{name: '壕大大雞排', price: 220, qty: 3, subtotal: 660}], subtotal: 660, shipping: 80, discount: 0, total: 740, notes: '無特別備註' },
            { id: '#2024120012', date: '2024-12-21 10:20', customer: '陳小芬', phone: '0945-678-901', products: '牛肉乾 x2, 地瓜餅乾 x2', amount: 1160, payment: 'paid', delivery: 'delivered', email: 'chen@example.com', address: '高雄市前鎮區中山三路88號', courier: '新竹貨運', tracking: '555666777', items: [{name: '牛肉乾', price: 300, qty: 2, subtotal: 600}, {name: '地瓜餅乾', price: 280, qty: 2, subtotal: 560}], subtotal: 1160, shipping: 100, discount: 0, total: 1260, notes: '請勿放在管理室' },
            { id: '#2024120011', date: '2024-12-21 09:30', customer: '林志明', phone: '0956-789-012', products: '嗅聞墊初級版 x1', amount: 399, payment: 'paid', delivery: 'shipping', email: 'lin@example.com', address: '台南市東區中華東路二段66號', courier: '黑貓宅急便', tracking: '333444555', items: [{name: '嗅聞墊初級版', price: 399, qty: 1, subtotal: 399}], subtotal: 399, shipping: 80, discount: 0, total: 479, notes: '無特別備註' },
            { id: '#2024120010', date: '2024-12-20 16:45', customer: '黃淑惠', phone: '0967-890-123', products: '推拉解謎板中級版 x1', amount: 699, payment: 'refunded', delivery: 'cancelled', email: 'huang@example.com', address: '桃園市中壢區中央西路100號', courier: '新竹貨運', tracking: '', items: [{name: '推拉解謎板中級版', price: 699, qty: 1, subtotal: 699}], subtotal: 699, shipping: 80, discount: 0, total: 779, notes: '客戶要求退款' },
            { id: '#2024120009', date: '2024-12-20 15:30', customer: '劉建國', phone: '0978-901-234', products: '雞肉脆片 x5', amount: 1500, payment: 'paid', delivery: 'delivered', email: 'liu@example.com', address: '新竹市東區光復路一段55號', courier: '黑貓宅急便', tracking: '777888999', items: [{name: '雞肉脆片', price: 300, qty: 5, subtotal: 1500}], subtotal: 1500, shipping: 100, discount: 100, total: 1500, notes: '老客戶，已折扣100元' },
            { id: '#2024120008', date: '2024-12-20 14:15', customer: '吳雅婷', phone: '0989-012-345', products: '營養主餐罐 x4', amount: 2396, payment: 'paid', delivery: 'delivered', email: 'wu@example.com', address: '基隆市仁愛區孝一路22號', courier: '新竹貨運', tracking: '111222333', items: [{name: '營養主餐罐', price: 599, qty: 4, subtotal: 2396}], subtotal: 2396, shipping: 100, discount: 0, total: 2496, notes: '訂閱會員' },
            { id: '#2024120007', date: '2024-12-20 12:00', customer: '蔡宗翰', phone: '0990-123-456', products: '記憶按鈕高級版 x1', amount: 899, payment: 'pending', delivery: 'preparing', email: 'tsai@example.com', address: '宜蘭市中山路三段200號', courier: '黑貓宅急便', tracking: '', items: [{name: '記憶按鈕高級版', price: 899, qty: 1, subtotal: 899}], subtotal: 899, shipping: 100, discount: 0, total: 999, notes: '無特別備註' },
            { id: '#2024120006', date: '2024-12-20 10:30', customer: '鄭雅芳', phone: '0901-234-567', products: '壕大大雞排 x2, 地瓜餅乾 x1', amount: 720, payment: 'paid', delivery: 'shipping', email: 'cheng@example.com', address: '花蓮市中正路150號', courier: '新竹貨運', tracking: '444555666', items: [{name: '壕大大雞排', price: 220, qty: 2, subtotal: 440}, {name: '地瓜餅乾', price: 280, qty: 1, subtotal: 280}], subtotal: 720, shipping: 100, discount: 0, total: 820, notes: '請在上午配送' },
            { id: '#2024120005', date: '2024-12-20 09:15', customer: '許家豪', phone: '0912-345-678', products: '牛肉乾 x3', amount: 900, payment: 'paid', delivery: 'delivered', email: 'hsu@example.com', address: '台東市中華路一段88號', courier: '黑貓宅急便', tracking: '999000111', items: [{name: '牛肉乾', price: 300, qty: 3, subtotal: 900}], subtotal: 900, shipping: 120, discount: 0, total: 1020, notes: '無特別備註' },
            { id: '#2024120004', date: '2024-12-19 17:45', customer: '楊文彬', phone: '0923-456-789', products: '鮭魚小丸子 x4', amount: 1120, payment: 'paid', delivery: 'delivered', email: 'yang@example.com', address: '屏東市自由路200號', courier: '新竹貨運', tracking: '222333444', items: [{name: '鮭魚小丸子', price: 280, qty: 4, subtotal: 1120}], subtotal: 1120, shipping: 120, discount: 0, total: 1240, notes: '無特別備註' },
            { id: '#2024120003', date: '2024-12-19 15:20', customer: '謝佩珊', phone: '0934-567-890', products: '雞肉脆片 x1, 壕大大雞排 x1', amount: 520, payment: 'pending', delivery: 'preparing', email: 'hsieh@example.com', address: '苗栗市中正路55號', courier: '黑貓宅急便', tracking: '', items: [{name: '雞肉脆片', price: 300, qty: 1, subtotal: 300}, {name: '壕大大雞排', price: 220, qty: 1, subtotal: 220}], subtotal: 520, shipping: 80, discount: 0, total: 600, notes: '無特別備註' },
            { id: '#2024120002', date: '2024-12-19 13:00', customer: '賴冠宇', phone: '0945-678-901', products: '嗅聞墊初級版 x2', amount: 798, payment: 'paid', delivery: 'shipping', email: 'lai@example.com', address: '彰化市中山路二段123號', courier: '新竹貨運', tracking: '666777888', items: [{name: '嗅聞墊初級版', price: 399, qty: 2, subtotal: 798}], subtotal: 798, shipping: 80, discount: 0, total: 878, notes: '無特別備註' },
            { id: '#2024120001', date: '2024-12-19 10:30', customer: '周怡君', phone: '0956-789-012', products: '營養主餐罐 x2', amount: 1198, payment: 'paid', delivery: 'delivered', email: 'chou@example.com', address: '嘉義市東區中山路300號', courier: '黑貓宅急便', tracking: '888999000', items: [{name: '營養主餐罐', price: 599, qty: 2, subtotal: 1198}], subtotal: 1198, shipping: 100, discount: 0, total: 1298, notes: '訂閱會員' },
        ];

        // 渲染訂單列表
        function renderOrders(filteredOrders = orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            filteredOrders.forEach(order => {
                const paymentBadge = getPaymentBadge(order.payment);
                const deliveryBadge = getDeliveryBadge(order.delivery);
                
                // 顯示物流方式（簡短版）
                let shippingLabel = order.courier || '未設定';
                if (shippingLabel.includes('黑貓')) shippingLabel = '🚚 黑貓';
                else if (shippingLabel.includes('新竹')) shippingLabel = '🚚 新竹';
                else if (shippingLabel.includes('嘉里')) shippingLabel = '🚚 嘉里';
                else if (shippingLabel.includes('宅配通')) shippingLabel = '🚚 宅配通';
                else if (shippingLabel.includes('順豐')) shippingLabel = '🚚 順豐';
                else if (shippingLabel.includes('7-11')) shippingLabel = '🏪 7-11';
                else if (shippingLabel.includes('全家')) shippingLabel = '🏪 全家';
                else if (shippingLabel.includes('萊爾富')) shippingLabel = '🏪 萊爾富';
                else if (shippingLabel.includes('OK')) shippingLabel = '🏪 OK';

                const row = `
                    <tr class="table-row">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="rounded">
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-semibold text-blue-600 cursor-pointer hover:text-blue-800" onclick='viewOrderDetail(${JSON.stringify(order)})'>${order.id}</span>
                        </td>
                        <td class="px-6 py-4 text-gray-700 text-sm">${order.date}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-800">${order.customer}</div>
                            <div class="text-sm text-gray-500">${order.phone}</div>
                        </td>
                        <td class="px-6 py-4 text-gray-700 text-sm">${order.products}</td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-gray-600 mb-1">${shippingLabel}</div>
                            ${order.tracking ? `<div class="text-xs text-blue-600"><i class="fas fa-hashtag"></i> ${order.tracking}</div>` : '<div class="text-xs text-gray-400">未設定</div>'}
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-semibold text-gray-800">NT$ ${order.amount}</span>
                        </td>
                        <td class="px-6 py-4">${paymentBadge}</td>
                        <td class="px-6 py-4">${deliveryBadge}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick='viewOrderDetail(${JSON.stringify(order)})' class="text-blue-600 hover:text-blue-800" title="查看詳情">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="printOrder()" class="text-gray-600 hover:text-gray-800" title="列印">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('totalOrders').textContent = filteredOrders.length;
            document.getElementById('totalCount').textContent = filteredOrders.length;
        }

        // 付款狀態標籤
        function getPaymentBadge(status) {
            const badges = {
                'pending': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i> 待付款</span>',
                'paid': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i> 已付款</span>',
                'refunded': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><i class="fas fa-undo mr-1"></i> 已退款</span>'
            };
            return badges[status] || '';
        }

        // 配送狀態標籤
        function getDeliveryBadge(status) {
            const badges = {
                'preparing': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><i class="fas fa-box mr-1"></i> 待出貨</span>',
                'shipping': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800"><i class="fas fa-shipping-fast mr-1"></i> 配送中</span>',
                'arrived': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800"><i class="fas fa-store mr-1"></i> 已到店</span>',
                'delivered': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-double mr-1"></i> 已送達/已取貨</span>',
                'cancelled': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-times mr-1"></i> 已取消</span>'
            };
            return badges[status] || '';
        }

        // 當前查看的訂單
        let currentOrder = null;

        // 查看訂單詳情
        function viewOrderDetail(order) {
            currentOrder = order; // 保存當前訂單
            document.getElementById('modalOrderId').textContent = order.id;
            document.getElementById('modalOrderDate').textContent = order.date;
            document.getElementById('modalCustomerName').textContent = order.customer;
            document.getElementById('modalCustomerPhone').textContent = order.phone;
            document.getElementById('modalCustomerEmail').textContent = order.email;
            document.getElementById('modalRecipientName').textContent = order.customer;
            document.getElementById('modalRecipientAddress').textContent = order.address;
            document.getElementById('modalRecipientPhone').textContent = order.phone;
            
            // 物流資訊
            document.getElementById('modalCourier').value = order.courier || '';
            document.getElementById('modalDeliveryStatus').value = order.delivery || 'preparing';
            
            // 根據物流方式顯示對應欄位
            const isStorePickup = order.courier && order.courier.includes('超商取貨');
            if (isStorePickup) {
                document.getElementById('homeDeliveryInfo').classList.add('hidden');
                document.getElementById('storePickupInfo').classList.remove('hidden');
                document.getElementById('modalStoreName').value = order.storeName || '';
                document.getElementById('modalStoreAddress').value = order.storeAddress || '';
                document.getElementById('modalStoreCode').value = order.storeCode || '';
                document.getElementById('modalPickupCode').value = order.pickupCode || order.tracking || '';
            } else {
                document.getElementById('homeDeliveryInfo').classList.remove('hidden');
                document.getElementById('storePickupInfo').classList.add('hidden');
                document.getElementById('modalDeliveryAddress').value = order.address || '';
                document.getElementById('modalTrackingNumber').value = order.tracking || '';
            }
            
            document.getElementById('modalNotes').value = order.notes || '無特別備註';
            document.getElementById('modalSubtotal').textContent = `NT$ ${order.subtotal}`;
            document.getElementById('modalShipping').textContent = `NT$ ${order.shipping}`;
            document.getElementById('modalDiscount').textContent = order.discount > 0 ? `-NT$ ${order.discount}` : 'NT$ 0';
            document.getElementById('modalTotal').textContent = `NT$ ${order.total}`;
            
            // 支付信息
            document.getElementById('modalPaymentStatus').value = order.payment;
            document.getElementById('modalPaymentMethod').value = order.paymentMethod || 'credit_card';
            document.getElementById('modalTransactionId').value = order.transactionId || '';

            // 狀態標籤
            const paymentBadge = getPaymentBadge(order.payment);
            const deliveryBadge = getDeliveryBadge(order.delivery);
            document.getElementById('modalOrderStatus').innerHTML = `${paymentBadge} ${deliveryBadge}`;

            // 商品列表
            const productList = document.getElementById('modalProductList');
            productList.innerHTML = '';
            order.items.forEach(item => {
                const row = `
                    <tr>
                        <td class="px-4 py-3 text-gray-800">${item.name}</td>
                        <td class="px-4 py-3 text-right text-gray-700">NT$ ${item.price}</td>
                        <td class="px-4 py-3 text-center text-gray-700">${item.qty}</td>
                        <td class="px-4 py-3 text-right font-medium text-gray-800">NT$ ${item.subtotal}</td>
                    </tr>
                `;
                productList.innerHTML += row;
            });

            document.getElementById('orderDetailModal').classList.add('active');
        }

        // 關閉訂單詳情
        function closeOrderDetail() {
            document.getElementById('orderDetailModal').classList.remove('active');
        }

        // 列印訂單
        function printOrder() {
            alert('訂單列印功能');
        }

        // 標記已出貨
        function markAsShipped() {
            if (currentOrder) {
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = 'shipping';
                    alert('✅ 訂單已標記為出貨中\n\n訂單編號: ' + currentOrder.id);
                    renderOrders();
                    closeOrderDetail();
                }
            }
        }

        // 標記已送達
        function markAsDelivered() {
            if (currentOrder) {
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = 'delivered';
                    alert('✅ 訂單已標記為已送達\n\n訂單編號: ' + currentOrder.id);
                    renderOrders();
                    closeOrderDetail();
                }
            }
        }

        // 取消訂單
        function cancelOrder() {
            if (currentOrder && confirm('確定要取消此訂單嗎？')) {
                // 更新訂單狀態
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = 'cancelled';
                    orders[orderIndex].payment = 'refunded';
                    
                    // 顯示成功訊息
                    alert('✅ 訂單已取消\n\n訂單編號: ' + currentOrder.id + '\n配送狀態: 已取消\n付款狀態: 已退款');
                    
                    // 重新渲染訂單列表
                    renderOrders();
                    
                    // 關閉 Modal
                    closeOrderDetail();
                }
            }
        }

        // 處理物流方式變更
        function handleCourierChange() {
            const courier = document.getElementById('modalCourier').value;
            const homeDelivery = document.getElementById('homeDeliveryInfo');
            const storePickup = document.getElementById('storePickupInfo');
            
            // 判斷是否為超商取貨
            const isStorePickup = courier.includes('超商取貨');
            
            if (isStorePickup) {
                homeDelivery.classList.add('hidden');
                storePickup.classList.remove('hidden');
            } else {
                homeDelivery.classList.remove('hidden');
                storePickup.classList.add('hidden');
            }
        }

        // 更新物流資訊
        function updateShippingInfo() {
            if (currentOrder) {
                const courier = document.getElementById('modalCourier').value;
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                
                if (orderIndex !== -1) {
                    orders[orderIndex].courier = courier;
                    
                    // 根據物流方式更新不同資訊
                    if (courier.includes('超商取貨')) {
                        // 超商取貨資訊
                        orders[orderIndex].storeName = document.getElementById('modalStoreName').value;
                        orders[orderIndex].storeAddress = document.getElementById('modalStoreAddress').value;
                        orders[orderIndex].storeCode = document.getElementById('modalStoreCode').value;
                        orders[orderIndex].pickupCode = document.getElementById('modalPickupCode').value;
                        orders[orderIndex].tracking = document.getElementById('modalPickupCode').value; // 使用取貨編號作為追蹤號
                        
                        alert(`✅ 物流資訊已更新\n\n訂單編號: ${currentOrder.id}\n物流方式: ${courier}\n取貨門市: ${orders[orderIndex].storeName}\n取貨編號: ${orders[orderIndex].pickupCode || '未提供'}`);
                    } else {
                        // 宅配到府資訊
                        orders[orderIndex].deliveryAddress = document.getElementById('modalDeliveryAddress').value;
                        orders[orderIndex].tracking = document.getElementById('modalTrackingNumber').value;
                        
                        alert(`✅ 物流資訊已更新\n\n訂單編號: ${currentOrder.id}\n物流方式: ${courier}\n配送地址: ${orders[orderIndex].deliveryAddress}\n追蹤號碼: ${orders[orderIndex].tracking || '未提供'}`);
                    }
                    
                    renderOrders();
                }
            }
        }

        // 更新配送狀態
        function updateDeliveryStatus() {
            if (currentOrder) {
                const deliveryStatus = document.getElementById('modalDeliveryStatus').value;
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].delivery = deliveryStatus;
                    // 更新顯示
                    const paymentBadge = getPaymentBadge(orders[orderIndex].payment);
                    const deliveryBadge = getDeliveryBadge(deliveryStatus);
                    document.getElementById('modalOrderStatus').innerHTML = `${paymentBadge} ${deliveryBadge}`;
                    renderOrders();
                    
                    const statusText = {
                        'preparing': '待出貨',
                        'shipping': '配送中',
                        'arrived': '已到店',
                        'delivered': '已送達/已取貨',
                        'cancelled': '已取消'
                    };
                    alert(`✅ 配送狀態已更新\n\n訂單編號: ${currentOrder.id}\n狀態: ${statusText[deliveryStatus]}`);
                }
            }
        }

        // 查詢物流進度
        function trackShipping() {
            if (currentOrder) {
                const courier = currentOrder.courier || '';
                const tracking = currentOrder.tracking || '';
                
                if (!tracking) {
                    alert('⚠️ 此訂單尚未設定追蹤/取貨編號');
                    return;
                }
                
                let message = `🚚 物流追蹤查詢\n\n訂單編號: ${currentOrder.id}\n物流方式: ${courier}\n`;
                
                if (courier.includes('超商取貨')) {
                    message += `取貨門市: ${currentOrder.storeName || '未設定'}\n取貨編號: ${tracking}\n\n實際應用中這裡會連接到超商物流 API 查詢取貨狀態。`;
                } else {
                    message += `追蹤號碼: ${tracking}\n\n實際應用中這裡會跳轉到物流公司的追蹤頁面。`;
                }
                
                alert(message);
            }
        }

        // 選擇門市
        function selectStore() {
            const courier = document.getElementById('modalCourier').value;
            if (!courier.includes('超商取貨')) {
                alert('⚠️ 請先選擇超商取貨物流方式');
                return;
            }
            openStoreSelectionModal();
        }

        // 打開門市選擇 Modal
        function openStoreSelectionModal() {
            document.getElementById('storeSelectionModal').classList.add('active');
            renderStoreList();
        }

        // 關閉門市選擇 Modal
        function closeStoreSelectionModal() {
            document.getElementById('storeSelectionModal').classList.remove('active');
        }

        // 模擬門市資料
        const mockStores = [
            { id: 1, type: '711', code: '001234', name: '信義威秀門市', address: '台北市信義區松壽路18號', tel: '02-2345-6789' },
            { id: 2, type: '711', code: '002345', name: '台北車站門市', address: '台北市中正區北平西路3號', tel: '02-2345-6790' },
            { id: 3, type: '711', code: '003456', name: '西門町門市', address: '台北市萬華區西寧南路50號', tel: '02-2345-6791' },
            { id: 4, type: '711', code: '004567', name: '南港門市', address: '台北市南港區南港路一段1號', tel: '02-2345-6792' },
            { id: 5, type: '711', code: '005678', name: '內湖門市', address: '台北市內湖區文湖街20號', tel: '02-2345-6793' },
            { id: 6, type: 'family', code: 'FML001', name: '中山旗艦店', address: '台北市中山區中山北路二段100號', tel: '02-2345-6794' },
            { id: 7, type: 'family', code: 'FML002', name: '大安店', address: '台北市大安區復興南路一段200號', tel: '02-2345-6795' },
            { id: 8, type: 'hilife', code: 'HL001', name: '萊爾富信義店', address: '台北市信義區信義路五段1號', tel: '02-2345-6796' }
        ];

        // 渲染門市列表
        function renderStoreList() {
            const storeType = document.querySelector('input[name="storeType"]:checked').value;
            const searchText = document.getElementById('storeSearchInput').value.toLowerCase();
            
            let filteredStores = mockStores.filter(s => s.type === storeType);
            
            if (searchText) {
                filteredStores = filteredStores.filter(s => 
                    s.name.toLowerCase().includes(searchText) ||
                    s.address.toLowerCase().includes(searchText) ||
                    s.code.toLowerCase().includes(searchText)
                );
            }
            
            const container = document.getElementById('storeList');
            
            if (filteredStores.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-store text-4xl mb-3"></i><p>查無門市資料</p></div>';
                return;
            }
            
            container.innerHTML = filteredStores.map(store => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:shadow-md transition cursor-pointer" onclick="chooseStore('${store.code}', '${store.name}', '${store.address}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded ${store.type === '711' ? 'bg-orange-100 text-orange-800' : store.type === 'family' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${store.type === '711' ? '7-11' : store.type === 'family' ? '全家' : '萊爾富'}
                                </span>
                                <span class="text-sm font-semibold text-gray-800">${store.name}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${store.address}</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-barcode text-gray-400 mr-2"></i>門市代碼: ${store.code}</p>
                        </div>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            選擇
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 選擇門市
        function chooseStore(code, name, address) {
            document.getElementById('modalStoreCode').value = code;
            document.getElementById('modalStoreName').value = name;
            document.getElementById('modalStoreAddress').value = address;
            closeStoreSelectionModal();
            alert(`✅ 已選擇門市\n\n門市名稱: ${name}\n門市地址: ${address}\n門市代碼: ${code}`);
        }

        // 搜尋門市
        function searchStores() {
            renderStoreList();
        }

        // 監聽超商類型變更
        document.addEventListener('DOMContentLoaded', function() {
            const storeTypeRadios = document.querySelectorAll('input[name="storeType"]');
            storeTypeRadios.forEach(radio => {
                radio.addEventListener('change', renderStoreList);
            });
        });

        // 更新支付狀態
        function updatePaymentStatus() {
            if (currentOrder) {
                const paymentStatus = document.getElementById('modalPaymentStatus').value;
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].payment = paymentStatus;
                    // 更新顯示
                    const paymentBadge = getPaymentBadge(paymentStatus);
                    const deliveryBadge = getDeliveryBadge(orders[orderIndex].delivery);
                    document.getElementById('modalOrderStatus').innerHTML = `${paymentBadge} ${deliveryBadge}`;
                    renderOrders();
                }
            }
        }

        // 確認付款
        function confirmPayment() {
            if (currentOrder) {
                const transactionId = document.getElementById('modalTransactionId').value;
                const paymentMethod = document.getElementById('modalPaymentMethod').value;
                
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].payment = 'paid';
                    orders[orderIndex].transactionId = transactionId;
                    orders[orderIndex].paymentMethod = paymentMethod;
                    
                    alert(`✅ 付款已確認\n\n訂單編號: ${currentOrder.id}\n付款方式: ${getPaymentMethodName(paymentMethod)}\n交易編號: ${transactionId || '無'}`);
                    
                    // 更新顯示
                    document.getElementById('modalPaymentStatus').value = 'paid';
                    updatePaymentStatus();
                }
            }
        }

        // 處理退款
        function processRefund() {
            if (currentOrder && confirm('確定要處理退款嗎？')) {
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].payment = 'refunded';
                    orders[orderIndex].delivery = 'cancelled';
                    
                    alert(`✅ 退款已處理\n\n訂單編號: ${currentOrder.id}\n退款金額: NT$ ${currentOrder.total}`);
                    
                    renderOrders();
                    closeOrderDetail();
                }
            }
        }

        // 取得付款方式名稱
        function getPaymentMethodName(method) {
            const methods = {
                'credit_card': '信用卡',
                'atm': 'ATM 轉帳',
                'convenience_store': '超商代碼',
                'line_pay': 'LINE Pay',
                'apple_pay': 'Apple Pay',
                'cash_on_delivery': '貨到付款'
            };
            return methods[method] || method;
        }

        // 套用篩選
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const paymentStatus = document.getElementById('paymentStatus').value;
            const deliveryStatus = document.getElementById('deliveryStatus').value;

            let filtered = orders.filter(order => {
                const matchSearch = !search || 
                    order.id.toLowerCase().includes(search) ||
                    order.customer.toLowerCase().includes(search) ||
                    order.phone.includes(search);
                const matchPayment = !paymentStatus || order.payment === paymentStatus;
                const matchDelivery = !deliveryStatus || order.delivery === deliveryStatus;

                return matchSearch && matchPayment && matchDelivery;
            });

            renderOrders(filtered);
        }

        // 重置篩選
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('paymentStatus').value = '';
            document.getElementById('deliveryStatus').value = '';
            document.getElementById('dateRange').value = '';
            renderOrders();
        }

        // 統計卡片點擊功能
        function filterTodayOrders() {
            const today = new Date().toISOString().split('T')[0];
            alert('📅 今日訂單詳情\n\n共 28 筆訂單\n較昨日增加 15.2%\n\n• 已完成: 18 筆\n• 配送中: 7 筆\n• 待出貨: 3 筆\n\n已篩選今日訂單');
            // 實際篩選今日訂單
            const todayOrders = orders.filter(o => o.date.startsWith(today));
            renderOrders(todayOrders.length > 0 ? todayOrders : orders.slice(0, 5));
        }

        function filterPendingOrders() {
            document.getElementById('deliveryStatus').value = 'preparing';
            applyFilters();
            alert('⏳ 待處理訂單\n\n共 15 筆待出貨訂單\n\n請盡快處理以提升客戶滿意度\n\n已篩選待處理訂單');
        }

        function filterTodayRevenue() {
            alert('💰 今日營收詳情\n\n總額: NT$ 48,520\n較昨日增加 12.5%\n\n• 產品銷售: NT$ 42,300\n• 運費收入: NT$ 3,120\n• 其他收入: NT$ 3,100\n\n點擊前往營收報表查看詳細分析');
            // 可選：跳轉到營收報表
            // window.location.href = 'admin-analytics.html';
        }

        function filterMonthlyRevenue() {
            alert('📊 本月營收詳情\n\n總額: NT$ 685,340\n較上月增加 18.7%\n\n• 產品銷售: NT$ 598,450\n• 訂閱服務: NT$ 56,890\n• 運費收入: NT$ 30,000\n\n成長趨勢持續向上！');
        }

        // 更新訂單備註
        function updateOrderNotes() {
            if (currentOrder) {
                const notes = document.getElementById('modalNotes').value.trim();
                const orderIndex = orders.findIndex(o => o.id === currentOrder.id);
                
                if (orderIndex !== -1) {
                    orders[orderIndex].notes = notes || '無特別備註';
                    currentOrder.notes = notes || '無特別備註';
                    
                    alert(`✅ 訂單備註已更新\n\n訂單編號: ${currentOrder.id}\n備註內容: ${notes || '無特別備註'}`);
                    renderOrders();
                }
            }
        }

        // 複製 LINE 連結
        function copyLineLink() {
            const lineUrl = 'https://line.me/R/ti/p/@902rkfzv'; // LINE 官方帳號連結
            
            // 創建臨時輸入框複製連結
            const tempInput = document.createElement('input');
            tempInput.value = lineUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            alert(`✅ LINE 連結已複製到剪貼簿\n\n${lineUrl}\n\n可以直接傳送給客戶！`);
        }

        // 發送 LINE 提醒給客戶
        function sendLineReminder() {
            if (currentOrder) {
                const customerName = currentOrder.customer;
                const customerPhone = currentOrder.phone;
                const customerEmail = currentOrder.email;
                
                alert(`📧 發送 LINE 加好友提醒\n\n收件人: ${customerName}\n電話: ${customerPhone}\nEmail: ${customerEmail}\n\n簡訊內容範例：\n【匠寵】感謝您的訂單！\n請加入我們的 LINE 官方帳號獲得即時客服支援：\nhttps://line.me/R/ti/p/@902rkfzv\nLINE ID: @902rkfzv\n\n或掃描 QR Code 加入\n訂單編號: ${currentOrder.id}\n\n實際應用中會透過簡訊 API 或 Email 發送此提醒。`);
            }
        }

        // 匯出訂單
        function exportOrders() {
            alert('📊 訂單匯出功能\n\n實際應用中會匯出為 Excel 或 CSV 格式，包含以下資訊：\n\n• 訂單編號\n• 訂單時間\n• 客戶資訊\n• 商品明細\n• 付款狀態\n• 配送狀態\n• 物流資訊\n• 追蹤號碼\n• 訂單備註');
        }

        // 批次列印
        function batchPrint() {
            const checkedBoxes = document.querySelectorAll('tbody input[type="checkbox"]:checked');
            if (checkedBoxes.length === 0) {
                alert('⚠️ 請先選擇要列印的訂單');
                return;
            }
            alert(`📄 批次列印功能\n\n已選擇 ${checkedBoxes.length} 筆訂單\n\n實際應用中會批次列印：\n• 出貨單\n• 物流標籤\n• 發票/收據`);
        }

        // 分頁功能
        function previousPage() {
            alert('上一頁功能');
        }

        function nextPage() {
            alert('下一頁功能');
        }

        // 登出
        function logout() {
            localStorage.removeItem('adminUser');
        }

        // 優惠券管理
        let coupons = [];

        async function loadCoupons() {
            try {
                if (window.ApiClient) {
                    const response = await window.ApiClient.getCoupons();
                    if (response.success && response.data) {
                        coupons = response.data.map(coupon => ({
                            ...coupon,
                            startDate: coupon.startDate ? new Date(coupon.startDate).toISOString().split('T')[0] : '',
                            endDate: coupon.endDate ? new Date(coupon.endDate).toISOString().split('T')[0] : '',
                            limit: coupon.limitCount,
                            used: coupon.usedCount
                        }));
                        renderCoupons();
                    }
                } else {
                    console.warn('API 客戶端未載入，使用空列表');
                    coupons = [];
                    renderCoupons();
                }
            } catch (error) {
                console.error('載入優惠券失敗:', error);
                alert('載入優惠券失敗: ' + error.message);
            }
        }

        function openCouponModal() {
            loadCoupons();
            document.getElementById('couponModal').classList.add('active');
        }

        function closeCouponModal() {
            document.getElementById('couponModal').classList.remove('active');
        }

        function openAddCouponModal() {
            document.getElementById('couponForm').reset();
            // 設定預設日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('couponStartDate').value = today;
            document.getElementById('addCouponModal').classList.add('active');
        }

        function closeAddCouponModal() {
            document.getElementById('addCouponModal').classList.remove('active');
        }

        function toggleDiscountInput() {
            const type = document.getElementById('couponType').value;
            const unit = document.getElementById('couponUnit');
            unit.textContent = type === 'percentage' ? '%' : 'NT$';
        }

        function renderCoupons() {
            const couponList = document.getElementById('couponList');
            document.getElementById('couponCount').textContent = coupons.length;
            
            if (coupons.length === 0) {
                couponList.innerHTML = '<div class="col-span-2 text-center py-8 text-gray-500">尚無優惠券</div>';
                return;
            }
            
            couponList.innerHTML = coupons.map(coupon => {
                const statusMap = {
                    'active': { text: '啟用中', class: 'bg-green-100 text-green-800' },
                    'expired': { text: '已過期', class: 'bg-gray-100 text-gray-800' },
                    'disabled': { text: '已停用', class: 'bg-red-100 text-red-800' }
                };
                const status = statusMap[coupon.status] || statusMap['active'];
                
                const discountText = coupon.type === 'percentage' 
                    ? `${coupon.value}% OFF` 
                    : `NT$ ${coupon.value} OFF`;
                
                const limitText = coupon.limitCount 
                    ? `${coupon.usedCount || 0}/${coupon.limitCount} 已使用` 
                    : `${coupon.usedCount || 0} 已使用`;
                
                return `
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 hover:shadow-lg transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h5 class="text-lg font-bold text-gray-800">${coupon.name}</h5>
                                <p class="text-sm text-gray-600 font-mono bg-white px-2 py-1 rounded mt-1 inline-block">${coupon.code}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${status.class}">
                                ${status.text}
                            </span>
                        </div>
                        
                        <div class="bg-white rounded-lg p-3 mb-3">
                            <div class="text-center">
                                <p class="text-3xl font-bold text-purple-600">${discountText}</p>
                                ${coupon.minSpend > 0 ? `<p class="text-xs text-gray-600 mt-1">最低消費 NT$ ${coupon.minSpend}</p>` : ''}
                                ${coupon.maxDiscount ? `<p class="text-xs text-gray-600">最多折 NT$ ${coupon.maxDiscount}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                            <span><i class="fas fa-calendar mr-1"></i>${coupon.startDate} ~ ${coupon.endDate}</span>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm mb-3">
                            <span class="text-gray-600">${limitText}</span>
                            <div class="flex-1 mx-3 bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full" style="width: ${coupon.limitCount ? (coupon.usedCount / coupon.limitCount * 100) : 50}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="editCoupon(${coupon.id})" class="flex-1 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            <button onclick="toggleCoupon(${coupon.id})" class="flex-1 px-3 py-2 ${coupon.status === 'active' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg text-sm">
                                <i class="fas fa-${coupon.status === 'active' ? 'pause' : 'play'} mr-1"></i>${coupon.status === 'active' ? '停用' : '啟用'}
                            </button>
                            <button onclick="deleteCoupon(${coupon.id})" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editCoupon(id) {
            alert(`編輯優惠券 ID: ${id}`);
        }

        function toggleCoupon(id) {
            const coupon = coupons.find(c => c.id === id);
            if (coupon) {
                coupon.status = coupon.status === 'active' ? 'disabled' : 'active';
                renderCoupons();
            }
        }

        function deleteCoupon(id) {
            if (confirm('確定要刪除此優惠券嗎？')) {
                const index = coupons.findIndex(c => c.id === id);
                if (index > -1) {
                    coupons.splice(index, 1);
                    renderCoupons();
                }
            }
        }

        document.getElementById('couponForm').addEventListener('submit', (e) => {
            e.preventDefault();
            alert('優惠券已儲存！');
            closeAddCouponModal();
        });

        // 初始化
        renderOrders();
    </script>
</body>
</html>