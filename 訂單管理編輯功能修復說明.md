# 訂單管理編輯功能修復說明

**修復日期**: 2024-12-28  
**功能**: 後台訂單詳情編輯與前台同步

---

## ✅ 已完成功能

### 1. 後端 API 擴展 ✅

**文件**: `backend/routes/orders.js`

新增 API 端點：
- ✅ `PUT /api/orders/:id` - 更新訂單完整資訊（管理員）
  - 支援更新：收件人資訊、地址、金額、付款狀態、訂單狀態、日期等所有欄位
  - 可部分更新，只更新提供的欄位

**修改的欄位支援**:
- ✅ 收件人資訊：`receiverName`, `receiverPhone`, `receiverEmail`
- ✅ 配送地址：`shippingAddress`, `shippingCity`, `shippingDistrict`, `shippingZipCode`
- ✅ 超商資訊：`shippingStoreName`, `shippingStoreAddress`, `shippingStoreId`
- ✅ 物流資訊：`shippingCourier`, `shippingMethod`
- ✅ 金額資訊：`subtotal`, `shippingFee`, `discount`, `total`
- ✅ 付款資訊：`paymentStatus`, `paymentMethod`
- ✅ 訂單狀態：`status`, `deliveryStatus`
- ✅ 訂單日期：`orderDate`
- ✅ 備註：`notes`

### 2. 後台訂單詳情編輯界面 ✅

**文件**: `admin-orders.html`

#### 新增的編輯功能：

1. **訂單日期編輯**
   - ✅ 添加 `datetime-local` 輸入欄位
   - ✅ 可修改訂單日期和時間
   - ✅ 顯示原始日期供參考

2. **客戶資訊編輯**
   - ✅ 點擊「編輯」按鈕切換編輯模式
   - ✅ 可編輯：姓名、電話、Email
   - ✅ 編輯/顯示模式切換

3. **收件資訊編輯**
   - ✅ 點擊「編輯」按鈕切換編輯模式
   - ✅ 可編輯：收件人姓名、電話
   - ✅ 地址分欄位編輯：縣市、區、郵遞區號、詳細地址

4. **金額資訊編輯**
   - ✅ 點擊「編輯」按鈕切換編輯模式
   - ✅ 可編輯：商品總計、運費、折扣
   - ✅ 總金額自動計算（商品總計 + 運費 - 折扣）

5. **付款管理增強**
   - ✅ 付款狀態選擇：待付款、已付款、已退款
   - ✅ 付款方式選擇：ATM 轉帳、信用卡等
   - ✅ **新增：付款金額欄位**（實際收到金額）
   - ✅ **新增：轉帳後五碼/交易編號欄位**
   - ✅ **新增：付款備註欄位**（記錄付款相關資訊）
   - ✅ 「儲存付款資訊」按鈕
   - ✅ 「確認已付款」按鈕（標記為已付款並記錄轉帳資訊）

6. **物流資訊**
   - ✅ 物流方式選擇（宅配/超商）
   - ✅ 配送狀態選擇
   - ✅ 地址/門市資訊編輯
   - ✅ 追蹤號碼/取貨編號編輯

7. **訂單狀態**
   - ✅ 訂單狀態選擇下拉選單
   - ✅ 即時顯示狀態標籤

8. **儲存所有變更**
   - ✅ 底部固定「儲存所有變更」按鈕
   - ✅ 一鍵保存所有編輯的內容
   - ✅ 自動同步到前台會員中心

### 3. JavaScript 功能實現 ✅

**文件**: `admin-orders.html` (內嵌腳本)

#### 新增/修改的函數：

1. **`viewOrderDetail(orderOrOrderId)`** ✅
   - 支援傳入訂單 ID 或訂單對象
   - 從 API 載入最新訂單資料
   - 適配 API 返回的扁平化資料結構
   - 正確設置所有表單欄位

2. **`saveAllOrderChanges()`** ✅
   - 收集所有編輯欄位的值
   - 調用 `ApiClient.updateOrder()` 保存
   - 顯示成功/失敗通知
   - 重新載入訂單列表和詳情

3. **`savePaymentInfo()`** ✅
   - 單獨保存付款資訊
   - 記錄轉帳後五碼和付款金額
   - 更新付款狀態

4. **`confirmPayment()`** ✅
   - 標記訂單為已付款
   - 記錄轉帳資訊和確認時間
   - 自動更新訂單狀態

5. **`toggleEditMode(mode)`** ✅
   - 切換編輯/顯示模式
   - 支援：customer, recipient, amount 三種模式

6. **`calculateTotal()`** ✅
   - 自動計算訂單總金額
   - 即時更新顯示

7. **`updatePaymentStatus()`** / **`updateDeliveryStatus()`** ✅
   - 即時更新顯示（不自動保存）
   - 需點擊「儲存所有變更」才會保存

8. **`processRefund()`** ✅
   - 處理退款
   - 更新付款狀態為已退款
   - 取消訂單

### 4. ApiClient 擴展 ✅

**文件**: `js/api-client.js`

新增方法：
- ✅ `updateOrder(orderId, orderData)` - 更新訂單完整資訊

### 5. 前台會員中心同步 ✅

**文件**: `member-center.html`

#### 改進：

1. **訂單詳情載入**
   - ✅ `viewOrderDetail()` 從 API 重新載入最新訂單資訊
   - ✅ 確保顯示後台更新後的資料
   - ✅ 適配後端 API 資料結構

2. **訂單詳情顯示**
   - ✅ 正確顯示付款狀態（已付款/待付款）
   - ✅ 顯示付款方式（ATM 轉帳等）
   - ✅ 顯示配送狀態
   - ✅ 顯示訂單備註
   - ✅ 顯示完整的收件人資訊

---

## 🔄 資料同步流程

### 後台更新流程：
```
管理員在後台編輯訂單
    ↓
點擊「儲存所有變更」
    ↓
調用 ApiClient.updateOrder()
    ↓
後端 API: PUT /api/orders/:id
    ↓
更新資料庫
    ↓
返回更新後的訂單資料
    ↓
後台重新載入訂單列表和詳情
```

### 前台同步流程：
```
用戶在會員中心查看訂單
    ↓
點擊「查看詳情」
    ↓
調用 ApiClient.getOrder(orderId)
    ↓
從資料庫獲取最新訂單資料
    ↓
顯示更新後的訂單資訊
```

**關鍵點**：前台每次查看訂單詳情時都會從 API 重新載入，確保顯示最新資料。

---

## 📋 使用說明

### 後台管理員操作流程：

1. **標記付款完成**：
   ```
   1. 開啟訂單詳情
   2. 在「支付管理」區塊：
      - 選擇「付款狀態」為「已付款」
      - 輸入「轉帳後五碼/交易編號」
      - 輸入「付款金額」（實際收到金額）
      - 輸入「付款備註」（可選，例如：用戶於 12/20 完成轉帳，已核對無誤）
   3. 點擊「確認已付款」按鈕
   ```

2. **編輯訂單資訊**：
   ```
   1. 開啟訂單詳情
   2. 點擊要編輯區塊的「編輯」按鈕：
      - 客戶資訊 → 編輯姓名、電話、Email
      - 收件資訊 → 編輯收件人、地址
      - 金額資訊 → 編輯金額（如有調整）
   3. 修改欄位內容
   4. 點擊「儲存所有變更」按鈕
   ```

3. **修改訂單日期**：
   ```
   1. 在訂單詳情頂部的「訂單時間」欄位
   2. 點擊日期輸入框
   3. 選擇新的日期和時間
   4. 點擊「儲存所有變更」
   ```

4. **更新物流資訊**：
   ```
   1. 在「物流資訊」區塊
   2. 選擇物流方式和配送狀態
   3. 輸入地址或門市資訊
   4. 輸入追蹤號碼/取貨編號
   5. 點擊「更新物流資訊」或「儲存所有變更」
   ```

### 前台用戶查看：

- ✅ 用戶在會員中心查看訂單時，會自動顯示後台更新的最新資訊
- ✅ 付款狀態、配送狀態、地址等變更會即時反映
- ✅ 訂單備註也會顯示（如果後台有添加）

---

## 🔍 測試建議

### 1. 付款狀態標記測試
```bash
# 測試步驟：
1. 在前台創建一個訂單（使用 ATM 轉帳）
2. 在後台開啟該訂單詳情
3. 輸入轉帳後五碼：12345
4. 輸入付款金額：1000
5. 點擊「確認已付款」
6. 檢查：
   - 後台訂單列表付款狀態是否變為「已付款」
   - 前台會員中心該訂單付款狀態是否同步更新
```

### 2. 訂單資訊編輯測試
```bash
# 測試步驟：
1. 在後台開啟一個訂單詳情
2. 編輯收件人姓名為「測試修改」
3. 編輯地址為「測試地址 123 號」
4. 修改金額（如有需要）
5. 點擊「儲存所有變更」
6. 檢查：
   - 後台訂單詳情是否顯示更新後的資訊
   - 前台會員中心該訂單是否顯示更新後的資訊
```

### 3. 訂單日期修改測試
```bash
# 測試步驟：
1. 在後台開啟訂單詳情
2. 修改訂單日期為昨天
3. 點擊「儲存所有變更」
4. 檢查訂單日期是否正確更新
```

---

## ⚠️ 注意事項

1. **管理員權限**：
   - 所有訂單編輯功能都需要管理員權限
   - 後端 API 使用 `requireAdmin` 中間件保護

2. **資料驗證**：
   - 後端會驗證必填欄位（如訂單 ID）
   - 金額欄位會自動轉換為數字類型

3. **資料結構適配**：
   - 前端適配了兩種資料結構：
     - API 返回的扁平化結構（receiverName, receiverPhone）
     - 舊版嵌套結構（receiver.name, receiver.phone）
   - 確保向後兼容

4. **錯誤處理**：
   - 所有 API 調用都有 try-catch 錯誤處理
   - 顯示友好的錯誤訊息
   - 提供重新載入選項

5. **付款狀態同步**：
   - 當標記為「已付款」時，會自動設置 `paymentPaidAt` 時間戳
   - 付款資訊會記錄在訂單備註中

---

## 🐛 已知問題與限制

1. **交易編號儲存**：
   - 目前交易編號/轉帳後五碼儲存在訂單備註中
   - 如需單獨欄位，需要後端資料庫擴展

2. **訂單項目編輯**：
   - 目前不支援編輯訂單項目（商品、數量）
   - 如需此功能，需要額外實現

3. **訂單日期變更影響**：
   - 修改訂單日期不會影響訂單項目關聯
   - 僅影響訂單記錄本身

---

## 📝 後續改進建議

1. **添加訂單項目編輯功能**
2. **添加訂單歷史記錄**（記錄誰在什麼時候修改了什麼）
3. **添加批量操作**（批量標記付款、批量更新狀態等）
4. **添加訂單列印功能**
5. **添加訂單匯出功能**（Excel/CSV）

---

**修復完成時間**: 2024-12-28  
**修復人員**: AI Assistant
