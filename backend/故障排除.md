# 服務器啟動故障排除指南

## 常見問題與解決方案

### 1. npm install 權限錯誤

**錯誤訊息：**
```
EPERM: operation not permitted
```

**解決方案：**

**方法 A：使用本地安裝（推薦）**
```bash
# 在 backend 目錄中
npm install --save-dev
```

**方法 B：檢查 npm 權限**
```bash
# 檢查 npm 配置
npm config get prefix

# 如果路徑是 /usr/local，可能需要使用 sudo（不推薦）
# 或者使用 nvm 管理 Node.js 版本
```

**方法 C：使用 yarn（替代方案）**
```bash
# 安裝 yarn
npm install -g yarn

# 使用 yarn 安裝依賴
yarn install
```

### 2. 模組找不到錯誤

**錯誤訊息：**
```
Cannot find module 'xxx'
```

**解決方案：**
```bash
# 確保在 backend 目錄中
cd backend

# 重新安裝依賴
rm -rf node_modules package-lock.json
npm install
```

### 3. 端口被占用

**錯誤訊息：**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解決方案：**

**方法 A：更改端口**
編輯 `.env` 文件：
```
PORT=3001
```

**方法 B：關閉占用端口的進程**
```bash
# macOS/Linux
lsof -ti:3000 | xargs kill -9

# 或使用
killall node
```

### 4. 資料庫錯誤

**錯誤訊息：**
```
SQLITE_CANTOPEN: unable to open database file
```

**解決方案：**
```bash
# 確保資料目錄存在
mkdir -p data

# 重新初始化資料庫
npm run init-db
```

### 5. .env 文件缺失

**解決方案：**
```bash
# 複製範例文件
cp .env.example .env

# 或手動建立 .env 文件，內容：
PORT=3000
NODE_ENV=development
JWT_SECRET=jiangchong-secret-key-2024
JWT_EXPIRE=7d
DB_PATH=./data/jiangchong.db
```

### 6. Node.js 版本過舊

**檢查版本：**
```bash
node --version
```

**需要 Node.js 14+ 版本**

**解決方案：**
```bash
# 使用 nvm 安裝新版本
nvm install 18
nvm use 18
```

### 7. 啟動腳本權限問題

**錯誤訊息：**
```
Permission denied
```

**解決方案：**
```bash
# 給予執行權限
chmod +x 啟動服務器.sh

# 或直接使用 npm
npm start
```

## 手動啟動步驟

如果自動腳本無法運行，請手動執行：

```bash
# 1. 進入後端目錄
cd backend

# 2. 安裝依賴
npm install

# 3. 建立 .env 文件（如果不存在）
cat > .env << EOF
PORT=3000
NODE_ENV=development
JWT_SECRET=jiangchong-secret-key-2024
JWT_EXPIRE=7d
DB_PATH=./data/jiangchong.db
ECPAY_MERCHANT_ID=2000132
ECPAY_HASH_KEY=5294y06JbISpM5x9
ECPAY_HASH_IV=v77hoKGq4kWxNNIS
ECPAY_ENV=development
FRONTEND_URL=http://localhost:5500
EOF

# 4. 建立資料目錄
mkdir -p data

# 5. 初始化資料庫
npm run init-db

# 6. 啟動服務器
npm start
```

## 檢查服務器是否運行

啟動後，在瀏覽器中訪問：
```
http://localhost:3000/health
```

應該看到：
```json
{
  "success": true,
  "message": "服務運行正常",
  "timestamp": "..."
}
```

## 查看詳細錯誤

如果仍有問題，請查看完整錯誤訊息：

```bash
# 使用詳細模式啟動
NODE_ENV=development node server.js

# 或查看日誌
npm start 2>&1 | tee server.log
```

## 聯繫支援

如果以上方法都無法解決，請提供：
1. 完整的錯誤訊息
2. Node.js 版本 (`node --version`)
3. npm 版本 (`npm --version`)
4. 操作系統版本

