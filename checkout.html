<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¸³ - åŒ å¯µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- å…¨å±€é…ç½® -->
    <script src="js/config.js"></script>
    
    <!-- API å®¢æˆ¶ç«¯ (å¾Œç«¯æ•´åˆ) -->
    <script src="js/api-client.js"></script>
    
    <!-- æ•¸æ“šç®¡ç†ç³»çµ± -->
    <script src="js/data-store.js"></script>
    <script src="js/mock-data.js"></script>
    <script src="js/checkout-system.js"></script>
    <script src="js/front-products.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .step-active { background: #E63946; color: white; }
        .step-complete { background: #10B981; color: white; }
        .step-inactive { background: #E5E7EB; color: #9CA3AF; }
    </style>
</head>
<body class="bg-white">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="index.html" class="flex items-center space-x-2">
                    <i class="fas fa-paw text-red-500 text-2xl"></i>
                    <span class="text-xl font-bold">åŒ å¯µ</span>
                </a>
                <div class="text-gray-600">
                    <i class="fas fa-lock mr-2"></i>å®‰å…¨çµå¸³
                </div>
            </div>
        </div>
    </nav>

    <!-- çµå¸³æ­¥é©Ÿ -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
            <div class="flex items-center justify-center mb-8">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full step-complete flex items-center justify-center font-bold">
                            <i class="fas fa-check"></i>
                        </div>
                        <span class="ml-2 text-sm font-medium">è³¼ç‰©è»Š</span>
                    </div>
                    <div class="w-16 h-1 bg-green-500"></div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full step-active flex items-center justify-center font-bold">2</div>
                        <span class="ml-2 text-sm font-medium">é…é€è³‡è¨Š</span>
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full step-inactive flex items-center justify-center font-bold">3</div>
                        <span class="ml-2 text-sm font-medium text-gray-400">ç¢ºèªè¨‚å–®</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- å·¦å´ï¼šé…é€å’Œä»˜æ¬¾è³‡è¨Š -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- æ”¶ä»¶äººè³‡è¨Š -->
                    <div class="bg-white rounded-2xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-user text-red-500 mr-2"></i>æ”¶ä»¶äººè³‡è¨Š
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                                <input type="text" id="receiverName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="è«‹è¼¸å…¥å§“å">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ‰‹æ©Ÿ *</label>
                                <input type="tel" id="receiverPhone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="0912-345-678">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="receiverEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="your@email.com">
                            </div>
                        </div>
                    </div>

                    <!-- é…é€æ–¹å¼ -->
                    <div class="bg-white rounded-2xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-shipping-fast text-red-500 mr-2"></i>é…é€æ–¹å¼
                        </h2>
                        
                        <!-- æ–°ç«¹ç‰©æµ -->
                        <div class="space-y-3">
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition">
                                <input type="radio" name="shippingMethod" value="hsinchu_logistics" onchange="handleShippingMethodChange()" class="mt-1 mr-3">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold text-gray-800">æ–°ç«¹ç‰©æµ</span>
                                        <span class="text-red-600 font-bold">NT$ 120</span>
                                    </div>
                                    <p class="text-sm text-gray-600">æ–°ç«¹ç‰©æµé…é€ï¼Œ3-5 å€‹å·¥ä½œå¤©é€é”</p>
                                    <div id="hsinchuLogisticsOptions" class="mt-4 space-y-3 hidden">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">é…é€åœ°å€ *</label>
                                            <input type="text" id="deliveryAddress" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€">
                                        </div>
                                    </div>
                                </div>
                            </label>

                            <!-- 7-11 è¶…å•†å–è²¨ -->
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition">
                                <input type="radio" name="shippingMethod" value="711_store" checked onchange="handleShippingMethodChange()" class="mt-1 mr-3">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-800">7-11 è¶…å•†å–è²¨</span>
                                            <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">æ¨è–¦</span>
                                        </div>
                                        <span class="text-red-600 font-bold">NT$ 60</span>
                                    </div>
                                    <p class="text-sm text-gray-600">é€è‡³ 7-11 é–€å¸‚ï¼Œ2-3 å€‹å·¥ä½œå¤©åˆ°åº—</p>
                                    <div id="store711Options" class="mt-4 space-y-3" style="display: block;">
                                        <button type="button" onclick="openStoreSelector('711')" class="w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center justify-center">
                                            <i class="fas fa-map-marker-alt mr-2"></i>é¸æ“‡ 7-11 é–€å¸‚
                                        </button>
                                        <div id="selected711Store" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-800" id="store711Name"></p>
                                                    <p class="text-sm text-gray-600 mt-1" id="store711Address"></p>
                                                    <p class="text-xs text-gray-500 mt-1">é–€å¸‚ä»£ç¢¼: <span id="store711Code"></span></p>
                                                </div>
                                                <button type="button" onclick="openStoreSelector('711')" class="text-blue-600 hover:text-blue-800 text-sm">
                                                    è®Šæ›´
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </label>

                            <!-- å…¨å®¶è¶…å•†å–è²¨ -->
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition">
                                <input type="radio" name="shippingMethod" value="family_store" onchange="handleShippingMethodChange()" class="mt-1 mr-3">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold text-gray-800">å…¨å®¶è¶…å•†å–è²¨</span>
                                        <span class="text-red-600 font-bold">NT$ 60</span>
                                    </div>
                                    <p class="text-sm text-gray-600">é€è‡³å…¨å®¶é–€å¸‚ï¼Œ2-3 å€‹å·¥ä½œå¤©åˆ°åº—</p>
                                    <div id="storeFamilyOptions" class="mt-4 space-y-3 hidden">
                                        <button type="button" onclick="openStoreSelector('family')" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center justify-center">
                                            <i class="fas fa-map-marker-alt mr-2"></i>é¸æ“‡å…¨å®¶é–€å¸‚
                                        </button>
                                        <div id="selectedFamilyStore" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-800" id="storeFamilyName"></p>
                                                    <p class="text-sm text-gray-600 mt-1" id="storeFamilyAddress"></p>
                                                    <p class="text-xs text-gray-500 mt-1">é–€å¸‚ä»£ç¢¼: <span id="storeFamilyCode"></span></p>
                                                </div>
                                                <button type="button" onclick="openStoreSelector('family')" class="text-blue-600 hover:text-blue-800 text-sm">
                                                    è®Šæ›´
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- ä»˜æ¬¾æ–¹å¼ -->
                    <div class="bg-white rounded-2xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-credit-card text-red-500 mr-2"></i>ä»˜æ¬¾æ–¹å¼
                        </h2>
                        <p class="text-sm text-gray-600 mb-4">
                            <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                            ç”± <strong>ç¶ ç•Œç§‘æŠ€ ECPay</strong> æä¾›å®‰å…¨é‡‘æµæœå‹™
                        </p>
                        <div class="space-y-3">
                            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition bg-blue-50">
                                <input type="radio" name="paymentMethod" value="Credit" checked class="mr-3">
                                <i class="fas fa-credit-card text-xl text-blue-600 mr-3"></i>
                                <div class="flex-1">
                                    <span class="font-medium">ä¿¡ç”¨å¡</span>
                                    <p class="text-xs text-gray-500">VISAã€MasterCardã€JCB</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- å‚™è¨» -->
                    <div class="bg-white rounded-2xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-comment text-red-500 mr-2"></i>è¨‚å–®å‚™è¨»
                        </h2>
                        <textarea id="orderNotes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="æœ‰ä»€éº¼éœ€è¦æˆ‘å€‘ç‰¹åˆ¥æ³¨æ„çš„å—ï¼Ÿ"></textarea>
                    </div>
                </div>

                <!-- å³å´ï¼šè¨‚å–®æ‘˜è¦ -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-md p-6 sticky top-4">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">è¨‚å–®æ‘˜è¦</h2>
                        
                        <!-- å•†å“åˆ—è¡¨ -->
                        <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="orderItems">
                            <!-- å•†å“é …ç›®å°‡å‹•æ…‹ç”Ÿæˆ -->
                            <div class="flex items-center space-x-3">
                                <img src="https://via.placeholder.com/60" class="w-16 h-16 rounded-lg object-cover">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">é›è‚‰è„†ç‰‡</p>
                                    <p class="text-sm text-gray-600">x 2</p>
                                </div>
                                <p class="font-semibold text-gray-800">NT$ 400</p>
                            </div>
                        </div>

                        <!-- é‡‘é¡æ˜ç´° -->
                        <div class="border-t pt-4 space-y-2">
                            <div class="flex justify-between text-gray-600">
                                <span>å•†å“å°è¨ˆ</span>
                                <span id="subtotal">NT$ 400</span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>é‹è²»</span>
                                <span id="shippingFee">NT$ 60</span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>æŠ˜æ‰£</span>
                                <span id="discount" class="text-red-600">-NT$ 0</span>
                            </div>
                            
                            <!-- å„ªæƒ ç¢¼è¼¸å…¥ -->
                            <div class="pt-4 border-t">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="couponCodeInput" placeholder="è¼¸å…¥å„ªæƒ ç¢¼" 
                                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                                    <button type="button" onclick="applyCouponCode()" 
                                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
                                        å¥—ç”¨
                                    </button>
                                </div>
                                <p id="couponMessage" class="text-xs mt-1"></p>
                                <div id="appliedCoupon" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-green-700">
                                            <i class="fas fa-check-circle mr-1"></i>
                                            <span id="appliedCouponName"></span>
                                        </span>
                                        <button onclick="removeCoupon()" class="text-red-500 hover:text-red-700 text-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between text-xl font-bold text-gray-800 pt-2 border-t">
                                <span>ç¸½è¨ˆ</span>
                                <span id="total" class="text-red-600">NT$ 480</span>
                            </div>
                        </div>

                        <!-- çµå¸³æŒ‰éˆ• -->
                        <button onclick="submitOrder()" class="w-full mt-6 bg-gradient-to-r from-red-500 to-orange-400 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition">
                            ç¢ºèªçµå¸³
                        </button>

                        <div class="mt-4 text-center text-sm text-gray-500">
                            <i class="fas fa-lock mr-1"></i>æ‚¨çš„ä»˜æ¬¾è³‡è¨Šå—åˆ°ä¿è­·
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é–€å¸‚é¸æ“‡ Modalï¼ˆæ•´åˆ Google Mapsï¼‰ -->
    <div id="storeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" onclick="if (window.StoreLocator) window.StoreLocator.closeStoreModal(); else closeStoreModal();">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>é¸æ“‡å–è²¨é–€å¸‚
                </h3>
                <button onclick="if (window.StoreLocator) window.StoreLocator.closeStoreModal(); else closeStoreModal();" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="flex h-[calc(90vh-80px)]">
                <!-- å·¦å´ï¼šåœ°åœ– -->
                <div class="flex-1 border-r">
                    <div id="storeMap" class="w-full h-full" style="min-height: 400px;"></div>
                </div>

                <!-- å³å´ï¼šé–€å¸‚åˆ—è¡¨ -->
                <div class="w-96 flex flex-col">
                    <!-- æœå°‹æ¡† -->
                    <div class="p-4 border-b space-y-3">
                        <div class="flex space-x-2">
                            <input type="text" id="storeSearch" placeholder="è¼¸å…¥åœ°å€æˆ–åœ°æ¨™æœå°‹é™„è¿‘é–€å¸‚..." 
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   onkeypress="if(event.key === 'Enter') { if (window.StoreLocator) { const address = document.getElementById('storeSearch').value; window.StoreLocator.searchStoresByAddressInput(address); } }">
                            <button onclick="if (window.StoreLocator) { const address = document.getElementById('storeSearch').value; window.StoreLocator.searchStoresByAddressInput(address); }" 
                                    class="px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <button onclick="if (window.StoreLocator) { document.getElementById('storeSearch').value = ''; window.StoreLocator.searchNearbyStores(window.StoreLocator.currentStoreType || '711'); }" 
                                class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm">
                            <i class="fas fa-map-marker-alt mr-2"></i>ä½¿ç”¨æˆ‘çš„ä½ç½®
                        </button>
                </div>

                <!-- é–€å¸‚åˆ—è¡¨ -->
                    <div class="flex-1 overflow-y-auto p-4" id="storeList">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentStoreType = '';
        let selectedStores = {
            '711': null,
            'family': null
        };

        // æ¨¡æ“¬é–€å¸‚è³‡æ–™ï¼ˆå‚™ç”¨ï¼‰
        const stores = {
            '711': [
                { code: '001234', name: 'ä¿¡ç¾©å¨ç§€é–€å¸‚', address: 'å°åŒ—å¸‚ä¿¡ç¾©å€æ¾å£½è·¯18è™Ÿ' },
                { code: '002345', name: 'å°åŒ—è»Šç«™é–€å¸‚', address: 'å°åŒ—å¸‚ä¸­æ­£å€åŒ—å¹³è¥¿è·¯3è™Ÿ' },
                { code: '003456', name: 'è¥¿é–€ç”ºé–€å¸‚', address: 'å°åŒ—å¸‚è¬è¯å€è¥¿å¯§å—è·¯50è™Ÿ' }
            ],
            'family': [
                { code: 'FML001', name: 'ä¸­å±±æ——è‰¦åº—', address: 'å°åŒ—å¸‚ä¸­å±±å€ä¸­å±±åŒ—è·¯äºŒæ®µ100è™Ÿ' },
                { code: 'FML002', name: 'å¤§å®‰åº—', address: 'å°åŒ—å¸‚å¤§å®‰å€å¾©èˆˆå—è·¯ä¸€æ®µ200è™Ÿ' }
            ]
        };

        // è™•ç†é…é€æ–¹å¼è®Šæ›´
        function handleShippingMethodChange() {
            const method = document.querySelector('input[name="shippingMethod"]:checked')?.value;
            
            if (!method) return;
            
            // éš±è—æ‰€æœ‰é¸é …
            document.getElementById('hsinchuLogisticsOptions').classList.add('hidden');
            document.getElementById('store711Options').classList.add('hidden');
            document.getElementById('storeFamilyOptions').classList.add('hidden');
            
            // è¨ˆç®—ç•¶å‰å°è¨ˆï¼ˆç”¨æ–¼åˆ¤æ–·æ˜¯å¦å…é‹ï¼‰
            let subtotal = 0;
            let isFreeShipping = false;
            if (window.CheckoutSystem) {
                const totals = window.CheckoutSystem.calculateCartTotal();
                subtotal = totals.subtotal;
                isFreeShipping = totals.isFreeShipping || subtotal >= 1000;
            }
            
            // æ ¹æ“šé…é€æ–¹å¼è¨ˆç®—é‹è²»
            let shippingFee = 0;
            if (!isFreeShipping) {
                if (method === 'hsinchu_logistics') {
                    shippingFee = 120; // æ–°ç«¹ç‰©æµé‹è²»
                } else if (method === '711_store' || method === 'family_store') {
                    shippingFee = 60; // è¶…å•†å–è²¨é‹è²»
                }
            }
            
            // é¡¯ç¤ºå°æ‡‰é¸é …ä¸¦æ›´æ–°é‹è²»
            if (method === 'hsinchu_logistics') {
                document.getElementById('hsinchuLogisticsOptions').classList.remove('hidden');
                updateShippingFee(shippingFee);
            } else if (method === '711_store') {
                document.getElementById('store711Options').classList.remove('hidden');
                updateShippingFee(shippingFee);
            } else if (method === 'family_store') {
                document.getElementById('storeFamilyOptions').classList.remove('hidden');
                updateShippingFee(shippingFee);
            }
        }

        // æ›´æ–°é‹è²»
        function updateShippingFee(fee) {
            const shippingFeeEl = document.getElementById('shippingFee');
            if (shippingFeeEl) {
                shippingFeeEl.textContent = fee === 0 ? 'å…é‹' : `NT$ ${fee}`;
            }
            // æ›´æ–°è¨‚å–®æ‘˜è¦
            if (window.CheckoutSystem) {
                const totals = window.CheckoutSystem.calculateCartTotal();
                updateOrderSummary(totals);
            }
        }

        // è¨ˆç®—ç¸½åƒ¹ï¼ˆå·²å»¢æ£„ï¼Œä½¿ç”¨ CheckoutSystem.calculateCartTotalï¼‰
        function calculateTotal() {
            // ä½¿ç”¨ CheckoutSystem è¨ˆç®—
            if (window.CheckoutSystem) {
                const totals = window.CheckoutSystem.calculateCartTotal();
                updateOrderSummary(totals);
            }
        }
        
        // æ›´æ–°è¨‚å–®æ‘˜è¦é‡‘é¡
        function updateOrderSummary(totals) {
            const subtotalEl = document.getElementById('subtotal');
            const shippingFeeEl = document.getElementById('shippingFee');
            const discountEl = document.getElementById('discount');
            const totalEl = document.getElementById('total');
            
            // ç¢ºä¿é‹è²»æ­£ç¢ºï¼ˆæ»¿1000å…é‹ï¼‰
            if (totals.isFreeShipping) {
                totals.shippingFee = 0;
            }
            
            if (subtotalEl) subtotalEl.textContent = 'NT$ ' + totals.subtotal.toLocaleString();
            if (shippingFeeEl) shippingFeeEl.textContent = totals.shippingFee === 0 ? 'å…é‹' : 'NT$ ' + totals.shippingFee;
            if (discountEl) discountEl.textContent = totals.discount > 0 ? '-NT$ ' + totals.discount.toLocaleString() : '-NT$ 0';
            if (totalEl) totalEl.textContent = 'NT$ ' + totals.total.toLocaleString();
        }

        // æ‰“é–‹é–€å¸‚é¸æ“‡å™¨ï¼ˆä½¿ç”¨æ–°çš„å®šä½ç³»çµ±ï¼‰
        function openStoreSelector(type) {
            console.log('é–‹å•Ÿé–€å¸‚é¸æ“‡å™¨:', type);
            
            // ç¢ºä¿ StoreLocator å·²è¼‰å…¥
            if (window.StoreLocator) {
                console.log('ä½¿ç”¨ StoreLocator é–‹å•Ÿ Modal');
                window.StoreLocator.openStoreModal(type);
            } else {
                console.warn('StoreLocator æœªè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•');
                // å‚™ç”¨æ–¹æ³•ï¼šä½¿ç”¨èˆŠçš„æ¨¡æ“¬è³‡æ–™
            currentStoreType = type;
                const modal = document.getElementById('storeModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
            renderStores();
                } else {
                    console.error('æ‰¾ä¸åˆ° storeModal å…ƒç´ ');
                    alert('é–€å¸‚é¸æ“‡åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
        }

        // é—œé–‰é–€å¸‚é¸æ“‡å™¨
        function closeStoreModal() {
            document.getElementById('storeModal').classList.add('hidden');
            document.getElementById('storeModal').classList.remove('flex');
        }

        // æ¸²æŸ“é–€å¸‚åˆ—è¡¨
        function renderStores() {
            const storeList = stores[currentStoreType];
            const container = document.getElementById('storeList');
            
            container.innerHTML = storeList.map(store => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 hover:shadow-md transition cursor-pointer" onclick="selectStore('${store.code}', '${store.name}', '${store.address}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 mb-1">${store.name}</p>
                            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${store.address}</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-barcode text-gray-400 mr-2"></i>é–€å¸‚ä»£ç¢¼: ${store.code}</p>
                        </div>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            é¸æ“‡
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ç¯©é¸é–€å¸‚
        function filterStores() {
            const search = document.getElementById('storeSearch').value.toLowerCase();
            const storeList = stores[currentStoreType];
            const filtered = storeList.filter(s => 
                s.name.toLowerCase().includes(search) || 
                s.address.toLowerCase().includes(search) ||
                s.code.toLowerCase().includes(search)
            );
            
            const container = document.getElementById('storeList');
            container.innerHTML = filtered.map(store => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 hover:shadow-md transition cursor-pointer" onclick="selectStore('${store.code}', '${store.name}', '${store.address}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 mb-1">${store.name}</p>
                            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${store.address}</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-barcode text-gray-400 mr-2"></i>é–€å¸‚ä»£ç¢¼: ${store.code}</p>
                        </div>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            é¸æ“‡
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // é¸æ“‡é–€å¸‚
        function selectStore(code, name, address) {
            selectedStores[currentStoreType] = { code, name, address };
            
            // æ›´æ–°é¡¯ç¤º
            if (currentStoreType === '711') {
                document.getElementById('store711Code').textContent = code;
                document.getElementById('store711Name').textContent = name;
                document.getElementById('store711Address').textContent = address;
                document.getElementById('selected711Store').classList.remove('hidden');
            } else {
                document.getElementById('storeFamilyCode').textContent = code;
                document.getElementById('storeFamilyName').textContent = name;
                document.getElementById('storeFamilyAddress').textContent = address;
                document.getElementById('selectedFamilyStore').classList.remove('hidden');
            }
            
            closeStoreModal();
        }

        // æäº¤è¨‚å–®
        async function submitOrder() {
            const name = document.getElementById('receiverName').value.trim();
            const phone = document.getElementById('receiverPhone').value.trim();
            const email = document.getElementById('receiverEmail').value.trim();
            const shippingMethod = document.querySelector('input[name="shippingMethod"]:checked')?.value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            
            // åŸºæœ¬é©—è­‰
            if (!name || !phone) {
                alert('è«‹å¡«å¯«æ”¶ä»¶äººå§“åå’Œæ‰‹æ©Ÿè™Ÿç¢¼');
                return;
            }
            
            // é©—è­‰æ‰‹æ©Ÿæ ¼å¼
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone.replace(/-/g, ''))) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ (ä¾‹ï¼š0912-345-678)');
                return;
            }
            
            if (!shippingMethod) {
                alert('è«‹é¸æ“‡é…é€æ–¹å¼');
                return;
            }
            
            if (!paymentMethod) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼');
                return;
            }
            
            // å»ºç«‹è¡¨å–®è³‡æ–™
            const formData = {
                receiverName: name,
                receiverPhone: phone,
                receiverEmail: email,
                shippingMethod: shippingMethod,
                paymentMethod: paymentMethod,
                notes: document.getElementById('orderNotes')?.value.trim() || ''
            };
            
            // æ ¹æ“šé…é€æ–¹å¼æ”¶é›†ä¸åŒçš„è³‡è¨Š
            if (shippingMethod === 'hsinchu_logistics') {
                const address = document.getElementById('deliveryAddress').value.trim();
                
                if (!address) {
                    alert('è«‹å¡«å¯«é…é€åœ°å€');
                    return;
                }
                
                if (address.length < 10) {
                    alert('è«‹è¼¸å…¥å®Œæ•´çš„é…é€åœ°å€ (åŒ…å«ç¸£å¸‚ã€å€åŸŸã€è¡—é“ã€é–€ç‰Œè™Ÿ)');
                    return;
                }
                
                formData.courier = 'æ–°ç«¹ç‰©æµ';
                formData.address = address;
                
                // è§£æåœ°å€
                const cityMatch = address.match(/(å°åŒ—å¸‚|æ–°åŒ—å¸‚|æ¡ƒåœ’å¸‚|å°ä¸­å¸‚|å°å—å¸‚|é«˜é›„å¸‚|åŸºéš†å¸‚|æ–°ç«¹å¸‚|å˜‰ç¾©å¸‚|æ–°ç«¹ç¸£|è‹—æ —ç¸£|å½°åŒ–ç¸£|å—æŠ•ç¸£|é›²æ—ç¸£|å˜‰ç¾©ç¸£|å±æ±ç¸£|å®œè˜­ç¸£|èŠ±è“®ç¸£|å°æ±ç¸£|æ¾æ¹–ç¸£|é‡‘é–€ç¸£|é€£æ±Ÿç¸£)/);
                const districtMatch = address.match(/([^å¸‚ç¸£]+(å€|é®|é„‰|å¸‚))/);
                
                if (cityMatch) formData.city = cityMatch[1];
                if (districtMatch) formData.district = districtMatch[1];
                
            } else if (shippingMethod === '711_store') {
                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ StoreLocator é¸æ“‡çš„é–€å¸‚
                const store = window.selectedStores && window.selectedStores['711'] 
                    ? window.selectedStores['711'] 
                    : selectedStores['711'];
                
                if (!store) {
                    alert('è«‹é¸æ“‡ 7-11 å–è²¨é–€å¸‚');
                    return;
                }
                
                formData.storeId = store.code;
                formData.storeName = store.name;
                formData.storeAddress = store.address;
                
            } else if (shippingMethod === 'family_store') {
                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ StoreLocator é¸æ“‡çš„é–€å¸‚
                const store = window.selectedStores && window.selectedStores['family'] 
                    ? window.selectedStores['family'] 
                    : selectedStores['family'];
                
                if (!store) {
                    alert('è«‹é¸æ“‡å…¨å®¶å–è²¨é–€å¸‚');
                    return;
                }
                
                formData.storeId = store.code;
                formData.storeName = store.name;
                formData.storeAddress = store.address;
            }
            
            // ä½¿ç”¨ CheckoutSystem æäº¤è¨‚å–®
            if (!window.CheckoutSystem) {
                alert('ç³»çµ±å°šæœªå®Œå…¨è¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const submitBtn = document.querySelector('button[onclick="submitOrder()"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'è™•ç†ä¸­...';
            
            try {
                const savedOrder = await window.CheckoutSystem.submitCheckoutOrder(formData);
            
            if (!savedOrder) {
                alert('è¨‚å–®å»ºç«‹å¤±æ•—ï¼Œè«‹é‡è©¦');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                return;
            }
            
            console.log('âœ… è¨‚å–®å·²å»ºç«‹:', savedOrder);
            
            // å„²å­˜è¨‚å–® ID åˆ° localStorage
            localStorage.setItem('lastOrderId', savedOrder.id);
            
                // è¨‚å–®å»ºç«‹æˆåŠŸï¼Œç³»çµ±æœƒè‡ªå‹•è·³è½‰ï¼ˆç”± submitCheckoutOrder è™•ç†ï¼‰
                // å¦‚æœæ˜¯ç¶ ç•Œä»˜æ¬¾ï¼Œæœƒè·³è½‰åˆ°ç¶ ç•Œæ”¯ä»˜é é¢
                // å¦‚æœæ˜¯å…¶ä»–ä»˜æ¬¾æ–¹å¼ï¼Œæœƒè·³è½‰åˆ°è¨‚å–®æˆåŠŸé 
                    
                } catch (error) {
                console.error('âŒ è¨‚å–®æäº¤å¤±æ•—:', error);
                alert('è¨‚å–®æäº¤å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // ç¢ºä¿ submitOrder å‡½æ•¸æš´éœ²åˆ°å…¨å±€
        window.submitOrder = submitOrder;
        
        // å–å¾—ä»˜æ¬¾æ–¹å¼åç¨±
        function getPaymentMethodName(method) {
            const names = {
                'credit_card': 'ä¿¡ç”¨å¡',
                'atm': 'ATM è½‰å¸³',
                'convenience_store': 'è¶…å•†ä»£ç¢¼ç¹³è²»',
                'cash_on_delivery': 'è²¨åˆ°ä»˜æ¬¾'
            };
            return names[method] || method;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ çµå¸³é é¢åˆå§‹åŒ–é–‹å§‹...');
            
            // åˆå§‹åŒ– selectedStores åˆ°å…¨åŸŸ
            if (!window.selectedStores) {
                window.selectedStores = {
                    '711': null,
                    'family': null
                };
            }
            
            // åˆå§‹åŒ–é…é€æ–¹å¼
            setTimeout(() => {
            handleShippingMethodChange();
                console.log('âœ… é…é€æ–¹å¼å·²åˆå§‹åŒ–');
            }, 100);
            
            // åˆå§‹åŒ–è³¼ç‰©è»Šç³»çµ±
            setTimeout(() => {
                if (window.CheckoutSystem) {
                    // æ¸²æŸ“è¨‚å–®é …ç›®ï¼ˆä½¿ç”¨ç°¡åŒ–ç‰ˆæœ¬ï¼Œåªåœ¨æ‘˜è¦é¡¯ç¤ºï¼‰
                    renderOrderSummary();
                    console.log('âœ… çµå¸³ç³»çµ±å·²åˆå§‹åŒ–');
                } else {
                    console.warn('âš ï¸ CheckoutSystem æ¨¡çµ„å°šæœªè¼‰å…¥');
                }
            }, 500);
            
            // ç¢ºä¿å„ªæƒ ç¢¼å‡½æ•¸å¯ç”¨
            window.applyCouponCode = async function() {
                if (window.CheckoutSystem && typeof window.CheckoutSystem.applyCouponCode === 'function') {
                    await window.CheckoutSystem.applyCouponCode();
                    // é‡æ–°è¨ˆç®—ä¸¦æ›´æ–°æ‘˜è¦
                    const totals = window.CheckoutSystem.calculateCartTotal();
                    updateOrderSummary(totals);
                } else {
                    // ç›´æ¥èª¿ç”¨ checkout-system.js ä¸­çš„å‡½æ•¸
                    if (typeof applyCouponCode === 'function') {
                        await applyCouponCode();
                        const totals = window.CheckoutSystem.calculateCartTotal();
                        updateOrderSummary(totals);
                    }
                }
            };
            
            window.removeCoupon = function() {
                if (window.CheckoutSystem && typeof window.CheckoutSystem.removeCoupon === 'function') {
                    window.CheckoutSystem.removeCoupon();
                } else if (typeof removeCoupon === 'function') {
                    removeCoupon();
                }
                // é‡æ–°è¨ˆç®—ä¸¦æ›´æ–°æ‘˜è¦
                const totals = window.CheckoutSystem.calculateCartTotal();
                updateOrderSummary(totals);
            };
        });
        
        // æ¸²æŸ“è¨‚å–®æ‘˜è¦
        function renderOrderSummary() {
            const cart = window.CheckoutSystem.getCart();
            const orderItemsContainer = document.getElementById('orderItems');
            
            if (cart.length === 0) {
                orderItemsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                        <a href="index.html" class="inline-block mt-4 px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            è¿”å›é¦–é é¸è³¼
                        </a>
                    </div>
                `;
                return;
            }
            
            // æ¸²æŸ“å•†å“åˆ—è¡¨
            orderItemsContainer.innerHTML = cart.map(item => `
                <div class="flex items-center space-x-3">
                    ${item.imageUrl ? 
                        `<img src="${item.imageUrl}" class="w-16 h-16 rounded-lg object-cover">` :
                        `<div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                            <i class="fas fa-image text-gray-400"></i>
                        </div>`
                    }
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-600">x ${item.quantity}</p>
                    </div>
                    <p class="font-semibold text-gray-800">NT$ ${(item.price * item.quantity).toLocaleString()}</p>
                </div>
            `).join('');
            
            // æ›´æ–°é‡‘é¡
            const totals = window.CheckoutSystem.calculateCartTotal();
            updateOrderSummary(totals);
        }
        
        // ç›£è½é‹è²»è®Šæ›´ï¼Œæ›´æ–°ç¸½é¡
        function handleShippingFeeChange() {
            if (window.CheckoutSystem) {
                const totals = window.CheckoutSystem.calculateCartTotal();
                
                // å¦‚æœå°è¨ˆ >= 1000ï¼Œå¼·åˆ¶å…é‹ï¼ˆç„¡è«–é¸æ“‡ä»€éº¼é…é€æ–¹å¼ï¼‰
                if (totals.isFreeShipping) {
                    totals.shippingFee = 0;
                }
                
                // æ›´æ–°è¨‚å–®æ‘˜è¦
                updateOrderSummary(totals);
            }
        }
    </script>
    
    <!-- Store Locator System -->
    <script src="js/store-locator.js"></script>
    
    <!-- Shipping Sync System -->
    <script src="js/shipping-sync.js"></script>
    
    <!-- ECPay Payment Integration -->
    <script src="js/ecpay-payment.js"></script>
</body>
</html>
