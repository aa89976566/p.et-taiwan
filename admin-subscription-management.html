<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚é–±ç®¡ç† - åŒ å¯µå¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .tab-button.active {
            background-color: #FF6B6B;
            color: white;
        }
        #detail-modal {
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- å¾Œå°å°èˆª -->
    <nav class="bg-gray-900 text-white p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">åŒ å¯µå¾Œå°ç®¡ç†ç³»çµ±</h1>
            <div class="flex gap-4">
                <a href="admin-dashboard.html" class="hover:text-gray-300">å„€è¡¨æ¿</a>
                <a href="admin-subscription-management.html" class="text-yellow-400">è¨‚é–±ç®¡ç†</a>
                <a href="admin-users.html" class="hover:text-gray-300">æœƒå“¡ç®¡ç†</a>
                <a href="admin-orders.html" class="hover:text-gray-300">è¨‚å–®ç®¡ç†</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- é é¢æ¨™é¡Œ -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-black mb-2">è¨‚é–±ç®¡ç†</h2>
                <p class="text-gray-600">ç®¡ç†æ‰€æœ‰æœƒå“¡è¨‚é–±è³‡æ–™</p>
            </div>
            <div class="flex gap-2">
                <button onclick="refreshData()" class="bg-gray-500 text-white px-6 py-3 rounded font-bold hover:bg-gray-600">
                    ğŸ”„ é‡æ–°è¼‰å…¥
                </button>
                <button onclick="exportData('csv')" class="bg-green-500 text-white px-6 py-3 rounded font-bold hover:bg-green-600">
                    ğŸ“¥ åŒ¯å‡º CSV
                </button>
                <button onclick="exportData('excel')" class="bg-blue-500 text-white px-6 py-3 rounded font-bold hover:bg-blue-600">
                    ğŸ“¥ åŒ¯å‡º Excel
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-2">æ´»èºè¨‚é–±</div>
                <div class="text-3xl font-black text-green-600" id="stat-active">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-2">æš«åœè¨‚é–±</div>
                <div class="text-3xl font-black text-yellow-600" id="stat-paused">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-2">å·²å–æ¶ˆ</div>
                <div class="text-3xl font-black text-red-600" id="stat-cancelled">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-2">ç¸½è¨‚é–±æ•¸</div>
                <div class="text-3xl font-black text-blue-600" id="stat-total">0</div>
            </div>
        </div>

        <!-- ç¯©é¸å™¨ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">è¨‚é–±ç‹€æ…‹</label>
                    <select id="filter-status" class="w-full border-2 border-gray-200 rounded px-4 py-2" onchange="filterSubscriptions()">
                        <option value="">å…¨éƒ¨</option>
                        <option value="active">é€²è¡Œä¸­</option>
                        <option value="paused">å·²æš«åœ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                        <option value="pending">å¾…ä»˜æ¬¾</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">è¨‚é–±æ–¹æ¡ˆ</label>
                    <select id="filter-plan" class="w-full border-2 border-gray-200 rounded px-4 py-2" onchange="filterSubscriptions()">
                        <option value="">å…¨éƒ¨</option>
                        <option value="small">å°é£Ÿçµ„</option>
                        <option value="standard">æ¨™æº–çµ„</option>
                        <option value="premium">è±ªè¯çµ„</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">æœå°‹</label>
                    <input type="text" id="search-input" class="w-full border-2 border-gray-200 rounded px-4 py-2" placeholder="æœƒå“¡å§“åæˆ–Email" oninput="filterSubscriptions()">
                </div>
                <div class="flex items-end">
                    <button onclick="resetFilters()" class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded font-bold hover:bg-gray-300">
                        é‡ç½®ç¯©é¸
                    </button>
                </div>
            </div>
        </div>

        <!-- è¨‚é–±åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b-2">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">è¨‚å–®ç·¨è™Ÿ</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">æœƒå“¡</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">æ–¹æ¡ˆ</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">è›‹ç™½è³ª</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">è”¬æœ</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">å‡ä¹¾ç²‰</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">ç‹€æ…‹</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">ä¸‹æ¬¡é…é€</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="subscription-list">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é  -->
            <div class="px-6 py-4 border-t flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    é¡¯ç¤º <span id="showing-start">1</span> åˆ° <span id="showing-end">10</span>ï¼Œå…± <span id="total-count">0</span> ç­†
                </div>
                <div class="flex gap-2">
                    <button onclick="previousPage()" class="px-4 py-2 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="prev-btn">ä¸Šä¸€é </button>
                    <button onclick="nextPage()" class="px-4 py-2 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="next-btn">ä¸‹ä¸€é </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨‚é–±è©³æƒ… Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center" style="z-index: 1000;">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-2xl font-black">è¨‚é–±è©³æƒ…</h3>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="detail-content" class="p-6">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬æ•¸æ“šï¼ˆå¯¦éš›æ‡‰å¾APIè®€å–ï¼‰
        let subscriptionsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [];

        // åˆå§‹åŒ–ç¯„ä¾‹æ•¸æ“š
        function initSampleData() {
            // å¾ localStorage è®€å–è¨‚é–±è³‡æ–™ï¼ˆç”±å‰å°è¨‚é–±é é¢æäº¤ï¼‰
            const savedSubscriptions = localStorage.getItem('subscriptions');
            if (savedSubscriptions) {
                try {
                    subscriptionsData = JSON.parse(savedSubscriptions);
                    console.log('âœ… å¾ localStorage è¼‰å…¥è¨‚é–±è³‡æ–™:', subscriptionsData.length, 'ç­†');
                } catch (e) {
                    console.error('è®€å–è¨‚é–±è³‡æ–™å¤±æ•—:', e);
                    subscriptionsData = [];
                }
            } else {
                console.log('â„¹ï¸ localStorage ä¸­æ²’æœ‰è¨‚é–±è³‡æ–™');
            }

            // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œç”Ÿæˆç¯„ä¾‹æ•¸æ“šï¼ˆåƒ…ä¾›æ¸¬è©¦ï¼‰
            if (subscriptionsData.length === 0) {
                console.log('â„¹ï¸ ä½¿ç”¨ç¯„ä¾‹è³‡æ–™ï¼ˆåƒ…ä¾›æ¸¬è©¦ï¼‰');
                const plans = ['small', 'standard', 'premium'];
                const planNames = { small: 'å°é£Ÿçµ„', standard: 'æ¨™æº–çµ„', premium: 'è±ªè¯çµ„' };
                const statuses = ['active', 'paused', 'cancelled'];
                const statusNames = { active: 'é€²è¡Œä¸­', paused: 'å·²æš«åœ', cancelled: 'å·²å–æ¶ˆ' };
                const proteins = ['ç‰›è‚‰ç³»åˆ—', 'é›è‚‰ç³»åˆ—', 'é´¨è‚‰ç³»åˆ—', 'å°é­šä¹¾'];
                const veggies = ['ç¯€ç“œå‡ä¹¾', 'å—ç“œå‡ä¹¾', 'åœ°ç“œå‡ä¹¾', 'èƒ¡è˜¿è””å‡ä¹¾'];
                const powders = ['ç‰›è…±è‚‰å‡ä¹¾ç²‰', 'é›è‚‰é›è‚å‡ä¹¾ç²‰', 'é´¨è‚‰å‡ä¹¾ç²‰'];

                // ç”Ÿæˆ20ç­†ç¯„ä¾‹æ•¸æ“š
                for (let i = 1; i <= 20; i++) {
                    const plan = plans[Math.floor(Math.random() * plans.length)];
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    
                    subscriptionsData.push({
                        id: `SUB${String(i).padStart(6, '0')}`,
                        user: {
                            id: `USER${String(i).padStart(6, '0')}`,
                            name: `æœƒå“¡${i}`,
                            email: `user${i}@example.com`,
                            phone: `0912-345-${String(i).padStart(3, '0')}`
                        },
                        plan: plan,
                        planName: planNames[plan],
                        protein: proteins[Math.floor(Math.random() * proteins.length)],
                        veggie: veggies[Math.floor(Math.random() * veggies.length)],
                        powder: powders[Math.floor(Math.random() * powders.length)],
                        status: status,
                        statusName: statusNames[status],
                        startDate: new Date(2024, 0, i).toISOString().split('T')[0],
                        nextDeliveryDate: new Date(2024, 11, i + 10).toISOString().split('T')[0],
                        createdAt: new Date(2024, 0, i).toISOString()
                    });
                }
            }

            filteredData = [...subscriptionsData];
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const active = subscriptionsData.filter(s => s.status === 'active').length;
            const paused = subscriptionsData.filter(s => s.status === 'paused').length;
            const cancelled = subscriptionsData.filter(s => s.status === 'cancelled').length;
            
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-paused').textContent = paused;
            document.getElementById('stat-cancelled').textContent = cancelled;
            document.getElementById('stat-total').textContent = subscriptionsData.length;
        }

        // æ¸²æŸ“è¨‚é–±åˆ—è¡¨
        function renderSubscriptions() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const tbody = document.getElementById('subscription-list');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                            æ²’æœ‰æ‰¾åˆ°è¨‚é–±è³‡æ–™
                        </td>
                    </tr>
                `;
                return;
            }

            pageData.forEach((sub, index) => {
                const statusColor = {
                    'active': 'bg-green-100 text-green-800',
                    'paused': 'bg-yellow-100 text-yellow-800',
                    'cancelled': 'bg-red-100 text-red-800',
                    'pending': 'bg-gray-100 text-gray-800'
                };

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                // ä½¿ç”¨ data å±¬æ€§å„²å­˜è¨‚é–±è³‡æ–™ï¼Œé¿å… onclick ä¸­çš„ JSON å•é¡Œ
                const subDataId = `sub-${start + index}`;
                window[`subscriptionData_${subDataId}`] = sub;
                
                // å®‰å…¨å–å¾—è³‡æ–™ï¼ˆè™•ç†å¯èƒ½çš„åµŒå¥—çµæ§‹ï¼‰
                const userName = sub.user?.name || '-';
                const userEmail = sub.user?.email || '-';
                const planName = sub.planName || sub.subscription?.planName || '-';
                const protein = sub.protein || sub.subscription?.proteinName || '-';
                const veggie = sub.veggie || sub.subscription?.veggieName || '-';
                const powder = sub.powder || sub.subscription?.powderName || '-';
                const status = sub.status || 'pending';
                const statusName = sub.statusName || (status === 'pending' ? 'å¾…ä»˜æ¬¾' : status);
                
                // å–å¾—è¨‚å–®ç·¨è™Ÿï¼ˆå„ªå…ˆä½¿ç”¨ orderIdï¼Œå¦å‰‡ä½¿ç”¨ idï¼‰
                const orderId = sub.orderId || sub.id || '-';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-mono font-bold">${orderId}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium">${userName}</div>
                        <div class="text-sm text-gray-500">${userEmail}</div>
                    </td>
                    <td class="px-6 py-4 font-medium">${planName}</td>
                    <td class="px-6 py-4 text-sm">${protein}</td>
                    <td class="px-6 py-4 text-sm">${veggie}</td>
                    <td class="px-6 py-4 text-sm">${powder}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${statusColor[status] || 'bg-gray-100 text-gray-800'}">
                            ${statusName}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">${sub.nextDeliveryDate || '-'}</td>
                    <td class="px-6 py-4">
                        <button onclick='viewDetailByDataId("${subDataId}")' class="text-blue-600 hover:text-blue-800 font-medium">
                            æŸ¥çœ‹
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // æ›´æ–°åˆ†é è³‡è¨Š
            document.getElementById('showing-start').textContent = filteredData.length > 0 ? start + 1 : 0;
            document.getElementById('showing-end').textContent = Math.min(end, filteredData.length);
            document.getElementById('total-count').textContent = filteredData.length;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = end >= filteredData.length;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // é€é data ID æŸ¥çœ‹è©³æƒ…
        function viewDetailByDataId(dataId) {
            const subscription = window[`subscriptionData_${dataId}`];
            if (subscription) {
                viewDetail(subscription);
            }
        }

        // ç¯©é¸è¨‚é–±
        function filterSubscriptions() {
            const status = document.getElementById('filter-status').value;
            const plan = document.getElementById('filter-plan').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            filteredData = subscriptionsData.filter(sub => {
                const matchStatus = !status || sub.status === status;
                const matchPlan = !plan || sub.plan === plan;
                const matchSearch = !search || 
                    (sub.user && (
                        (sub.user.name && sub.user.name.toLowerCase().includes(search)) ||
                        (sub.user.email && sub.user.email.toLowerCase().includes(search))
                    ));
                
                return matchStatus && matchPlan && matchSearch;
            });

            currentPage = 1;
            renderSubscriptions();
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-plan').value = '';
            document.getElementById('search-input').value = '';
            filterSubscriptions();
        }

        // åˆ†é 
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderSubscriptions();
            }
        }

        function nextPage() {
            const maxPage = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                renderSubscriptions();
            }
        }

        // æŸ¥çœ‹è©³æƒ…
        function viewDetail(subscription) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            
            // è™•ç†é…é€è³‡è¨Šé¡¯ç¤º
            let deliveryInfoHTML = '';
            if (subscription.delivery) {
                const delivery = subscription.delivery;
                if (delivery.method === 'home') {
                    // å®…é…åˆ°åºœ
                    deliveryInfoHTML = `
                        <div class="border-t pt-6">
                            <h4 class="text-lg font-bold mb-4">ğŸ  é…é€è³‡è¨Šï¼ˆå®…é…åˆ°åºœï¼‰</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-500">æ”¶ä»¶äºº</div>
                                    <div class="font-medium">${delivery.recipientName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">è¯çµ¡é›»è©±</div>
                                    <div class="font-medium">${delivery.phone || '-'}</div>
                                </div>
                                <div class="col-span-2">
                                    <div class="text-sm text-gray-500">é…é€åœ°å€</div>
                                    <div class="font-medium">
                                        ${delivery.postalCode || ''} ${delivery.city || ''} ${delivery.district || ''} ${delivery.address || ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">é‹è²»</div>
                                    <div class="font-medium text-orange-600">$${delivery.shippingFee || 0}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (delivery.method === '711') {
                    // 7-11 è¶…å•†å–è²¨
                    deliveryInfoHTML = `
                        <div class="border-t pt-6">
                            <h4 class="text-lg font-bold mb-4">ğŸª é…é€è³‡è¨Šï¼ˆ7-11 è¶…å•†å–è²¨ï¼‰</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-500">æ”¶ä»¶äºº</div>
                                    <div class="font-medium">${delivery.recipientName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">è¯çµ¡é›»è©±</div>
                                    <div class="font-medium">${delivery.phone || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">é–€å¸‚åç¨±</div>
                                    <div class="font-medium">${delivery.storeName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">é–€å¸‚ä»£è™Ÿ</div>
                                    <div class="font-medium">${delivery.storeCode || '-'}</div>
                                </div>
                                <div class="col-span-2">
                                    <div class="text-sm text-gray-500">é–€å¸‚åœ°å€</div>
                                    <div class="font-medium">
                                        ${delivery.storeCity || ''} ${delivery.storeDistrict || ''} ${delivery.storeAddress || ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">é‹è²»</div>
                                    <div class="font-medium text-green-600">å…é‹è²»</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            const userInfo = subscription.user || {};
            const subscriptionInfo = subscription.subscription || {};
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-bold mb-4">åŸºæœ¬è³‡è¨Š</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-500">è¨‚å–®ç·¨è™Ÿ</div>
                                <div class="font-medium font-mono font-bold">${subscription.orderId || subscription.id || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">è¨‚é–±ç‹€æ…‹</div>
                                <div class="font-medium">${subscription.statusName || subscription.status || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">è¨‚é–±æ–¹æ¡ˆ</div>
                                <div class="font-medium">${subscription.planName || subscriptionInfo.planName || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">é–‹å§‹æ—¥æœŸ</div>
                                <div class="font-medium">${subscription.startDate || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">ä¸‹æ¬¡é…é€</div>
                                <div class="font-medium">${subscription.nextDeliveryDate || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">å»ºç«‹æ™‚é–“</div>
                                <div class="font-medium">${subscription.createdAt ? new Date(subscription.createdAt).toLocaleString('zh-TW') : '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <h4 class="text-lg font-bold mb-4">æœƒå“¡è³‡è¨Š</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-500">æœƒå“¡å§“å</div>
                                <div class="font-medium">${userInfo.name || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Email</div>
                                <div class="font-medium">${userInfo.email || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">é›»è©±</div>
                                <div class="font-medium">${userInfo.phone || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">æœƒå“¡ID</div>
                                <div class="font-medium">${userInfo.id || userInfo.userId || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <h4 class="text-lg font-bold mb-4">è¨‚é–±å…§å®¹</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">è›‹ç™½è³ªï¼š</span>
                                <span class="font-medium">${subscription.protein || subscriptionInfo.proteinName || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">è”¬æœå‡ä¹¾ï¼š</span>
                                <span class="font-medium">${subscription.veggie || subscriptionInfo.veggieName || '-'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">å‡ä¹¾ç²‰ï¼š</span>
                                <span class="font-medium">${subscription.powder || subscriptionInfo.powderName || '-'}</span>
                            </div>
                            ${subscription.pricing ? `
                            <div class="border-t pt-3 mt-3">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">è¨‚é–±é‡‘é¡ï¼š</span>
                                    <span class="font-medium">$${subscription.pricing.subtotal || subscriptionInfo.price || 0}</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">é‹è²»ï¼š</span>
                                    <span class="font-medium">$${subscription.pricing.shippingFee || 0}</span>
                                </div>
                                <div class="flex justify-between text-lg font-bold border-t pt-2">
                                    <span>ç¸½è¨ˆï¼š</span>
                                    <span class="text-red-600">$${subscription.pricing.total || 0}</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    ${deliveryInfoHTML}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDetailModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('detail-modal');
            if (e.target === modal) {
                closeDetailModal();
            }
        });

        // åŒ¯å‡ºæ•¸æ“š
        function exportData(format) {
            if (format === 'csv') {
                exportCSV();
            } else if (format === 'excel') {
                exportExcel();
            }
        }

        function exportCSV() {
            const headers = [
                'è¨‚å–®ç·¨è™Ÿ', 'æœƒå“¡å§“å', 'Email', 'é›»è©±', 'æ–¹æ¡ˆåç¨±', 
                'è›‹ç™½è³ª', 'è”¬æœå‡ä¹¾', 'å‡ä¹¾ç²‰', 'ç‹€æ…‹', 
                'é…é€æ–¹å¼', 'é…é€åœ°å€/é–€å¸‚åç¨±', 'é–€å¸‚ä»£è™Ÿ', 'é‹è²»',
                'é–‹å§‹æ—¥æœŸ', 'ä¸‹æ¬¡é…é€', 'å»ºç«‹æ™‚é–“'
            ];
            
            const rows = filteredData.map(sub => {
                // è™•ç†é…é€è³‡è¨Š
                let shippingMethod = '-';
                let shippingAddress = '';
                let storeCode = '';
                let shippingFee = 0;

                if (sub.delivery) {
                    shippingMethod = sub.delivery.method === 'home' ? 'å®…é…åˆ°åºœ' : '7-11è¶…å•†å–è²¨';
                    shippingFee = sub.delivery.shippingFee || 0;

                    if (sub.delivery.method === 'home') {
                        // å®…é…åœ°å€
                        shippingAddress = `${sub.delivery.city || ''} ${sub.delivery.district || ''} ${sub.delivery.address || ''}`;
                    } else if (sub.delivery.method === '711') {
                        // è¶…å•†é–€å¸‚
                        shippingAddress = sub.delivery.storeName || '';
                        storeCode = sub.delivery.storeCode || '';
                    }
                }

                return [
                    sub.id || '-',
                    sub.user?.name || '-',
                    sub.user?.email || '-',
                    sub.user?.phone || '-',
                    sub.planName || '-',
                    sub.protein || '-',
                    sub.veggie || '-',
                    sub.powder || '-',
                    sub.statusName || sub.status || '-',
                    shippingMethod,
                    shippingAddress,
                    storeCode,
                    `$${shippingFee}`,
                    sub.startDate || '-',
                    sub.nextDeliveryDate || '-',
                    sub.createdAt ? new Date(sub.createdAt).toLocaleString('zh-TW') : '-'
                ];
            });

            let csv = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è¨‚é–±è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            alert('CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
        }

        function exportExcel() {
            // å¯¦éš›æ‡‰ç”¨ä¸­å¯ä½¿ç”¨ xlsx.js åº«
            alert('Excel åŒ¯å‡ºåŠŸèƒ½éœ€è¦æ•´åˆ xlsx.js åº«\n\nç›®å‰è«‹ä½¿ç”¨ CSV åŒ¯å‡ºåŠŸèƒ½');
        }

        // é‡æ–°è¼‰å…¥è³‡æ–™
        function refreshData() {
            console.log('ğŸ”„ é‡æ–°è¼‰å…¥è¨‚é–±è³‡æ–™...');
            initSampleData();
            updateStats();
            filterSubscriptions(); // ä½¿ç”¨ filterSubscriptions ä¾†ä¿æŒç•¶å‰çš„ç¯©é¸æ¢ä»¶
        }

        // ç›£è½ localStorage è®ŠåŒ–ï¼ˆè·¨åˆ†é åŒæ­¥ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'subscriptions') {
                console.log('ğŸ“¥ æª¢æ¸¬åˆ°è¨‚é–±è³‡æ–™æ›´æ–°ï¼Œè‡ªå‹•é‡æ–°è¼‰å…¥...');
                refreshData();
            }
        });

        // å®šæœŸæª¢æŸ¥è³‡æ–™æ›´æ–°ï¼ˆæ¯5ç§’ï¼‰
        setInterval(() => {
            const currentData = localStorage.getItem('subscriptions');
            if (currentData) {
                try {
                    const parsed = JSON.parse(currentData);
                    if (parsed.length !== subscriptionsData.length) {
                        console.log('ğŸ“Š è¨‚é–±æ•¸é‡è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–°...');
                        refreshData();
                    }
                } catch (e) {
                    // å¿½ç•¥è§£æéŒ¯èª¤
                }
            }
        }, 5000);

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ è¨‚é–±ç®¡ç†é é¢å·²è¼‰å…¥');
            initSampleData();
            updateStats();
            renderSubscriptions();
        });
    </script>
</body>
</html>
