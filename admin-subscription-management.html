<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂閱管理 - 匠寵後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .tab-button.active {
            background-color: #FF6B6B;
            color: white;
        }
        #detail-modal {
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- 後台導航 -->
    <nav class="bg-gray-900 text-white p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">匠寵後台管理系統</h1>
            <div class="flex gap-4">
                <a href="admin-dashboard.html" class="hover:text-gray-300">儀表板</a>
                <a href="admin-subscription-management.html" class="text-yellow-400">訂閱管理</a>
                <a href="admin-users.html" class="hover:text-gray-300">會員管理</a>
                <a href="admin-orders.html" class="hover:text-gray-300">訂單管理</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- 頁面標題 -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-black mb-2">訂閱管理</h2>
                <p class="text-gray-600">管理所有會員訂閱資料</p>
            </div>
            <div class="flex gap-2">
                <button onclick="refreshData()" class="bg-gray-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors shadow-sm">
                    <i class="fas fa-sync-alt mr-2"></i>重新載入
                </button>
                <button onclick="exportData('csv')" class="bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm">
                    <i class="fas fa-file-csv mr-2"></i>匯出 CSV
                </button>
                <button onclick="exportData('excel')" class="bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm">
                    <i class="fas fa-file-excel mr-2"></i>匯出 Excel
                </button>
            </div>
        </div>

        <!-- 統計卡片 - Years.com 風格 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">活躍訂閱</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-active">0</div>
                    </div>
                    <div class="w-12 h-12 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">暫停訂閱</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-paused">0</div>
                    </div>
                    <div class="w-12 h-12 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-pause-circle text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">已取消</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-cancelled">0</div>
                    </div>
                    <div class="w-12 h-12 bg-red-50 border border-red-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-times-circle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">總訂閱數</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-total">0</div>
                    </div>
                    <div class="w-12 h-12 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 篩選器 - Years.com 風格 -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">訂閱狀態</label>
                    <select id="filter-status" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterSubscriptions()">
                        <option value="">全部狀態</option>
                        <option value="active">進行中</option>
                        <option value="paused">已暫停</option>
                        <option value="cancelled">已取消</option>
                        <option value="pending">待付款</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">訂閱方案</label>
                    <select id="filter-plan" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterSubscriptions()">
                        <option value="">全部方案</option>
                        <option value="small">小食組</option>
                        <option value="standard">標準組</option>
                        <option value="premium">豪華組</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">搜尋會員</label>
                    <input type="text" id="search-input" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="姓名或 Email" oninput="filterSubscriptions()">
                </div>
                <div class="flex items-end">
                    <button onclick="resetFilters()" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200 transition-colors border border-gray-300">
                        <i class="fas fa-undo mr-2"></i>重置
                    </button>
                </div>
            </div>
        </div>

        <!-- 訂閱列表 - Years.com 風格 -->
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">訂單編號</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">會員</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">方案</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">內容</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">狀態</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">下次配送</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="subscription-list" class="bg-white divide-y divide-gray-200">
                        <!-- 動態載入 -->
                    </tbody>
                </table>
            </div>

            <!-- 分頁 - Years.com 風格 -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-600">
                    顯示 <span class="font-semibold text-gray-900" id="showing-start">1</span> 到 <span class="font-semibold text-gray-900" id="showing-end">10</span>，共 <span class="font-semibold text-gray-900" id="total-count">0</span> 筆
                </div>
                <div class="flex gap-2">
                    <button onclick="previousPage()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" id="prev-btn">
                        <i class="fas fa-chevron-left mr-1"></i>上一頁
                    </button>
                    <button onclick="nextPage()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" id="next-btn">
                        下一頁<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 訂閱詳情 Modal - Years.com 風格 -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- 標題欄 -->
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-white sticky top-0 z-10">
                <h3 class="text-2xl font-bold text-gray-900">訂閱詳情</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <!-- 內容區 -->
            <div id="detail-content" class="p-6 overflow-y-auto flex-1">
                <!-- 動態載入 -->
            </div>
        </div>
    </div>

    <script>
        // 模擬數據（實際應從API讀取）
        let subscriptionsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [];

        // 初始化範例數據
        function initSampleData() {
            // 從 localStorage 讀取訂閱資料（由前台訂閱頁面提交）
            const savedSubscriptions = localStorage.getItem('subscriptions');
            if (savedSubscriptions) {
                try {
                    subscriptionsData = JSON.parse(savedSubscriptions);
                    console.log('✅ 從 localStorage 載入訂閱資料:', subscriptionsData.length, '筆');
                } catch (e) {
                    console.error('讀取訂閱資料失敗:', e);
                    subscriptionsData = [];
                }
            } else {
                console.log('ℹ️ localStorage 中沒有訂閱資料');
            }

            // 如果沒有資料，生成範例數據（僅供測試）
            if (subscriptionsData.length === 0) {
                console.log('ℹ️ 使用範例資料（僅供測試）');
                const plans = ['small', 'standard', 'premium'];
                const planNames = { small: '小食組', standard: '標準組', premium: '豪華組' };
                const statuses = ['active', 'paused', 'cancelled'];
                const statusNames = { active: '進行中', paused: '已暫停', cancelled: '已取消' };
                const proteins = ['牛肉系列', '雞肉系列', '鴨肉系列', '小魚乾'];
                const veggies = ['節瓜凍乾', '南瓜凍乾', '地瓜凍乾', '胡蘿蔔凍乾'];
                const powders = ['牛腱肉凍乾粉', '雞肉雞肝凍乾粉', '鴨肉凍乾粉'];

                // 生成20筆範例數據
                for (let i = 1; i <= 20; i++) {
                    const plan = plans[Math.floor(Math.random() * plans.length)];
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    
                    subscriptionsData.push({
                        id: `SUB${String(i).padStart(6, '0')}`,
                        user: {
                            id: `USER${String(i).padStart(6, '0')}`,
                            name: `會員${i}`,
                            email: `user${i}@example.com`,
                            phone: `0912-345-${String(i).padStart(3, '0')}`
                        },
                        plan: plan,
                        planName: planNames[plan],
                        protein: proteins[Math.floor(Math.random() * proteins.length)],
                        veggie: veggies[Math.floor(Math.random() * veggies.length)],
                        powder: powders[Math.floor(Math.random() * powders.length)],
                        status: status,
                        statusName: statusNames[status],
                        startDate: new Date(2024, 0, i).toISOString().split('T')[0],
                        nextDeliveryDate: new Date(2024, 11, i + 10).toISOString().split('T')[0],
                        createdAt: new Date(2024, 0, i).toISOString()
                    });
                }
            }

            filteredData = [...subscriptionsData];
        }

        // 更新統計數據
        function updateStats() {
            const active = subscriptionsData.filter(s => s.status === 'active').length;
            const paused = subscriptionsData.filter(s => s.status === 'paused').length;
            const cancelled = subscriptionsData.filter(s => s.status === 'cancelled').length;
            
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-paused').textContent = paused;
            document.getElementById('stat-cancelled').textContent = cancelled;
            document.getElementById('stat-total').textContent = subscriptionsData.length;
        }

        // 渲染訂閱列表
        function renderSubscriptions() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const tbody = document.getElementById('subscription-list');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            沒有找到訂閱資料
                        </td>
                    </tr>
                `;
                return;
            }

            pageData.forEach((sub, index) => {
                // 此處的 statusColor 已不再使用，保留以避免錯誤
                const statusColor = {
                    'active': 'bg-green-100 text-green-800',
                    'paused': 'bg-yellow-100 text-yellow-800',
                    'cancelled': 'bg-red-100 text-red-800',
                    'pending': 'bg-gray-100 text-gray-800'
                };

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                // 使用 data 屬性儲存訂閱資料，避免 onclick 中的 JSON 問題
                const subDataId = `sub-${start + index}`;
                window[`subscriptionData_${subDataId}`] = sub;
                
                // 整合付款狀態邏輯：統一處理 pending 相關狀態
                const rawStatus = sub.status || 'pending';
                const status = (rawStatus === 'pending_verification' || rawStatus === 'pending') ? 'pending' : rawStatus;
                
                // 安全取得資料（處理可能的嵌套結構）
                const userName = sub.user?.name || '-';
                const userEmail = sub.user?.email || '-';
                const planName = sub.planName || sub.subscription?.planName || '-';
                const protein = sub.protein || sub.subscription?.proteinName || '-';
                const veggie = sub.veggie || sub.subscription?.veggieName || '-';
                const powder = sub.powder || sub.subscription?.powderName || '-';
                
                // 統一狀態名稱顯示：不管原始 statusName 是什麼，根據實際 status 顯示
                const statusNameMap = {
                    'pending': '待付款',
                    'active': '進行中',
                    'paused': '已暫停',
                    'cancelled': '已取消'
                };
                const statusName = statusNameMap[status] || status;
                
                // 取得訂單編號（優先使用 orderId，否則使用 id）
                const orderId = sub.orderId || sub.id || '-';
                
                // 下次配送日期格式化
                const nextDeliveryStr = sub.nextDeliveryDate ? 
                    new Date(sub.nextDeliveryDate).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) : '-';
                
                // 狀態配色（Years.com 風格）
                const statusStyles = {
                    'pending': 'bg-yellow-50 text-yellow-700 border-yellow-200',
                    'active': 'bg-green-50 text-green-700 border-green-200',
                    'paused': 'bg-gray-50 text-gray-700 border-gray-200',
                    'cancelled': 'bg-red-50 text-red-700 border-red-200'
                };
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-mono font-semibold text-gray-900">${orderId.slice(-8)}</div>
                        <div class="text-xs text-gray-500">${sub.createdAt ? new Date(sub.createdAt).toLocaleDateString('zh-TW') : ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${userName}</div>
                        <div class="text-xs text-gray-500">${userEmail}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${planName}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-orange-50 border border-orange-200 rounded text-xs text-orange-700 font-medium" title="${protein}">${protein.length > 8 ? protein.substring(0, 8) + '...' : protein}</span>
                            <span class="px-2 py-1 bg-green-50 border border-green-200 rounded text-xs text-green-700 font-medium" title="${veggie}">${veggie.length > 6 ? veggie.substring(0, 6) + '...' : veggie}</span>
                            <span class="px-2 py-1 bg-purple-50 border border-purple-200 rounded text-xs text-purple-700 font-medium" title="${powder}">${powder.length > 6 ? powder.substring(0, 6) + '...' : powder}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 rounded-lg text-xs font-semibold border ${statusStyles[status] || statusStyles.pending}">
                            ${statusName}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${nextDeliveryStr}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick='viewDetailByDataId("${subDataId}")' class="text-blue-600 hover:text-blue-800 font-semibold text-sm transition-colors">
                            <i class="fas fa-eye mr-1"></i>查看詳情
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 更新分頁資訊
            document.getElementById('showing-start').textContent = filteredData.length > 0 ? start + 1 : 0;
            document.getElementById('showing-end').textContent = Math.min(end, filteredData.length);
            document.getElementById('total-count').textContent = filteredData.length;

            // 更新按鈕狀態
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = end >= filteredData.length;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // 透過 data ID 查看詳情
        function viewDetailByDataId(dataId) {
            const subscription = window[`subscriptionData_${dataId}`];
            if (subscription) {
                viewDetail(subscription);
            }
        }

        // 篩選訂閱
        function filterSubscriptions() {
            const status = document.getElementById('filter-status').value;
            const plan = document.getElementById('filter-plan').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            filteredData = subscriptionsData.filter(sub => {
                const matchStatus = !status || sub.status === status;
                const matchPlan = !plan || sub.plan === plan;
                const matchSearch = !search || 
                    (sub.user && (
                        (sub.user.name && sub.user.name.toLowerCase().includes(search)) ||
                        (sub.user.email && sub.user.email.toLowerCase().includes(search))
                    ));
                
                return matchStatus && matchPlan && matchSearch;
            });

            currentPage = 1;
            renderSubscriptions();
        }

        // 重置篩選
        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-plan').value = '';
            document.getElementById('search-input').value = '';
            filterSubscriptions();
        }

        // 分頁
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderSubscriptions();
            }
        }

        function nextPage() {
            const maxPage = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                renderSubscriptions();
            }
        }

        // 查看詳情 - Years.com 簡潔風格
        function viewDetail(subscription) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            
            // 整合付款狀態邏輯：統一處理 pending 相關狀態
            const rawStatus = subscription.status || 'pending';
            const status = (rawStatus === 'pending_verification' || rawStatus === 'pending') ? 'pending' : rawStatus;
            
            const statusConfig = {
                'pending': { 
                    text: '待付款', 
                    bgColor: 'bg-yellow-50',
                    borderColor: 'border-yellow-300',
                    textColor: 'text-yellow-700',
                    iconColor: 'text-yellow-600'
                },
                'active': { 
                    text: '進行中', 
                    bgColor: 'bg-green-50',
                    borderColor: 'border-green-300',
                    textColor: 'text-green-700',
                    iconColor: 'text-green-600'
                },
                'paused': { 
                    text: '已暫停', 
                    bgColor: 'bg-gray-50',
                    borderColor: 'border-gray-300',
                    textColor: 'text-gray-700',
                    iconColor: 'text-gray-600'
                },
                'cancelled': { 
                    text: '已取消', 
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-300',
                    textColor: 'text-red-700',
                    iconColor: 'text-red-600'
                }
            };
            
            const statusInfo = statusConfig[status] || statusConfig.pending;
            
            // 處理配送資訊
            let deliveryInfoHTML = '';
            if (subscription.delivery) {
                const delivery = subscription.delivery;
                if (delivery.method === 'home') {
                    deliveryInfoHTML = `
                        <div class="bg-white rounded-lg p-5 border border-gray-200">
                            <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <div class="w-8 h-8 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-home text-blue-600 text-sm"></i>
                                </div>
                                配送資訊 - 宅配到府
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">收件人</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.recipientName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">聯絡電話</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.phone || '-'}</div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-xs text-gray-500 mb-1">配送地址</div>
                                    <div class="text-sm font-semibold text-gray-900">
                                        ${delivery.postalCode || ''} ${delivery.city || ''} ${delivery.district || ''} ${delivery.address || ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">運費</div>
                                    <div class="text-sm font-semibold text-orange-600">NT$ ${delivery.shippingFee || 0}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (delivery.method === '711') {
                    deliveryInfoHTML = `
                        <div class="bg-white rounded-lg p-5 border border-gray-200">
                            <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <div class="w-8 h-8 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-store text-green-600 text-sm"></i>
                                </div>
                                配送資訊 - 7-11 超商取貨
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">收件人</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.recipientName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">聯絡電話</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.phone || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">門市名稱</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.storeName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">門市代號</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.storeCode || '-'}</div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-xs text-gray-500 mb-1">門市地址</div>
                                    <div class="text-sm font-semibold text-gray-900">
                                        ${delivery.storeCity || ''} ${delivery.storeDistrict || ''} ${delivery.storeAddress || ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">運費</div>
                                    <div class="text-sm font-semibold text-green-600">免運費</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            const userInfo = subscription.user || {};
            const subscriptionInfo = subscription.subscription || {};
            const planName = subscription.planName || subscriptionInfo.planName || '-';
            const orderId = subscription.orderId || subscription.id || '-';
            
            // 計算下次配送日期
            const nextDeliveryDate = subscription.nextDeliveryDate ? 
                new Date(subscription.nextDeliveryDate).toLocaleDateString('zh-TW', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'short'
                }) : '-';
            
            const startDate = subscription.startDate ? 
                new Date(subscription.startDate).toLocaleDateString('zh-TW', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric'
                }) : '-';
            
            const createdAt = subscription.createdAt ? 
                new Date(subscription.createdAt).toLocaleDateString('zh-TW', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
            
            // 方案內容
            const proteinInfo = subscription.protein || subscriptionInfo.proteinName || '-';
            const veggieInfo = subscription.veggie || subscriptionInfo.veggieName || '-';
            const powderInfo = subscription.powder || subscriptionInfo.powderName || '-';
            
            // 付款資訊
            const pricing = subscription.pricing || {};
            const total = pricing.total || subscriptionInfo.price || 0;
            const subtotal = pricing.subtotal || subscriptionInfo.price || 0;
            const shippingFee = pricing.shippingFee || subscription.delivery?.shippingFee || 0;
            
            // 付款方式
            const paymentType = subscription.paymentType || 'monthly';
            const paymentTypeText = paymentType === 'halfyear' ? '半年付' : '月付';
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- 狀態卡片：一目了然 -->
                    <div class="bg-white rounded-lg p-6 border-2 ${statusInfo.borderColor}">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 ${statusInfo.bgColor} ${statusInfo.borderColor} border-2 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-${status === 'pending' ? 'clock' : status === 'active' ? 'check-circle' : status === 'paused' ? 'pause-circle' : 'times-circle'} ${statusInfo.iconColor} text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-1">${planName}</h3>
                                    <div class="flex items-center gap-3">
                                        <span class="px-3 py-1 ${statusInfo.bgColor} ${statusInfo.textColor} border ${statusInfo.borderColor} rounded text-xs font-semibold">
                                            ${statusInfo.text}
                                        </span>
                                        <span class="text-xs text-gray-500 font-mono">#${orderId.slice(-8)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-gray-900 mb-1">NT$ ${total.toLocaleString()}</div>
                                <div class="text-sm text-gray-500">${paymentTypeText}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 關鍵資訊：簡潔卡片 -->
                    ${status === 'active' || status === 'paused' ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-xs text-blue-600 font-semibold mb-1">下次配送</div>
                            <div class="text-base font-bold text-gray-900">${nextDeliveryDate}</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-xs text-green-600 font-semibold mb-1">配送頻率</div>
                            <div class="text-base font-bold text-gray-900">每月 1 次</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 方案內容 -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-purple-50 border border-purple-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-box text-purple-600 text-sm"></i>
                            </div>
                            方案內容
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2">
                                <i class="fas fa-drumstick-bite text-orange-600"></i>
                                <span class="text-sm font-medium text-gray-800">${proteinInfo}</span>
                            </div>
                            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2">
                                <i class="fas fa-carrot text-green-600"></i>
                                <span class="text-sm font-medium text-gray-800">${veggieInfo}</span>
                            </div>
                            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2">
                                <i class="fas fa-cube text-purple-600"></i>
                                <span class="text-sm font-medium text-gray-800">${powderInfo}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 會員資訊 -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user text-blue-600 text-sm"></i>
                            </div>
                            會員資訊
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">會員姓名</div>
                                <div class="text-sm font-semibold text-gray-900">${userInfo.name || '-'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Email</div>
                                <div class="text-sm font-semibold text-gray-900">${userInfo.email || '-'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">電話</div>
                                <div class="text-sm font-semibold text-gray-900">${userInfo.phone || '-'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">會員ID</div>
                                <div class="text-sm font-semibold text-gray-900 font-mono">${userInfo.id || userInfo.userId || '-'}</div>
                            </div>
                        </div>
                    </div>

                    ${deliveryInfoHTML}

                    <!-- 付款資訊 -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-credit-card text-green-600 text-sm"></i>
                            </div>
                            付款資訊
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">付款狀態</span>
                                <span class="px-3 py-1 rounded-lg text-xs font-semibold border ${statusInfo.bgColor} ${statusInfo.textColor} ${statusInfo.borderColor}">
                                    ${statusInfo.text}
                                </span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">付款方式</span>
                                <span class="text-sm font-semibold text-gray-900">${paymentTypeText}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            </div>
                            ` : }
                                <span class="text-sm text-gray-600">運費</span>
                                <span class="text-sm font-semibold text-gray-900">NT$ ${shippingFee.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200 mt-2">
                                <span class="text-base font-bold text-gray-900">總金額</span>
                                <span class="text-xl font-bold text-primary">NT$ ${total.toLocaleString()}</span>
                            </div>
                            ${status === 'pending' ? `
                            <div class="pt-4 mt-4 border-t-2 border-gray-200">
                                <button onclick="confirmPayment('${orderId}')" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm flex items-center justify-center gap-2">
                                    <i class="fas fa-check-circle"></i>
                                    確認已付款
                                </button>
                            </div>
                            ` : ''}
                            ` : ''}
                            <div class="flex justify-between items-center pt-2">
                                <span class="text-base font-bold text-gray-900">總金額</span>
                                <span class="text-xl font-bold text-primary">NT$ ${total.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 訂閱資訊 -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-info-circle text-gray-600 text-sm"></i>
                            </div>
                            訂閱資訊
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">建立時間</span>
                                <span class="text-sm font-semibold text-gray-900">${createdAt}</span>
                            </div>
                            ${startDate !== '-' ? `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">開始日期</span>
                                <span class="text-sm font-semibold text-gray-900">${startDate}</span>
                            </div>
                            ` : ''}
                            ${nextDeliveryDate !== '-' && (status === 'active' || status === 'paused') ? `
                            <div class="flex justify-between items-center py-2">
                                <span class="text-sm text-gray-600">下次配送</span>
                                <span class="text-sm font-semibold text-blue-600">${nextDeliveryDate}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDetailModal() {

        // 確認付款（統一付款確認功能）
        function confirmPayment(orderId) {
            if (!confirm('確定要將此訂閱標記為「已付款」嗎？\n\n此操作將更新訂閱狀態為「進行中」。')) {
                return;
            }
            
            const subscription = subscriptionsData.find(s => (s.orderId || s.id) === orderId);
            if (!subscription) {
                alert('找不到該訂閱記錄');
                return;
            }
            
            subscription.status = 'active';
            subscription.statusName = '進行中';
            
            if (!subscription.nextDeliveryDate) {
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + 30);
                subscription.nextDeliveryDate = nextDate.toISOString().split('T')[0];
            }
            
            try {
                localStorage.setItem('subscriptions', JSON.stringify(subscriptionsData));
                console.log('✅ 付款狀態已更新');
            } catch (e) {
                console.error('❌ 儲存失敗:', e);
                alert('更新失敗，請稍後再試');
                return;
            }
            
            updateStats();
            filterSubscriptions();
            viewDetail(subscription);
            alert('✅ 付款已確認！訂閱狀態已更新為「進行中」。');
        }
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // 點擊背景關閉 Modal
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('detail-modal');
            if (e.target === modal) {
                closeDetailModal();
            }
        });

        // 匯出數據
        function exportData(format) {
            if (format === 'csv') {
                exportCSV();
            } else if (format === 'excel') {
                exportExcel();
            }
        }

        function exportCSV() {
            const headers = [
                '訂單編號', '會員姓名', 'Email', '電話', '方案名稱', 
                '蛋白質', '蔬果凍乾', '凍乾粉', '狀態', 
                '配送方式', '配送地址/門市名稱', '門市代號', '運費',
                '開始日期', '下次配送', '建立時間'
            ];
            
            const rows = filteredData.map(sub => {
                // 處理配送資訊
                let shippingMethod = '-';
                let shippingAddress = '';
                let storeCode = '';
                let shippingFee = 0;

                if (sub.delivery) {
                    shippingMethod = sub.delivery.method === 'home' ? '宅配到府' : '7-11超商取貨';
                    shippingFee = sub.delivery.shippingFee || 0;

                    if (sub.delivery.method === 'home') {
                        // 宅配地址
                        shippingAddress = `${sub.delivery.city || ''} ${sub.delivery.district || ''} ${sub.delivery.address || ''}`;
                    } else if (sub.delivery.method === '711') {
                        // 超商門市
                        shippingAddress = sub.delivery.storeName || '';
                        storeCode = sub.delivery.storeCode || '';
                    }
                }

                return [
                    sub.id || '-',
                    sub.user?.name || '-',
                    sub.user?.email || '-',
                    sub.user?.phone || '-',
                    sub.planName || '-',
                    sub.protein || '-',
                    sub.veggie || '-',
                    sub.powder || '-',
                    sub.statusName || sub.status || '-',
                    shippingMethod,
                    shippingAddress,
                    storeCode,
                    `$${shippingFee}`,
                    sub.startDate || '-',
                    sub.nextDeliveryDate || '-',
                    sub.createdAt ? new Date(sub.createdAt).toLocaleString('zh-TW') : '-'
                ];
            });

            let csv = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `訂閱資料_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            alert('CSV 檔案已下載！');
        }

        function exportExcel() {
            // 實際應用中可使用 xlsx.js 庫
            alert('Excel 匯出功能需要整合 xlsx.js 庫\n\n目前請使用 CSV 匯出功能');
        }

        // 重新載入資料
        function refreshData() {
            console.log('🔄 重新載入訂閱資料...');
            initSampleData();
            updateStats();
            filterSubscriptions(); // 使用 filterSubscriptions 來保持當前的篩選條件
        }

        // 監聽 localStorage 變化（跨分頁同步）
        window.addEventListener('storage', (e) => {
            if (e.key === 'subscriptions') {
                console.log('📥 檢測到訂閱資料更新，自動重新載入...');
                refreshData();
            }
        });

        // 定期檢查資料更新（每5秒）
        setInterval(() => {
            const currentData = localStorage.getItem('subscriptions');
            if (currentData) {
                try {
                    const parsed = JSON.parse(currentData);
                    if (parsed.length !== subscriptionsData.length) {
                        console.log('📊 訂閱數量變化，自動更新...');
                        refreshData();
                    }
                } catch (e) {
                    // 忽略解析錯誤
                }
            }
        }, 5000);

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 訂閱管理頁面已載入');
            initSampleData();
            updateStats();
            renderSubscriptions();
        });
    </script>
</body>
</html>
