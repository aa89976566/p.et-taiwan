<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚é–±ç®¡ç† - åŒ å¯µå¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .tab-button.active {
            background-color: #FF6B6B;
            color: white;
        }
        #detail-modal {
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- å¾Œå°å°èˆª -->
    <nav class="bg-gray-900 text-white p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">åŒ å¯µå¾Œå°ç®¡ç†ç³»çµ±</h1>
            <div class="flex gap-4">
                <a href="admin-dashboard.html" class="hover:text-gray-300">å„€è¡¨æ¿</a>
                <a href="admin-subscription-management.html" class="text-yellow-400">è¨‚é–±ç®¡ç†</a>
                <a href="admin-users.html" class="hover:text-gray-300">æœƒå“¡ç®¡ç†</a>
                <a href="admin-orders.html" class="hover:text-gray-300">è¨‚å–®ç®¡ç†</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- é é¢æ¨™é¡Œ -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-black mb-2">è¨‚é–±ç®¡ç†</h2>
                <p class="text-gray-600">ç®¡ç†æ‰€æœ‰æœƒå“¡è¨‚é–±è³‡æ–™</p>
            </div>
            <div class="flex gap-2">
                <button onclick="refreshData()" class="bg-gray-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors shadow-sm">
                    <i class="fas fa-sync-alt mr-2"></i>é‡æ–°è¼‰å…¥
                </button>
                <button onclick="exportData('csv')" class="bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm">
                    <i class="fas fa-file-csv mr-2"></i>åŒ¯å‡º CSV
                </button>
                <button onclick="exportData('excel')" class="bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm">
                    <i class="fas fa-file-excel mr-2"></i>åŒ¯å‡º Excel
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ - Years.com é¢¨æ ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">æ´»èºè¨‚é–±</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-active">0</div>
                    </div>
                    <div class="w-12 h-12 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">æš«åœè¨‚é–±</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-paused">0</div>
                    </div>
                    <div class="w-12 h-12 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-pause-circle text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">å·²å–æ¶ˆ</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-cancelled">0</div>
                    </div>
                    <div class="w-12 h-12 bg-red-50 border border-red-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-times-circle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ç¸½è¨‚é–±æ•¸</div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-total">0</div>
                    </div>
                    <div class="w-12 h-12 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¯©é¸å™¨ - Years.com é¢¨æ ¼ -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">è¨‚é–±ç‹€æ…‹</label>
                    <select id="filter-status" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterSubscriptions()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="active">é€²è¡Œä¸­</option>
                        <option value="paused">å·²æš«åœ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                        <option value="pending">å¾…ä»˜æ¬¾</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">è¨‚é–±æ–¹æ¡ˆ</label>
                    <select id="filter-plan" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterSubscriptions()">
                        <option value="">å…¨éƒ¨æ–¹æ¡ˆ</option>
                        <option value="small">å°é£Ÿçµ„</option>
                        <option value="standard">æ¨™æº–çµ„</option>
                        <option value="premium">è±ªè¯çµ„</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">æœå°‹æœƒå“¡</label>
                    <input type="text" id="search-input" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="å§“åæˆ– Email" oninput="filterSubscriptions()">
                </div>
                <div class="flex items-end">
                    <button onclick="resetFilters()" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200 transition-colors border border-gray-300">
                        <i class="fas fa-undo mr-2"></i>é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- è¨‚é–±åˆ—è¡¨ - Years.com é¢¨æ ¼ -->
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">è¨‚å–®ç·¨è™Ÿ</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">æœƒå“¡</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">æ–¹æ¡ˆ</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">å…§å®¹</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ç‹€æ…‹</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ä¸‹æ¬¡é…é€</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="subscription-list" class="bg-white divide-y divide-gray-200">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é  - Years.com é¢¨æ ¼ -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-600">
                    é¡¯ç¤º <span class="font-semibold text-gray-900" id="showing-start">1</span> åˆ° <span class="font-semibold text-gray-900" id="showing-end">10</span>ï¼Œå…± <span class="font-semibold text-gray-900" id="total-count">0</span> ç­†
                </div>
                <div class="flex gap-2">
                    <button onclick="previousPage()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" id="prev-btn">
                        <i class="fas fa-chevron-left mr-1"></i>ä¸Šä¸€é 
                    </button>
                    <button onclick="nextPage()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" id="next-btn">
                        ä¸‹ä¸€é <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨‚é–±è©³æƒ… Modal - Years.com é¢¨æ ¼ -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- æ¨™é¡Œæ¬„ -->
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-white sticky top-0 z-10">
                <h3 class="text-2xl font-bold text-gray-900">è¨‚é–±è©³æƒ…</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <!-- å…§å®¹å€ -->
            <div id="detail-content" class="p-6 overflow-y-auto flex-1">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬æ•¸æ“šï¼ˆå¯¦éš›æ‡‰å¾APIè®€å–ï¼‰
        let subscriptionsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [];

        // åˆå§‹åŒ–ç¯„ä¾‹æ•¸æ“š
        function initSampleData() {
            // å¾ localStorage è®€å–è¨‚é–±è³‡æ–™ï¼ˆç”±å‰å°è¨‚é–±é é¢æäº¤ï¼‰
            const savedSubscriptions = localStorage.getItem('subscriptions');
            if (savedSubscriptions) {
                try {
                    subscriptionsData = JSON.parse(savedSubscriptions);
                    console.log('âœ… å¾ localStorage è¼‰å…¥è¨‚é–±è³‡æ–™:', subscriptionsData.length, 'ç­†');
                } catch (e) {
                    console.error('è®€å–è¨‚é–±è³‡æ–™å¤±æ•—:', e);
                    subscriptionsData = [];
                }
            } else {
                console.log('â„¹ï¸ localStorage ä¸­æ²’æœ‰è¨‚é–±è³‡æ–™');
            }

            // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œç”Ÿæˆç¯„ä¾‹æ•¸æ“šï¼ˆåƒ…ä¾›æ¸¬è©¦ï¼‰
            if (subscriptionsData.length === 0) {
                console.log('â„¹ï¸ ä½¿ç”¨ç¯„ä¾‹è³‡æ–™ï¼ˆåƒ…ä¾›æ¸¬è©¦ï¼‰');
                const plans = ['small', 'standard', 'premium'];
                const planNames = { small: 'å°é£Ÿçµ„', standard: 'æ¨™æº–çµ„', premium: 'è±ªè¯çµ„' };
                const statuses = ['active', 'paused', 'cancelled'];
                const statusNames = { active: 'é€²è¡Œä¸­', paused: 'å·²æš«åœ', cancelled: 'å·²å–æ¶ˆ' };
                const proteins = ['ç‰›è‚‰ç³»åˆ—', 'é›è‚‰ç³»åˆ—', 'é´¨è‚‰ç³»åˆ—', 'å°é­šä¹¾'];
                const veggies = ['ç¯€ç“œå‡ä¹¾', 'å—ç“œå‡ä¹¾', 'åœ°ç“œå‡ä¹¾', 'èƒ¡è˜¿è””å‡ä¹¾'];
                const powders = ['ç‰›è…±è‚‰å‡ä¹¾ç²‰', 'é›è‚‰é›è‚å‡ä¹¾ç²‰', 'é´¨è‚‰å‡ä¹¾ç²‰'];

                // ç”Ÿæˆ20ç­†ç¯„ä¾‹æ•¸æ“š
                for (let i = 1; i <= 20; i++) {
                    const plan = plans[Math.floor(Math.random() * plans.length)];
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    
                    subscriptionsData.push({
                        id: `SUB${String(i).padStart(6, '0')}`,
                        user: {
                            id: `USER${String(i).padStart(6, '0')}`,
                            name: `æœƒå“¡${i}`,
                            email: `user${i}@example.com`,
                            phone: `0912-345-${String(i).padStart(3, '0')}`
                        },
                        plan: plan,
                        planName: planNames[plan],
                        protein: proteins[Math.floor(Math.random() * proteins.length)],
                        veggie: veggies[Math.floor(Math.random() * veggies.length)],
                        powder: powders[Math.floor(Math.random() * powders.length)],
                        status: status,
                        statusName: statusNames[status],
                        startDate: new Date(2024, 0, i).toISOString().split('T')[0],
                        nextDeliveryDate: new Date(2024, 11, i + 10).toISOString().split('T')[0],
                        createdAt: new Date(2024, 0, i).toISOString()
                    });
                }
            }

            filteredData = [...subscriptionsData];
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const active = subscriptionsData.filter(s => s.status === 'active').length;
            const paused = subscriptionsData.filter(s => s.status === 'paused').length;
            const cancelled = subscriptionsData.filter(s => s.status === 'cancelled').length;
            
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-paused').textContent = paused;
            document.getElementById('stat-cancelled').textContent = cancelled;
            document.getElementById('stat-total').textContent = subscriptionsData.length;
        }

        // æ¸²æŸ“è¨‚é–±åˆ—è¡¨
        function renderSubscriptions() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const tbody = document.getElementById('subscription-list');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                            æ²’æœ‰æ‰¾åˆ°è¨‚é–±è³‡æ–™
                        </td>
                    </tr>
                `;
                return;
            }

            pageData.forEach((sub, index) => {
                // æ­¤è™•çš„ statusColor å·²ä¸å†ä½¿ç”¨ï¼Œä¿ç•™ä»¥é¿å…éŒ¯èª¤
                const statusColor = {
                    'active': 'bg-green-100 text-green-800',
                    'paused': 'bg-yellow-100 text-yellow-800',
                    'cancelled': 'bg-red-100 text-red-800',
                    'pending': 'bg-gray-100 text-gray-800'
                };

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                // ä½¿ç”¨ data å±¬æ€§å„²å­˜è¨‚é–±è³‡æ–™ï¼Œé¿å… onclick ä¸­çš„ JSON å•é¡Œ
                const subDataId = `sub-${start + index}`;
                window[`subscriptionData_${subDataId}`] = sub;
                
                // æ•´åˆä»˜æ¬¾ç‹€æ…‹é‚è¼¯ï¼šçµ±ä¸€è™•ç† pending ç›¸é—œç‹€æ…‹
                const rawStatus = sub.status || 'pending';
                const status = (rawStatus === 'pending_verification' || rawStatus === 'pending') ? 'pending' : rawStatus;
                
                // å®‰å…¨å–å¾—è³‡æ–™ï¼ˆè™•ç†å¯èƒ½çš„åµŒå¥—çµæ§‹ï¼‰
                const userName = sub.user?.name || '-';
                const userEmail = sub.user?.email || '-';
                const planName = sub.planName || sub.subscription?.planName || '-';
                const protein = sub.protein || sub.subscription?.proteinName || '-';
                const veggie = sub.veggie || sub.subscription?.veggieName || '-';
                const powder = sub.powder || sub.subscription?.powderName || '-';
                
                // çµ±ä¸€ç‹€æ…‹åç¨±é¡¯ç¤ºï¼šä¸ç®¡åŸå§‹ statusName æ˜¯ä»€éº¼ï¼Œæ ¹æ“šå¯¦éš› status é¡¯ç¤º
                const statusNameMap = {
                    'pending': 'å¾…ä»˜æ¬¾',
                    'active': 'é€²è¡Œä¸­',
                    'paused': 'å·²æš«åœ',
                    'cancelled': 'å·²å–æ¶ˆ'
                };
                const statusName = statusNameMap[status] || status;
                
                // å–å¾—è¨‚å–®ç·¨è™Ÿï¼ˆå„ªå…ˆä½¿ç”¨ orderIdï¼Œå¦å‰‡ä½¿ç”¨ idï¼‰
                const orderId = sub.orderId || sub.id || '-';
                
                // ä¸‹æ¬¡é…é€æ—¥æœŸæ ¼å¼åŒ–
                const nextDeliveryStr = sub.nextDeliveryDate ? 
                    new Date(sub.nextDeliveryDate).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) : '-';
                
                // ç‹€æ…‹é…è‰²ï¼ˆYears.com é¢¨æ ¼ï¼‰
                const statusStyles = {
                    'pending': 'bg-yellow-50 text-yellow-700 border-yellow-200',
                    'active': 'bg-green-50 text-green-700 border-green-200',
                    'paused': 'bg-gray-50 text-gray-700 border-gray-200',
                    'cancelled': 'bg-red-50 text-red-700 border-red-200'
                };
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-mono font-semibold text-gray-900">${orderId.slice(-8)}</div>
                        <div class="text-xs text-gray-500">${sub.createdAt ? new Date(sub.createdAt).toLocaleDateString('zh-TW') : ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${userName}</div>
                        <div class="text-xs text-gray-500">${userEmail}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${planName}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-orange-50 border border-orange-200 rounded text-xs text-orange-700 font-medium" title="${protein}">${protein.length > 8 ? protein.substring(0, 8) + '...' : protein}</span>
                            <span class="px-2 py-1 bg-green-50 border border-green-200 rounded text-xs text-green-700 font-medium" title="${veggie}">${veggie.length > 6 ? veggie.substring(0, 6) + '...' : veggie}</span>
                            <span class="px-2 py-1 bg-purple-50 border border-purple-200 rounded text-xs text-purple-700 font-medium" title="${powder}">${powder.length > 6 ? powder.substring(0, 6) + '...' : powder}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 rounded-lg text-xs font-semibold border ${statusStyles[status] || statusStyles.pending}">
                            ${statusName}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${nextDeliveryStr}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick='viewDetailByDataId("${subDataId}")' class="text-blue-600 hover:text-blue-800 font-semibold text-sm transition-colors">
                            <i class="fas fa-eye mr-1"></i>æŸ¥çœ‹è©³æƒ…
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // æ›´æ–°åˆ†é è³‡è¨Š
            document.getElementById('showing-start').textContent = filteredData.length > 0 ? start + 1 : 0;
            document.getElementById('showing-end').textContent = Math.min(end, filteredData.length);
            document.getElementById('total-count').textContent = filteredData.length;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = end >= filteredData.length;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // é€é data ID æŸ¥çœ‹è©³æƒ…
        function viewDetailByDataId(dataId) {
            const subscription = window[`subscriptionData_${dataId}`];
            if (subscription) {
                viewDetail(subscription);
            }
        }

        // ç¯©é¸è¨‚é–±
        function filterSubscriptions() {
            const status = document.getElementById('filter-status').value;
            const plan = document.getElementById('filter-plan').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            filteredData = subscriptionsData.filter(sub => {
                const matchStatus = !status || sub.status === status;
                const matchPlan = !plan || sub.plan === plan;
                const matchSearch = !search || 
                    (sub.user && (
                        (sub.user.name && sub.user.name.toLowerCase().includes(search)) ||
                        (sub.user.email && sub.user.email.toLowerCase().includes(search))
                    ));
                
                return matchStatus && matchPlan && matchSearch;
            });

            currentPage = 1;
            renderSubscriptions();
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-plan').value = '';
            document.getElementById('search-input').value = '';
            filterSubscriptions();
        }

        // åˆ†é 
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderSubscriptions();
            }
        }

        function nextPage() {
            const maxPage = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                renderSubscriptions();
            }
        }

        // æŸ¥çœ‹è©³æƒ… - Years.com ç°¡æ½”é¢¨æ ¼
        function viewDetail(subscription) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            
            // æ•´åˆä»˜æ¬¾ç‹€æ…‹é‚è¼¯ï¼šçµ±ä¸€è™•ç† pending ç›¸é—œç‹€æ…‹
            const rawStatus = subscription.status || 'pending';
            const status = (rawStatus === 'pending_verification' || rawStatus === 'pending') ? 'pending' : rawStatus;
            
            const statusConfig = {
                'pending': { 
                    text: 'å¾…ä»˜æ¬¾', 
                    bgColor: 'bg-yellow-50',
                    borderColor: 'border-yellow-300',
                    textColor: 'text-yellow-700',
                    iconColor: 'text-yellow-600'
                },
                'active': { 
                    text: 'é€²è¡Œä¸­', 
                    bgColor: 'bg-green-50',
                    borderColor: 'border-green-300',
                    textColor: 'text-green-700',
                    iconColor: 'text-green-600'
                },
                'paused': { 
                    text: 'å·²æš«åœ', 
                    bgColor: 'bg-gray-50',
                    borderColor: 'border-gray-300',
                    textColor: 'text-gray-700',
                    iconColor: 'text-gray-600'
                },
                'cancelled': { 
                    text: 'å·²å–æ¶ˆ', 
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-300',
                    textColor: 'text-red-700',
                    iconColor: 'text-red-600'
                }
            };
            
            const statusInfo = statusConfig[status] || statusConfig.pending;
            
            // è™•ç†é…é€è³‡è¨Š
            let deliveryInfoHTML = '';
            if (subscription.delivery) {
                const delivery = subscription.delivery;
                if (delivery.method === 'home') {
                    deliveryInfoHTML = `
                        <div class="bg-white rounded-lg p-5 border border-gray-200">
                            <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <div class="w-8 h-8 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-home text-blue-600 text-sm"></i>
                                </div>
                                é…é€è³‡è¨Š - å®…é…åˆ°åºœ
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">æ”¶ä»¶äºº</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.recipientName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">è¯çµ¡é›»è©±</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.phone || '-'}</div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-xs text-gray-500 mb-1">é…é€åœ°å€</div>
                                    <div class="text-sm font-semibold text-gray-900">
                                        ${delivery.postalCode || ''} ${delivery.city || ''} ${delivery.district || ''} ${delivery.address || ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">é‹è²»</div>
                                    <div class="text-sm font-semibold text-orange-600">NT$ ${delivery.shippingFee || 0}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (delivery.method === '711') {
                    deliveryInfoHTML = `
                        <div class="bg-white rounded-lg p-5 border border-gray-200">
                            <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <div class="w-8 h-8 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-store text-green-600 text-sm"></i>
                                </div>
                                é…é€è³‡è¨Š - 7-11 è¶…å•†å–è²¨
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">æ”¶ä»¶äºº</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.recipientName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">è¯çµ¡é›»è©±</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.phone || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">é–€å¸‚åç¨±</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.storeName || '-'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">é–€å¸‚ä»£è™Ÿ</div>
                                    <div class="text-sm font-semibold text-gray-900">${delivery.storeCode || '-'}</div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-xs text-gray-500 mb-1">é–€å¸‚åœ°å€</div>
                                    <div class="text-sm font-semibold text-gray-900">
                                        ${delivery.storeCity || ''} ${delivery.storeDistrict || ''} ${delivery.storeAddress || ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">é‹è²»</div>
                                    <div class="text-sm font-semibold text-green-600">å…é‹è²»</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            const userInfo = subscription.user || {};
            const subscriptionInfo = subscription.subscription || {};
            const planName = subscription.planName || subscriptionInfo.planName || '-';
            const orderId = subscription.orderId || subscription.id || '-';
            
            // è¨ˆç®—ä¸‹æ¬¡é…é€æ—¥æœŸ
            const nextDeliveryDate = subscription.nextDeliveryDate ? 
                new Date(subscription.nextDeliveryDate).toLocaleDateString('zh-TW', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'short'
                }) : '-';
            
            const startDate = subscription.startDate ? 
                new Date(subscription.startDate).toLocaleDateString('zh-TW', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric'
                }) : '-';
            
            const createdAt = subscription.createdAt ? 
                new Date(subscription.createdAt).toLocaleDateString('zh-TW', { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
            
            // æ–¹æ¡ˆå…§å®¹
            const proteinInfo = subscription.protein || subscriptionInfo.proteinName || '-';
            const veggieInfo = subscription.veggie || subscriptionInfo.veggieName || '-';
            const powderInfo = subscription.powder || subscriptionInfo.powderName || '-';
            
            // ä»˜æ¬¾è³‡è¨Š
            const pricing = subscription.pricing || {};
            const total = pricing.total || subscriptionInfo.price || 0;
            const subtotal = pricing.subtotal || subscriptionInfo.price || 0;
            const shippingFee = pricing.shippingFee || subscription.delivery?.shippingFee || 0;
            
            // ä»˜æ¬¾æ–¹å¼
            const paymentType = subscription.paymentType || 'monthly';
            const paymentTypeText = paymentType === 'halfyear' ? 'åŠå¹´ä»˜' : 'æœˆä»˜';
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- ç‹€æ…‹å¡ç‰‡ï¼šä¸€ç›®äº†ç„¶ -->
                    <div class="bg-white rounded-lg p-6 border-2 ${statusInfo.borderColor}">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 ${statusInfo.bgColor} ${statusInfo.borderColor} border-2 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-${status === 'pending' ? 'clock' : status === 'active' ? 'check-circle' : status === 'paused' ? 'pause-circle' : 'times-circle'} ${statusInfo.iconColor} text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-1">${planName}</h3>
                                    <div class="flex items-center gap-3">
                                        <span class="px-3 py-1 ${statusInfo.bgColor} ${statusInfo.textColor} border ${statusInfo.borderColor} rounded text-xs font-semibold">
                                            ${statusInfo.text}
                                        </span>
                                        <span class="text-xs text-gray-500 font-mono">#${orderId.slice(-8)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-gray-900 mb-1">NT$ ${total.toLocaleString()}</div>
                                <div class="text-sm text-gray-500">${paymentTypeText}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é—œéµè³‡è¨Šï¼šç°¡æ½”å¡ç‰‡ -->
                    ${status === 'active' || status === 'paused' ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-xs text-blue-600 font-semibold mb-1">ä¸‹æ¬¡é…é€</div>
                            <div class="text-base font-bold text-gray-900">${nextDeliveryDate}</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-xs text-green-600 font-semibold mb-1">é…é€é »ç‡</div>
                            <div class="text-base font-bold text-gray-900">æ¯æœˆ 1 æ¬¡</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- æ–¹æ¡ˆå…§å®¹ -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-purple-50 border border-purple-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-box text-purple-600 text-sm"></i>
                            </div>
                            æ–¹æ¡ˆå…§å®¹
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2">
                                <i class="fas fa-drumstick-bite text-orange-600"></i>
                                <span class="text-sm font-medium text-gray-800">${proteinInfo}</span>
                            </div>
                            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2">
                                <i class="fas fa-carrot text-green-600"></i>
                                <span class="text-sm font-medium text-gray-800">${veggieInfo}</span>
                            </div>
                            <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2">
                                <i class="fas fa-cube text-purple-600"></i>
                                <span class="text-sm font-medium text-gray-800">${powderInfo}</span>
                            </div>
                        </div>
                    </div>

                    <!-- æœƒå“¡è³‡è¨Š -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user text-blue-600 text-sm"></i>
                            </div>
                            æœƒå“¡è³‡è¨Š
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">æœƒå“¡å§“å</div>
                                <div class="text-sm font-semibold text-gray-900">${userInfo.name || '-'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Email</div>
                                <div class="text-sm font-semibold text-gray-900">${userInfo.email || '-'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">é›»è©±</div>
                                <div class="text-sm font-semibold text-gray-900">${userInfo.phone || '-'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">æœƒå“¡ID</div>
                                <div class="text-sm font-semibold text-gray-900 font-mono">${userInfo.id || userInfo.userId || '-'}</div>
                            </div>
                        </div>
                    </div>

                    ${deliveryInfoHTML}

                    <!-- ä»˜æ¬¾è³‡è¨Š -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-green-50 border border-green-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-credit-card text-green-600 text-sm"></i>
                            </div>
                            ä»˜æ¬¾è³‡è¨Š
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">ä»˜æ¬¾æ–¹å¼</span>
                                <span class="text-sm font-semibold text-gray-900">${paymentTypeText}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">æ–¹æ¡ˆåƒ¹æ ¼</span>
                                <span class="text-sm font-semibold text-gray-900">NT$ ${subtotal.toLocaleString()}</span>
                            </div>
                            ${shippingFee > 0 ? `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">é‹è²»</span>
                                <span class="text-sm font-semibold text-gray-900">NT$ ${shippingFee.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            <div class="flex justify-between items-center pt-2">
                                <span class="text-base font-bold text-gray-900">ç¸½é‡‘é¡</span>
                                <span class="text-xl font-bold text-primary">NT$ ${total.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    <!-- è¨‚é–±è³‡è¨Š -->
                    <div class="bg-white rounded-lg p-5 border border-gray-200">
                        <h4 class="text-base font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-info-circle text-gray-600 text-sm"></i>
                            </div>
                            è¨‚é–±è³‡è¨Š
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">å»ºç«‹æ™‚é–“</span>
                                <span class="text-sm font-semibold text-gray-900">${createdAt}</span>
                            </div>
                            ${startDate !== '-' ? `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">é–‹å§‹æ—¥æœŸ</span>
                                <span class="text-sm font-semibold text-gray-900">${startDate}</span>
                            </div>
                            ` : ''}
                            ${nextDeliveryDate !== '-' && (status === 'active' || status === 'paused') ? `
                            <div class="flex justify-between items-center py-2">
                                <span class="text-sm text-gray-600">ä¸‹æ¬¡é…é€</span>
                                <span class="text-sm font-semibold text-blue-600">${nextDeliveryDate}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDetailModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('detail-modal');
            if (e.target === modal) {
                closeDetailModal();
            }
        });

        // åŒ¯å‡ºæ•¸æ“š
        function exportData(format) {
            if (format === 'csv') {
                exportCSV();
            } else if (format === 'excel') {
                exportExcel();
            }
        }

        function exportCSV() {
            const headers = [
                'è¨‚å–®ç·¨è™Ÿ', 'æœƒå“¡å§“å', 'Email', 'é›»è©±', 'æ–¹æ¡ˆåç¨±', 
                'è›‹ç™½è³ª', 'è”¬æœå‡ä¹¾', 'å‡ä¹¾ç²‰', 'ç‹€æ…‹', 
                'é…é€æ–¹å¼', 'é…é€åœ°å€/é–€å¸‚åç¨±', 'é–€å¸‚ä»£è™Ÿ', 'é‹è²»',
                'é–‹å§‹æ—¥æœŸ', 'ä¸‹æ¬¡é…é€', 'å»ºç«‹æ™‚é–“'
            ];
            
            const rows = filteredData.map(sub => {
                // è™•ç†é…é€è³‡è¨Š
                let shippingMethod = '-';
                let shippingAddress = '';
                let storeCode = '';
                let shippingFee = 0;

                if (sub.delivery) {
                    shippingMethod = sub.delivery.method === 'home' ? 'å®…é…åˆ°åºœ' : '7-11è¶…å•†å–è²¨';
                    shippingFee = sub.delivery.shippingFee || 0;

                    if (sub.delivery.method === 'home') {
                        // å®…é…åœ°å€
                        shippingAddress = `${sub.delivery.city || ''} ${sub.delivery.district || ''} ${sub.delivery.address || ''}`;
                    } else if (sub.delivery.method === '711') {
                        // è¶…å•†é–€å¸‚
                        shippingAddress = sub.delivery.storeName || '';
                        storeCode = sub.delivery.storeCode || '';
                    }
                }

                return [
                    sub.id || '-',
                    sub.user?.name || '-',
                    sub.user?.email || '-',
                    sub.user?.phone || '-',
                    sub.planName || '-',
                    sub.protein || '-',
                    sub.veggie || '-',
                    sub.powder || '-',
                    sub.statusName || sub.status || '-',
                    shippingMethod,
                    shippingAddress,
                    storeCode,
                    `$${shippingFee}`,
                    sub.startDate || '-',
                    sub.nextDeliveryDate || '-',
                    sub.createdAt ? new Date(sub.createdAt).toLocaleString('zh-TW') : '-'
                ];
            });

            let csv = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è¨‚é–±è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            alert('CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
        }

        function exportExcel() {
            // å¯¦éš›æ‡‰ç”¨ä¸­å¯ä½¿ç”¨ xlsx.js åº«
            alert('Excel åŒ¯å‡ºåŠŸèƒ½éœ€è¦æ•´åˆ xlsx.js åº«\n\nç›®å‰è«‹ä½¿ç”¨ CSV åŒ¯å‡ºåŠŸèƒ½');
        }

        // é‡æ–°è¼‰å…¥è³‡æ–™
        function refreshData() {
            console.log('ğŸ”„ é‡æ–°è¼‰å…¥è¨‚é–±è³‡æ–™...');
            initSampleData();
            updateStats();
            filterSubscriptions(); // ä½¿ç”¨ filterSubscriptions ä¾†ä¿æŒç•¶å‰çš„ç¯©é¸æ¢ä»¶
        }

        // ç›£è½ localStorage è®ŠåŒ–ï¼ˆè·¨åˆ†é åŒæ­¥ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'subscriptions') {
                console.log('ğŸ“¥ æª¢æ¸¬åˆ°è¨‚é–±è³‡æ–™æ›´æ–°ï¼Œè‡ªå‹•é‡æ–°è¼‰å…¥...');
                refreshData();
            }
        });

        // å®šæœŸæª¢æŸ¥è³‡æ–™æ›´æ–°ï¼ˆæ¯5ç§’ï¼‰
        setInterval(() => {
            const currentData = localStorage.getItem('subscriptions');
            if (currentData) {
                try {
                    const parsed = JSON.parse(currentData);
                    if (parsed.length !== subscriptionsData.length) {
                        console.log('ğŸ“Š è¨‚é–±æ•¸é‡è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–°...');
                        refreshData();
                    }
                } catch (e) {
                    // å¿½ç•¥è§£æéŒ¯èª¤
                }
            }
        }, 5000);

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ è¨‚é–±ç®¡ç†é é¢å·²è¼‰å…¥');
            initSampleData();
            updateStats();
            renderSubscriptions();
        });
    </script>
</body>
</html>
