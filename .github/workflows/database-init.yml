name: Database Initialization

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/config/database.js'
      - 'backend/scripts/**'
      - 'backend/package.json'
      - '.github/workflows/database-init.yml'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
  repository_dispatch:  # å…è¨±å¤–éƒ¨è§¸ç™¼

jobs:
  init-database:
    name: Initialize PostgreSQL Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Test database connection
        working-directory: ./backend
        run: npm run test-db
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_TYPE: postgresql
          NODE_ENV: production
        continue-on-error: true

      - name: Initialize database (create tables)
        working-directory: ./backend
        run: |
          # å¦‚æœ npm run setup-db ä¸å­˜åœ¨ï¼Œç›´æ¥åŸ·è¡Œè…³æœ¬
          if npm run | grep -q "setup-db"; then
            npm run setup-db
          else
            node scripts/setup-railway-db.js
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_TYPE: postgresql
          NODE_ENV: production

      - name: Verify tables were created
        working-directory: ./backend
        run: |
          node -e "
          require('dotenv').config();
          const { Pool } = require('pg');
          const pool = new Pool({
            connectionString: process.env.DATABASE_URL,
            ssl: { rejectUnauthorized: false }
          });
          pool.query(\`
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_type = 'BASE TABLE'
            ORDER BY table_name
          \`).then(result => {
            console.log('âœ… è³‡æ–™è¡¨æ•¸é‡:', result.rows.length);
            result.rows.forEach(row => console.log('   -', row.table_name));
            const expectedTables = ['users', 'products', 'orders', 'order_items', 'cart_items', 'subscriptions', 'quiz_results', 'settings', 'coupons', 'coupon_usage', 'product_variants'];
            const existingTables = result.rows.map(r => r.table_name);
            const missing = expectedTables.filter(t => !existingTables.includes(t));
            if (missing.length > 0) {
              console.error('âŒ ç¼ºå°‘è³‡æ–™è¡¨:', missing.join(', '));
              process.exit(1);
            } else {
              console.log('âœ… æ‰€æœ‰è³‡æ–™è¡¨éƒ½å·²å»ºç«‹ï¼');
            }
            process.exit(0);
          }).catch(err => {
            console.error('âŒ é©—è­‰å¤±æ•—:', err.message);
            process.exit(1);
          });
          "
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_TYPE: postgresql
          NODE_ENV: production

      - name: Database initialization summary
        if: success()
        run: |
          echo "âœ… è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆï¼"
          echo "ğŸ“Š æ‰€æœ‰è³‡æ–™è¡¨å·²æˆåŠŸå»ºç«‹"
