<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»˜æ¬¾è³‡è¨Š - åŒ å¯µ JiangChong</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .countdown-timer {
            font-size: 2rem;
            font-weight: 900;
            color: #FF6B6B;
        }
        .payment-info-card {
            border: 2px solid #FF6B6B;
            background: linear-gradient(135deg, #FFF5F5 0%, #FFFFFF 100%);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulsing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å°èˆªæ¬„ -->
    <nav class="bg-white border-b-2 border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-black" style="color: #FF6B6B;">åŒ å¯µ</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black text-gray-900 mb-2">ä»˜æ¬¾è³‡è¨Š</h1>
            <p class="text-gray-600">è«‹æ–¼ <span class="countdown-timer" id="countdown">02:00</span> å…§å®Œæˆä»˜æ¬¾</p>
        </div>

        <!-- è½‰å¸³è³‡è¨Šå¡ç‰‡ -->
        <div class="payment-info-card rounded-2xl p-8 mb-8 shadow-lg">
            <div class="flex items-center justify-center mb-6">
                <div class="bg-green-100 rounded-full p-4 mr-4">
                    <i class="fas fa-university text-green-600 text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-gray-900">è½‰å¸³è³‡è¨Š</h2>
                    <p class="text-sm text-gray-600">è«‹å°‡æ¬¾é …è½‰è‡³ä»¥ä¸‹å¸³æˆ¶</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 mb-6 border-2 border-dashed border-gray-300">
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-2">éŠ€è¡Œä»£ç¢¼</div>
                    <div class="text-3xl font-black text-gray-900 mb-6">822</div>
                    <div class="text-sm text-gray-600 mb-2">å¸³è™Ÿ</div>
                    <div class="text-4xl font-black" style="color: #FF6B6B; letter-spacing: 0.1em;" id="account-number">
                        226540037896
                    </div>
                </div>
            </div>

            <!-- è¤‡è£½æŒ‰éˆ• -->
            <div class="flex justify-center">
                <button onclick="copyAccountInfo()" class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-900 transition-colors flex items-center">
                    <i class="fas fa-copy mr-2"></i>
                    è¤‡è£½å¸³è™Ÿè³‡è¨Š
                </button>
            </div>
        </div>

        <!-- LINE å®˜æ–¹å¸³è™Ÿå€å¡Š -->
        <div class="bg-white rounded-2xl p-8 mb-8 shadow-lg">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full mb-4">
                    <i class="fab fa-line text-white text-4xl"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-900 mb-2">åŠ å…¥å®˜æ–¹ LINE å¸³è™Ÿ</h2>
                <p class="text-gray-600">å®Œæˆä»˜æ¬¾å¾Œï¼Œè«‹åŠ å…¥ LINE ä¸¦é»æ“Šã€Œè¨‚é–±çˆ†å¯µã€ç¢ºèªä»˜æ¬¾</p>
            </div>

            <!-- QR Code -->
            <div class="text-center mb-6">
                <div class="inline-block p-4 bg-white rounded-2xl shadow-lg border-4 border-green-500">
                    <img src="https://www.genspark.ai/api/files/s/p1ymWhU0" 
                         alt="LINE QR Code" 
                         class="w-64 h-64"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5MSU5FIFFSIENvZGU8L3RleHQ+Cjwvc3ZnPg=='">
                </div>
                <p class="text-sm text-gray-600 mt-4 mb-2">
                    <i class="fas fa-mobile-alt mr-1"></i>ä½¿ç”¨ LINE æƒæ QR Code åŠ å…¥
                </p>
                <p class="text-base font-bold text-gray-900">
                    LINE ID: <span class="font-mono text-green-600">@902rkfzv</span>
                </p>
            </div>

            <!-- LINE åŠ å¥½å‹æŒ‰éˆ• -->
            <div class="text-center">
                <a href="javascript:void(0)" 
                   onclick="openLineAddFriend(event)"
                   class="inline-flex items-center bg-green-500 text-white px-8 py-4 rounded-full font-bold hover:bg-green-600 transition-colors shadow-lg cursor-pointer">
                    <i class="fab fa-line mr-3 text-2xl"></i>
                    åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ
                </a>
                <p class="text-xs text-gray-500 mt-3">
                    <i class="fas fa-mobile-alt mr-1"></i>
                    é»æ“Šå¾Œæœƒè‡ªå‹•é–‹å•Ÿ LINE App åŠ å…¥å¥½å‹
                </p>
            </div>
        </div>

        <!-- ç¢ºèªä»˜æ¬¾æŒ‰éˆ• -->
        <div class="bg-white rounded-2xl p-8 shadow-lg">
            <h2 class="text-2xl font-black text-gray-900 mb-4 text-center">ç¢ºèªä»˜æ¬¾</h2>
            <p class="text-gray-600 text-center mb-6">åŠ å…¥ LINE å¾Œï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç¢ºèªä»˜æ¬¾ä¸¦æä¾›éŠ€è¡Œå°¾è™Ÿ</p>
            
            <button onclick="openPaymentConfirmModal()" 
                    class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-lg text-lg font-black hover:from-green-600 hover:to-green-700 transition-all shadow-lg">
                <i class="fab fa-line mr-2"></i>
                è¨‚é–±çˆ†å¯µ - ç¢ºèªä»˜æ¬¾
            </button>

            <p class="text-center text-sm text-gray-500 mt-4">
                <i class="fas fa-info-circle mr-1"></i>
                è«‹æ–¼å®Œæˆè½‰å¸³å¾Œå†é»æ“Šç¢ºèª
            </p>
        </div>

        <!-- ä»˜æ¬¾èªªæ˜ -->
        <div class="bg-blue-50 rounded-lg p-6 mt-8 border border-blue-200">
            <h3 class="font-bold text-gray-900 mb-3 flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                ä»˜æ¬¾èªªæ˜
            </h3>
            <ul class="space-y-2 text-sm text-gray-700">
                <li>â€¢ è«‹æ–¼ <strong>2 åˆ†é˜</strong> å…§å®Œæˆè½‰å¸³ï¼Œé€¾æœŸè¨‚å–®å°‡è‡ªå‹•å–æ¶ˆ</li>
                <li>â€¢ è½‰å¸³å®Œæˆå¾Œï¼Œè«‹åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿä¸¦é»æ“Šã€Œè¨‚é–±çˆ†å¯µã€ç¢ºèªä»˜æ¬¾</li>
                <li>â€¢ ç¢ºèªä»˜æ¬¾æ™‚è«‹æä¾›éŠ€è¡Œå¸³è™Ÿå¾Œ <strong>5 ç¢¼</strong>ï¼Œä»¥ä¾¿æ ¸å°</li>
                <li>â€¢ ç¢ºèªä»˜æ¬¾å¾Œï¼Œæˆ‘å€‘æœƒåœ¨ <strong>2 åˆ†é˜å…§</strong> é€²è¡Œç¢ºèª</li>
                <li>â€¢ ç¢ºèªå®Œæˆå¾Œï¼Œè¨‚å–®ç‹€æ…‹å°‡æ›´æ–°ç‚ºã€Œå·²ä»˜æ¬¾ã€</li>
            </ul>
        </div>
    </div>

    <!-- ä»˜æ¬¾æˆåŠŸ Modal -->
    <div id="paymentSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 max-w-lg w-full shadow-2xl">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-green-600 text-4xl"></i>
                </div>
                <h3 class="text-2xl font-black text-gray-900 mb-2">ä»˜æ¬¾ç¢ºèªå·²æäº¤ï¼</h3>
            </div>

            <div class="space-y-4 mb-6">
                <p class="text-gray-700 text-center leading-relaxed">
                    æˆ‘å€‘æœƒå„˜é€Ÿç¢ºèªæ‚¨çš„ä»˜æ¬¾ã€‚<br>
                    ç¢ºèªå®Œæˆå¾Œï¼Œè¨‚å–®ç‹€æ…‹å°‡æ›´æ–°ç‚ºã€Œå·²ä»˜æ¬¾ã€ã€‚
                </p>
                
                <div class="bg-green-50 rounded-lg p-4 border-2 border-green-200">
                    <p class="text-sm text-gray-800 font-bold mb-3 flex items-center justify-center">
                        <i class="fab fa-line text-green-600 text-xl mr-2"></i>
                        è«‹åŠ å…¥æˆ‘å€‘çš„ LINE å®˜æ–¹å¸³è™Ÿ
                    </p>
                    <ul class="text-sm text-gray-700 space-y-2 mb-4 text-left">
                        <li class="flex items-start">
                            <span class="mr-2">âœ“</span>
                            <span>ç¢ºèªä»˜æ¬¾è³‡è¨Šä¸¦æä¾›éŠ€è¡Œå°¾è™Ÿ</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">âœ“</span>
                            <span>è¿½è¹¤è¨‚å–®ç‹€æ…‹</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">âœ“</span>
                            <span>æ¥æ”¶æœ€æ–°é€šçŸ¥</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">âœ“</span>
                            <span>èˆ‡æˆ‘å€‘ä¿æŒæºé€š</span>
                        </li>
                    </ul>
                    <div class="text-center">
                        <a href="javascript:void(0)" 
                           onclick="openLineAddFriend(event)"
                           class="inline-flex items-center bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition-colors">
                            <i class="fab fa-line mr-2 text-lg"></i>
                            ç«‹å³åŠ å…¥ LINE å¥½å‹
                        </a>
                    </div>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <p class="text-sm text-gray-700 text-center">
                        <strong class="text-gray-900">è¨‚å–®ç·¨è™Ÿï¼š</strong>
                        <span id="success-order-id" class="font-mono font-bold text-blue-700">-</span>
                    </p>
                    <p class="text-xs text-gray-600 text-center mt-2">
                        è«‹è¨˜ä¸‹è¨‚å–®ç·¨è™Ÿï¼Œæ–¹ä¾¿å¾ŒçºŒæŸ¥è©¢
                    </p>
                </div>
            </div>

            <div class="text-center">
                <button onclick="closePaymentSuccessModal()" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors">
                    ç¢ºèªï¼Œæ„Ÿè¬æ‚¨çš„è¨‚é–±ï¼
                </button>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªä»˜æ¬¾ Modal -->
    <div id="paymentConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-gray-900">ç¢ºèªä»˜æ¬¾</h3>
                <button onclick="closePaymentConfirmModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="paymentConfirmForm" onsubmit="return submitPaymentConfirmation(event)">
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-700">
                        éŠ€è¡Œå¸³è™Ÿå¾Œ 5 ç¢¼ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="accountLast5Digits" 
                           name="accountLast5Digits"
                           maxlength="5"
                           pattern="[0-9]{5}"
                           required
                           class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-xl font-mono text-center focus:border-green-500 focus:ring-2 focus:ring-green-200"
                           placeholder="00000">
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        è«‹è¼¸å…¥æ‚¨è½‰å¸³å¸³è™Ÿçš„å¾Œ 5 ç¢¼æ•¸å­—
                    </p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-700">
                        è½‰å¸³æ™‚é–“ <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" 
                           id="transferTime" 
                           name="transferTime"
                           required
                           class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-green-500 focus:ring-2 focus:ring-green-200">
                </div>

                <div class="mb-6">
                    <label class="flex items-start">
                        <input type="checkbox" 
                               name="confirmPayment" 
                               required
                               class="mt-1 mr-3 w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                        <span class="text-sm text-gray-700">
                            æˆ‘å·²ç¢ºèªå®Œæˆè½‰å¸³ï¼Œä¸¦å·²åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ
                        </span>
                    </label>
                </div>

                <div class="flex gap-4">
                    <button type="button" 
                            onclick="closePaymentConfirmModal()"
                            class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-300 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors">
                        <i class="fab fa-line mr-2"></i>
                        ç¢ºèªä»˜æ¬¾
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å¾ URL åƒæ•¸æˆ– localStorage ç²å–è¨‚å–®è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId') || sessionStorage.getItem('subscriptionOrderId') || 'SUB-' + Date.now();
        
        // å€’è¨ˆæ™‚åŠŸèƒ½ï¼ˆ2åˆ†é˜ï¼‰
        let timeLeft = 120; // 2åˆ†é˜ = 120ç§’
        const countdownElement = document.getElementById('countdown');
        
        function updateCountdown() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 30) {
                countdownElement.classList.add('pulsing');
                countdownElement.style.color = '#EF4444';
            }
            
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                alert('ä»˜æ¬¾æ™‚é–“å·²åˆ°æœŸï¼Œè¨‚å–®å·²è‡ªå‹•å–æ¶ˆã€‚');
                window.location.href = 'subscription-packages.html';
                return;
            }
            
            timeLeft--;
        }
        
        const countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
        
        // é–‹å•Ÿ LINE åŠ å¥½å‹ï¼ˆå„ªå…ˆä½¿ç”¨ Appï¼Œå¤±æ•—å‰‡ä½¿ç”¨ç¶²é ç‰ˆï¼‰
        function openLineAddFriend(event) {
            event.preventDefault();
            
            // LINE å®˜æ–¹å¸³è™Ÿ ID
            // æ³¨æ„ï¼šLINE ID æ ¼å¼æ‡‰è©²ä¸åŒ…å« @ ç¬¦è™Ÿï¼ˆåœ¨ URL ä¸­ï¼‰
            const lineId = '902rkfzv'; // ç§»é™¤ @ ç¬¦è™Ÿï¼ŒURL ä¸­ä¸éœ€è¦
            const lineAddFriendUrl = `https://line.me/R/ti/p/@${lineId}`;
            
            // LINE Deep Linkï¼ˆé©ç”¨æ–¼æ‰‹æ©Ÿ Appï¼‰
            // Deep Link æ ¼å¼ï¼šline://ti/p/{LINE_ID}ï¼ˆä¸éœ€è¦ @ ç¬¦è™Ÿï¼‰
            const lineDeepLink = `line://ti/p/${lineId}`;
            
            console.log('ğŸ“± æº–å‚™é–‹å•Ÿ LINE:', {
                lineId: lineId,
                webUrl: lineAddFriendUrl,
                deepLink: lineDeepLink
            });
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºè¡Œå‹•è£ç½®
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // è¡Œå‹•è£ç½®ï¼šå…ˆå˜—è©¦é–‹å•Ÿ LINE App
                let appOpened = false;
                
                // æ–¹æ³•ï¼šå‰µå»ºéš±è— iframe ä¾†å˜—è©¦é–‹å•Ÿ App
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.style.width = '1px';
                iframe.style.height = '1px';
                iframe.src = lineDeepLink;
                document.body.appendChild(iframe);
                
                // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼ˆå¦‚æœ App é–‹å•Ÿï¼Œé é¢æœƒéš±è—ï¼‰
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        appOpened = true;
                        document.body.removeChild(iframe);
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // å¦‚æœ 2 ç§’å¾Œ App æ²’æœ‰é–‹å•Ÿï¼Œå‰‡è·³è½‰åˆ°ç¶²é ç‰ˆ
                setTimeout(() => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    if (!appOpened && iframe.parentNode) {
                        document.body.removeChild(iframe);
                        console.log('âš ï¸ App æœªé–‹å•Ÿï¼Œè·³è½‰åˆ°ç¶²é ç‰ˆ');
                        window.location.href = lineAddFriendUrl;
                    }
                }, 2000);
            } else {
                // æ¡Œé¢ç‰ˆï¼šç›´æ¥é–‹å•Ÿç¶²é ç‰ˆï¼ˆåœ¨æ–°è¦–çª—ï¼‰
                console.log('ğŸ’» æ¡Œé¢ç‰ˆï¼šé–‹å•Ÿ LINE ç¶²é ç‰ˆ');
                window.open(lineAddFriendUrl, '_blank', 'noopener,noreferrer');
            }
        }
        
        // è¤‡è£½å¸³è™Ÿè³‡è¨Š
        function copyAccountInfo() {
            const accountInfo = '(822) 226540037896';
            navigator.clipboard.writeText(accountInfo).then(() => {
                alert('å¸³è™Ÿè³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(() => {
                // å‚™ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = accountInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('å¸³è™Ÿè³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }
        
        // æ‰“é–‹ç¢ºèªä»˜æ¬¾ Modal
        function openPaymentConfirmModal() {
            document.getElementById('paymentConfirmModal').classList.remove('hidden');
            // è‡ªå‹•å¡«å…¥ç•¶å‰æ™‚é–“
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('transferTime').value = localDateTime;
            document.getElementById('accountLast5Digits').focus();
        }
        
        // é—œé–‰ç¢ºèªä»˜æ¬¾ Modal
        function closePaymentConfirmModal() {
            const modal = document.getElementById('paymentConfirmModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            const form = document.getElementById('paymentConfirmForm');
            if (form) {
                form.reset();
                // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fab fa-line mr-2"></i>ç¢ºèªä»˜æ¬¾';
                }
            }
            
            // é‡ç½®æäº¤ç‹€æ…‹
            isSubmitting = false;
        }
        
        // é¡¯ç¤ºä»˜æ¬¾æˆåŠŸ Modal
        function showPaymentSuccessModal(orderId) {
            // é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿ
            const orderIdElement = document.getElementById('success-order-id');
            if (orderIdElement && orderId) {
                orderIdElement.textContent = orderId;
            }
            
            // é¡¯ç¤º Modal
            const modal = document.getElementById('paymentSuccessModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
            
            // æ¸…é™¤ sessionStorage ä¸­çš„è¨‚é–±è³‡æ–™
            sessionStorage.removeItem('pendingSubscriptionData');
            sessionStorage.removeItem('subscriptionOrderId');
        }
        
        // é—œé–‰ä»˜æ¬¾æˆåŠŸ Modal
        function closePaymentSuccessModal() {
            const modal = document.getElementById('paymentSuccessModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // å»¶é²è·³è½‰ï¼Œç¢ºä¿ Modal é—œé–‰å‹•ç•«å®Œæˆ
            setTimeout(() => {
                // å°å‘è¨‚å–®ç¢ºèªé é¢æˆ–è¿”å›é¦–é 
                const orderIdElement = document.getElementById('success-order-id');
                const orderId = orderIdElement?.textContent;
                
                if (orderId && orderId !== '-') {
                    window.location.href = `order-success.html?orderId=${orderId}&type=subscription`;
                } else {
                    window.location.href = 'index.html';
                }
            }, 300);
        }
        
        // é»æ“Š Modal èƒŒæ™¯é—œé–‰ï¼ˆå¯é¸ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            const successModal = document.getElementById('paymentSuccessModal');
            if (successModal) {
                successModal.addEventListener('click', (e) => {
                    // å¦‚æœé»æ“Šçš„æ˜¯èƒŒæ™¯ï¼ˆä¸æ˜¯ Modal å…§å®¹ï¼‰ï¼Œå‰‡é—œé–‰
                    if (e.target === successModal) {
                        closePaymentSuccessModal();
                    }
                });
            }
        });
        
        // é˜²æ­¢é‡è¤‡æäº¤çš„æ¨™è¨˜
        let isSubmitting = false;
        
        // æäº¤ä»˜æ¬¾ç¢ºèª
        function submitPaymentConfirmation(event) {
            event.preventDefault();
            
            // é˜²æ­¢é‡è¤‡æäº¤
            if (isSubmitting) {
                console.warn('âš ï¸ ä»˜æ¬¾ç¢ºèªæ­£åœ¨è™•ç†ä¸­ï¼Œè«‹å‹¿é‡è¤‡æäº¤');
                return false;
            }
            
            // ç¦ç”¨æäº¤æŒ‰éˆ•
            const submitButton = event.target.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'è™•ç†ä¸­...';
            }
            
            isSubmitting = true;
            
            try {
                const formData = new FormData(event.target);
                const accountLast5Digits = formData.get('accountLast5Digits');
                const transferTime = formData.get('transferTime');
                
                // ç²å–è¨‚å–®è³‡è¨Š
                const subscriptionData = JSON.parse(sessionStorage.getItem('pendingSubscriptionData') || '{}');
                
                // æ§‹å»ºä»˜æ¬¾ç¢ºèªè³‡æ–™
                const paymentConfirmation = {
                    orderId: orderId,
                    accountLast5Digits: accountLast5Digits,
                    transferTime: transferTime,
                    subscriptionData: subscriptionData,
                    confirmedAt: new Date().toISOString(),
                    status: 'pending_verification'
                };
                
                // å„²å­˜åˆ° localStorageï¼ˆå¾Œå°å¯ä»¥æŸ¥çœ‹ï¼‰
                const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
                pendingPayments.push(paymentConfirmation);
                localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
                
                // å„²å­˜åˆ°è¨‚å–®ä¸­
                const existingSubscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
                const subscriptionIndex = existingSubscriptions.findIndex(sub => sub.id === orderId || sub.orderId === orderId);
                if (subscriptionIndex !== -1) {
                    existingSubscriptions[subscriptionIndex].paymentConfirmation = paymentConfirmation;
                    existingSubscriptions[subscriptionIndex].status = 'pending_verification';
                    existingSubscriptions[subscriptionIndex].statusName = 'å¾…ç¢ºèª';
                    localStorage.setItem('subscriptions', JSON.stringify(existingSubscriptions));
                } else {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°è¨‚å–®:', orderId);
                }
                
                console.log('âœ… ä»˜æ¬¾ç¢ºèªå·²æäº¤:', paymentConfirmation);
                
                // é—œé–‰ç¢ºèªä»˜æ¬¾ Modal
                closePaymentConfirmModal();
                
                // æ¸…é™¤å€’è¨ˆæ™‚
                clearInterval(countdownInterval);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ Modal
                showPaymentSuccessModal(orderId);
                
            } catch (error) {
                console.error('æäº¤ä»˜æ¬¾ç¢ºèªå¤±æ•—:', error);
                alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                isSubmitting = false;
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fab fa-line mr-2"></i>ç¢ºèªä»˜æ¬¾';
                }
            }
            
            return false;
        }
        
        // é é¢è¼‰å…¥æ™‚ä¿å­˜è¨‚å–®è³‡è¨Š
        window.addEventListener('DOMContentLoaded', () => {
            // å¾ sessionStorage ç²å–è¨‚é–±è³‡æ–™
            const subscriptionData = JSON.parse(sessionStorage.getItem('pendingSubscriptionData') || '{}');
            if (Object.keys(subscriptionData).length > 0) {
                console.log('ğŸ“¦ è¨‚å–®è³‡è¨Šå·²è¼‰å…¥:', subscriptionData);
            }
        });
    </script>
</body>
</html>

